<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PET-Infection Treatment Eligibility Form (v1.0)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation/></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Section-2: Confirming Eligibility for Infection Treatment ">

		<div>
		
		<div id="pregnancy_history_div">
			<p>
				Pregnancy History - Suggestive of pregnancy
				<br/>
				<obs conceptId="5272" id="pregnancy_history" answerConceptIds="1065,1066">
							   <controls>
									  <when value="1065" thenDisplay="#suggestive"/>
									  </controls>
				</obs>
			</p>
		</div>
		
		<p id="suggestive">
			Pregnancy test result
			<br/>
			<obs conceptId="164133" id="pregnancy_test_result" answerConceptIds="129229,151259,164132" answerLabels="Positive,Negative,Undetermined"/>
		</p>
		
	        <p id = "type_of_disease">
			Type of evaluation for disease
			<br/>
			<obsgroup groupingConceptId="164136" required="true">
			<obs id="type_of_disease_1" conceptId="164136" answerConceptId="164134" style="checkbox"/>
			<br/>
			<obs conceptId="164136" answerConceptId="164135" style="checkbox"/>
			</obsgroup>
		</p>

		<p>
			Has TB disease been diagnosed
			<br/>
			<obs conceptId="164137" id="tb_diagnosis" required="true" >
			</obs>
		</p>
		
	<div id="diagnosed">
		<p>
			Type of TB diagnosed
			<br/>
			<obs conceptId="164091" id="tb_infection_type" answerConceptIds="160248,160247" /> <label style="color:red">*</label>
		</p>
		
		<p>
			Has the patient been referred for TB treatment? 
			<br/>
			<obs conceptId="1648" id="referral"  /> <label  style="color:red">*</label>
		</p>
			<p id="sample_site_div">Name of the referral Site
				<br/>
                                  <select id="facility_list">			   
				             </select>  <label style="color:red">*</label>
				<obs conceptId="161550" id="sample_site" />
		   </p>
		<p id="other_site">
			Others specify
			<br/>
			<obs conceptId="161550" id="referral_site"/> <label style="color:red">*</label>
		</p>
	</div>
	
		<p id="NotDiagnosed">
			Has TB disease been ruled out? 
			<br/>
			<obs conceptId="164227" id="tb_ruled_out" answerConceptIds="1065,1066" /> <label style="color:red">*</label>
		</p>
				
                <p>
			Eligible for PET
			<br/>
			<obs conceptId="164228" id="pet_eligible" />
		</p>

		<p id="pet_consent_complete">
			Does the contact agree to take PET?
			<br/>
			<obs conceptId="164229" id="pet_consent" required="false" /> <label style="color:red">*</label>
		</p>
		
		
		<p>
			Clinician's notes			<br/>
			<obs conceptId="164237" id="clinical_notes" required="false"/>
		</p>

           
		</div>
	</section>

	<submit/>


    <script type="text/javascript">


function doRest(){
			jQuery.ajax({
				url: "/openmrs/ws/rest/v1/location?v=custom:(uuid,display,name,description)&amp;tag=PET",
				dataType: 'json'
				}).done(function(data ) {
					console.log(data.results[0].name);
					console.log(data.results.length);
					locationData = data;
					populate(data);
			});
		}
		
		function populate(data) {
								
			var s= document.getElementById('facility_list');
			
			for (i = 0; i &lt; data.results.length; i++) { 
				s.options[i+1]= new Option(data.results[i].description, data.results[i].name);                      
				var resultObject =  JSON.parse(JSON.stringify(data.results[i].description || null));
			}
		}




if (jQuery) {

            $j(document).ready(function () {
						   $j('#pet_consent_complete').hide();
						   setValue('pet_eligible.value',1066);
						   getField("sample_site.value").prop('disabled',true);
							doRest();



            });

        }

		
		
		
        jQuery(window).bind("load", function() {
       
           

<ifMode mode="ENTER">
 $j("#NotDiagnosed").hide();
                 $j("#diagnosed").hide();
</ifMode>

        });

	var patientage= <lookup expression="patient.age"/>
            if(patientage &lt; 14){
                         $j('#pregnancy_history_div').hide();
          }
                    else{
			 $j('#pregnancy_history_div').show();
		}
var startDate = new Date();
          jQuery(function() {
		   <ifMode mode="VIEW" include="false">
		getField('tb_ruled_out.value').change(function() {
                        if(getValue('tb_ruled_out.value') == 1065){
                               setValue('pet_eligible.value',1065);
							   $j('#pet_consent_complete').show();

                        }
						else{
							setValue('pet_eligible.value',1066);
						   $j('#pet_consent_complete').hide();
setValue('pet_consent.value','')
						}
                });
		</ifMode>

				
		 var facilities = document.getElementById("facility_list");
        facilities.onchange = function(){
                var e = document.getElementById("facility_list");
				var locationDescription = e.options[e.selectedIndex].text;
                                var locationName = e.options[e.selectedIndex].value;
			
				setValue('sample_site.value',locationName );

                               if(locationName == 'OTHER')
                                        $j('#other_site').show();
                               else
$j('#other_site').hide();

                getField('sample_site.value').change();
										
		};		
				
				
		getField('pet_eligible.value').change(function() {
                if(getValue('tb_ruled_out.value') == 1065){
                        setValue('pet_eligible.value',1065);
                }
				else{
							setValue('pet_eligible.value',1066);
							
				}
                });

getField('tb_diagnosis.value').change(function() {
                if(getValue('tb_diagnosis.value') == 1065){
                         $j('#diagnosed').show();
                         $j('#NotDiagnosed').hide();

                               if(getValue('sample_site.value') == 'OTHER')
                                        $j('#other_site').show();
                               else
                                     $j('#other_site').hide();
setValue('tb_ruled_out.value','');
                }
				else  if(getValue('tb_diagnosis.value') == 1066){
							$j('#diagnosed').hide();
                                                       $j('#NotDiagnosed').show();
setValue('tb_infection_type.value','');
setValue('referral.value','');
document.getElementById("facility_list").value = '';
setValue('sample_site.value','');
setValue('referral_site.value','');	
				}  else {
$j('#diagnosed').hide();
 $j('#NotDiagnosed').hide();
}
                });


            });
            beforeSubmit.push(function() {
                var error1=true,error2=true,error3=true,error4=true,error5=true,error0=true,error6=true,error7=true,error8=true,error9=true,error10=true;
                setValue('tb_infection_type.error', '');
				setValue('referral.error', '');
				setValue('tb_ruled_out.error', '');
				setValue('pregnancy_history.error', '');
				setValue('referral_site.error', '');
				setValue('sample_site.error', '');
				setValue('pet_consent.error', '');
				setValue('pregnancy_test_result.error', '');




				
				if(getValue('tb_diagnosis.value')==1065 &amp;&amp; getValue('tb_infection_type.value')==''){
							  getField('tb_infection_type.error').html('This field can not be null').show();
							  error1=false;
				}
				else{
					getField('tb_infection_type.error').html('').hide();
					error1=true;
				}
				
				if(getValue('tb_diagnosis.value')==1065 &amp;&amp; getValue('referral.value')==''){
					getField('referral.error').html('This field can not be null').show();
					error2=false;
				}
				else{
					getField('referral.error').html('').hide();
					error2=true;
				}
				if(getValue('tb_diagnosis.value')==1066 &amp;&amp; getValue('tb_ruled_out.value')==''){
					getField('tb_ruled_out.error').html('This field can not be null').show();
					error3=false;
				}
				else{
					getField('tb_ruled_out.error').html('').hide();
					error3=true;
				}
				
				
				if(getValue('tb_ruled_out.value')==1065 &amp;&amp; getValue('pet_consent.value')==''){
					getField('pet_consent.error').html('This field can not be null').show();
					error10=false;
				}
				else{
					getField('pet_consent.error').html('').hide();
					error10=true;
				}
				
				
				if(getValue('tb_diagnosis.value')==''){
					getField('tb_diagnosis.error').html('This field can not be null').show();
					error8=false;
				}
				else{
					getField('tb_diagnosis.error').html('').hide();
					error8=true;
				}
				
				if(getValue('tb_diagnosis.value')==1065 &amp;&amp; getValue('sample_site.value')==''){
					getField('sample_site.error').html('This field can not be null').show();
					error7=false;
				}
				else{
					getField('sample_site.error').html('').hide();
					error7=true;
				}
				if(patientage &gt; 14 &amp;&amp; getValue('pregnancy_history.value')==''){
					getField('pregnancy_history.error').html('This field can not be null').show();
					error4=false;
				}
				else{
					getField('pregnancy_history.error').html('').hide();
					error4=true;
				}
				
				if(getValue('pregnancy_history.value')=='1065' &amp;&amp; getValue('pregnancy_test_result.value')==''){
					getField('pregnancy_test_result.error').html('This field can not be null').show();
					error9=false;
				}
				else{
					getField('pregnancy_test_result.error').html('').hide();
					error9=true;
				}
				
				if(getValue('tb_diagnosis.value')==1065 &amp;&amp; getValue('referral_site.value')==''){
					getField('referral_site.error').html('This field can not be null').show();
					error5=false;
				}
				else{
					getField('referral_site.error').html('').hide();
					error5=true;
				}
				var isCheck=true;
				jQuery('#type_of_disease input[type=checkbox]').on('change', function () {
                var len = jQuery('#type_of_disease input[type=checkbox]:checked').length;
                if (len > 0) {
                    isCheck = false;
                 }
                 else {
				    isCheck = true;
                 } 				 
                }).trigger('change');
			
			if(isCheck == true ) {
			   getField('type_of_disease_1.error').html('Please select a value.').show();
			   valid=false;
			}
			else {
			   getField('type_of_disease_1.error').html('').hide();
			}
			
				if(error9==false || error1== false || error2==false || error3==false || error4==false || error5==false || error0==false || error7==false || error8==false){
					return false;
				}
				else{
					var endDate = new Date();
					var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
					var diffSec = timeDiff/1000;
					alert(diffSec + " seconds to fill form");
					return true;
				}
             });
    </script>

</htmlform>