<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PET-Baseline Screening(v0.2.0-beta)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="1"/></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Baseline Screening Information ">
	
		<div>
		  <p>
				Index Patient ID
                                <br/>
				<obs conceptId="163755" id="index_case_id" size="7" required="true"/>
			</p>
			
                       <p>
				Is the contact currently taking TB treatment?
                                <br/>
				<obs conceptId="5965" id="tb_treatment_status" answerConceptIds="1065,1066"  required="true" />
			</p>

                        <p>
				Has the contact taken TB treatment in past?
                                <br/>
				<obs conceptId="1389" id="tb_history" answerConceptIds="1065,1066"/>
			</p>


                         <p>
				"Relation with Index patient.
                                <br/>
                                E.g. 'Mother' means Index is Mother of Contact"
                                <br/>
				<obs conceptId="1560" id="relationship" answerConceptIds="970,971,160723,160724,160726,160725,160729,160730,160727,160728,5617,975,974,5620"  required="true">
                         <controls>
                                <when value="5620" thenDisplay="#other_relation"/>
                          </controls>
				</obs>
			</p>


                        <p id="other_relation">
				Other Relation
                                <br/>
				<obs conceptId="5620" id="other_relationship" maxlength="15" />
			</p>

                        <p>
				CNIC
                                <br/>
				<obs conceptId="163084" id="cnic" required="true" maxlength="15" />
			</p>


                       <p>
				Whose CNIC is this?
                                <br/>
				<obs conceptId="164107" id="cnic_owner" answerConceptIds="978,970,971,160723,160724,160726,160725,160729,160730,160727,160728,5617,975,974,164110">
                          <controls>
                                <when value="164110" thenDisplay="#other_cnic"/>
                          </controls>
				</obs>
			</p>

                        <p id="other_cnic">
 				Other
                                <br/>
				<obs conceptId="164110" id="other_cnic_owner" maxlength="20"/>
			</p>

		</div>
	</section>

        <section headerLabel="3. Contact Verbal Symptom Screening">
		<div>
		  
                        <p>
 				Does contact have cough?
                                <br/>
				<obs conceptId="143264" id="cough"  required="true" >
                                <controls>
                                <when value="1065" thenDisplay="#duration"/>
                          </controls>
				</obs>
			</p>
             
            <div  id="duration">
                <p>
					Cough duration
                    <br/>
					<obs conceptId="5959" id="cough_duration" answerConceptIds="163739,159799,1487,1067,164106" />
				</p>

                <p>
					Haemoptysis
                    <br/>
					<obs conceptId="138905" id="haemoptysis"/>
				</p>
            </div>
            
			<p>
 				Does contact have fever?
                <br/>
				<obs conceptId="140238" id="fever"  required="true" />
			</p>

            <p>
 				Does contact have weight loss or failure to thrive?
                <br/>
				<obs conceptId="832" id="weight_loss"  required="true" />
			</p>

            <p>
  				Reduced appetite
                <br/>
				<obs conceptId="135595" id="reduced_appetite"  required="true" />
			</p>

            <p>
  				Does contact have reduced activity?
                <br/>
				<obs conceptId="152313" id="reduced_activity"  required="true" />
			</p>

            <p>
  				Does contact have night sweats?
                <br/>
				<obs conceptId="133027" id="night_sweats"  required="true" />
			</p>

            <p>
  				Does the contact have glandular swelling anywhere in body?
                <br/>
				<obs conceptId="163894" id="swelling"  required="true" />
			</p>
			
			<div id="pregnancy_history_div">
			<p> 
				Is the patient pregnant?
				<br/>
				<obs conceptId="5272" id="pregnancy_history" answerConceptIds="1065,1066">
					
				</obs>
			</p>
		</div>

		</div>
	</section>

	<submit/>

    <script type="text/javascript">
	
	var patientgender='<lookup expression="patient.gender"/>'
    if(patientgender == "famale" || patientgender == "F"){
		$j('#pregnancy_history_div').show();
	}else{
		$j('#pregnancy_history_div').hide();
	}
	
        var startDate = new Date();
		var patientId =  '<lookup expression="patient.getPatientIdentifier(3)"/>';
		 jQuery(function() {
				getField('cnic.value').change(function() {
					if(getValue('cnic.length')==15){
							getField('cnic.error').html('Invalid value of CNIC. Enter in valid format').show();
					}
					else{
						getField('cnic.error').html('').hide();
					}
				});
					
        });
		
		function luhnCheckDigit(number) {
			
			var validChars = "0123456789ABCDEFGHIJKLMNOPQRSTUVYWXZ_";
			number = number.toUpperCase().trim();
			var sum = 0;
			for (var i = 0; i &lt; number.length; i++) 
			{
				var ch = number.charAt(number.length - i - 1);
				if (validChars.indexOf(ch) &lt; 0) {
					return -1;
				}
				var digit = ch.charCodeAt(0) - 48;
				var weight;
				if (i % 2 == 0) {
					weight = (2 * digit) - parseInt(digit / 5) * 9;
				}
				else {
					weight = digit;
				}
				sum += weight;
			}
			sum = Math.abs(sum) + 10;
			var digit = (10 - (sum % 10)) % 10;
			return digit;
		}
		
		beforeSubmit.push(function() {
			var indexCaseId = getValue('index_case_id.value');
            
			var valid=true;
			setValue('index_case_id.error', '');
			setValue('cnic.error', '');
            setValue('other_relationship.error','');
			setValue('other_cnic_owner.error','');
			setValue('cough_duration.error','');
			setValue('haemoptysis.error','');			
			
            myRegExp = new RegExp(/\d{5}-\d{7}-\d/);
			myRegExp2 = new RegExp(/[A-Z0-9]{5,5}-[0-9]/);
 
               
            if(!myRegExp.test(getValue('cnic.value'))) { 
				getField('cnic.error').html('Invalid CNIC. Please enter CNIC in following format: xxxxx-xxxxxxx-x').show();
                valid=false;
            }
            else{
                getField('cnic.error').html('').hide();
            }
            if(getValue('relationship.value')==5620 &amp;&amp; getValue('other_relationship.value')==''){
                getField('other_relationship.error').html('This field can not be empty').show();
                valid=false;                
            }
            else{
                getField('other_relationship.error').html('').hide();
            }
			if(getValue('cnic_owner.value')==164110 &amp;&amp; getValue('other_cnic_owner.value')==''){
                getField('other_cnic_owner.error').html('This field can not be empty').show();
                valid=false;                
            }
            else{
                getField('other_cnic_owner.error').html('').hide();
            }
			if(getValue('cough.value')==1065 &amp;&amp; getValue('cough_duration.value')==''){
                getField('cough_duration.error').html('This field can not be empty').show();
                valid=false;                
            }
            else{
                getField('cough_duration.error').html('').hide();            
			}
			if(getValue('cough.value')==1065 &amp;&amp; getValue('haemoptysis.value')==''){
                getField('haemoptysis.error').html('This field can not be empty').show();
                valid=false;                
            }
            else{
                getField('haemoptysis.error').html('').hide();
            }
			if(!myRegExp2.test(getValue('index_case_id.value'))) {
				getField('index_case_id.error').html('Incorrect format! Please enter Index case id in format: xxxxx-x').show();
                valid=false;
            }
            else{
                getField('index_case_id.error').html('').hide();
            }
			if(valid==true &amp;&amp; indexCaseId != "") {
				
					// Check Luhn digit for barcode
				var number = indexCaseId.substring(0, indexCaseId.length - 2);
				var digit = indexCaseId.charAt(indexCaseId.length - 1);
				var luhnDigit = luhnCheckDigit(number);
				if (digit != luhnDigit) {
									valid = false; 
                                        alert('invalid luhn');
					getField('index_case_id.error').html('Index Case ID is invalid. Please recheck the index case ID').show();

				}
				else {
					alert('valid luhn digit');
					getField('index_case_id.error').html('').hide();
				}
				
			}
			if(valid==true &amp;&amp; indexCaseId != "") {
				if(patientId==indexCaseId) { 
					valid = false;
					getField('index_case_id.error').html('Patient ID and Index Case ID must not match! Please recheck the index case ID').show();
				}
				else {
					getField('index_case_id.error').html('').hide();
				}
			}
			
			if((patientgender == "famale" || patientgender == "F") &amp;&amp; getValue('pregnancy_history.value')==''){
				getField('pregnancy_history.error').html('This field can not be null').show();
				valid=false;
			}
			else{
				getField('pregnancy_history.error').html('').hide();
			}

            if(valid == false){
				return false;
            }
            else{
				var endDate = new Date();
                var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
				var diffSec = timeDiff/1000;
				alert(diffSec + " seconds to fill form");
                return true;
            } 
			 
		});
    </script>

</htmlform>