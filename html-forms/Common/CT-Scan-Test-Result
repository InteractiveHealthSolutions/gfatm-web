<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>Childhood TB-CT Scan Test Result (v1.0.0)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"  id="encounter_date"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="2"  /></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. CT Scan Result">
        <div>

<p>
				Order ID 
				<br/>
				<select id="orderids"></select>
				<obs id="order_id" conceptId="165715" required="false" size="15" />
			</p>

             <p>
				Test ID
				<br/>
				<obs conceptId="164350" id="test_id" maxlength="20" />
			</p>

		<div id="div1">
			<div id="chest_div">
				
				<p> 
					CT chest interpretation
					<br/>
					<obs conceptId="164847" answerConceptIds="164128,164130,1115" answerLabels="Suggestive of TB,Not suggestive of TB,Normal" id="ct_chest_interpretation" />
				</p>
				
				<p id="ct_chest_suggestive_tb_div"> 
					CT chest suggestive of TB
					<br/>
					<obs conceptId="164846" answerConceptIds="164112,114108,115753,164845" answerLabels="Adenopathy,Pleural Effusion,Miliary,Consolidation" id="ct_chest_suggestive_tb" defaultValue="164112"/>
				</p>
				
			</div>
			

			<div id="abdomen_div">
				
				<p> 
					CT abdomen interpretation
					<br/>
					<obs conceptId="164849" answerConceptIds="164128,164130,1115" answerLabels="Suggestive of TB,Not suggestive of TB,Normal" id="ct_abdomen_interpretation" />
				</p>
				
				<p id="ct_abdomen_suggestive_tb_div"> 
					CT abdomen suggestive of TB
					<br/>
					<obs conceptId="164848" answerConceptIds="164112,136684,148346" answerLabels="Adenopathy,Intestinal wall thickening,Ascites" id="ct_abdomen_suggestive_tb" defaultValue="164112" />
				</p>
				
			</div>
			
			<div id="brain_div">
				
				<p> 
					CT brain interpretation
					<br/>
					<obs conceptId="164855" answerConceptIds="164128,164130,1115" answerLabels="Suggestive of TB,Not suggestive of TB,Normal" id="ct_brain_interpretation"/>
				</p>
				
				<p id="ct_brain_suggestive_tb_div"> 
					CT brain suggestive of TB
					<br/>
					<obs conceptId="164853" answerConceptIds="160424,111896" answerLabels="Meningeal enhancement,Tuberculomas" id="ct_brain_suggestive_tb"/>
				</p>
			</div>
			
			
			<div id="bone_div">
				<p> 
					CT bone suggestive of TB
					<br/>
					<obs conceptId="165137" answerConceptIds="164128,164130,1115" answerLabels="Suggestive of TB,Not suggestive of TB,Normal" id="ct_bone_interpretation"/>
				</p>
			</div>
			
			<div id="spine_div">
				<p> 
					CT spine suggestive of TB
					<br/>
					<obs conceptId="165138" answerConceptIds="164128,164130,1115" answerLabels="Suggestive of TB,Not suggestive of TB,Normal" id="ct_spine_interpretation"/>
				</p>
			</div>
		</div>
			
			<p>
				CT Scan Outcome
				<br/>
				<obs conceptId="165733" answerConceptIds="164128,164130" answerLabels="Suggestive of TB,Not suggestive of TB" id="ct_scan_outcome"/>
			</p>
			
		
			
        
		</div>
	</section>

	<submit/>


<script type="text/javascript">

	var ctScan="";
	var startDate = new Date();
	
	var encounters = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('6d320b27-1db2-431c-a728-e2a274146144'))  $fn.getObs($encounter, '165715').getValueAsString($!{locale}) #end"/>";
	var result = encounters.replace(/\s\s+/g, '@');
    var resultValueArray = result.split('@');
	
	
	var encounters1 = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('6d320b27-1db2-431c-a728-e2a274146144'))  $fn.getObs($encounter, '164864').valueCoded.name #end"/>";
	var result1 = encounters1.replace(/\s\s+/g, '@');
    var ctResultArray = result1.split('@');
	var i=0;
	
   
	$j('#chest_div').hide();
	$j('#abdomen_div').hide();
	$j('#brain_div').hide();
	$j('#bone_div').hide();
	$j('#spine_div').hide();
	
	 jQuery(function() {
	 
		 getField("order_id.value").prop('disabled',true);
			
			var orders = document.getElementById("orderids");
				orders.onchange = function(){
					var e = document.getElementById("orderids");
					var orderID = e.options[e.selectedIndex].text;
					
					setValue('order_id.value',orderID);	
					
					for(i=0; i &lt; resultValueArray.length; i++){
						if(resultValueArray[i].includes(orderID)){
								ctScan = ctResultArray[i];
								
								if(ctScan.includes("CT SCAN, CHEST")){
									$j('#chest_div').show();
									
									if(getValue('ct_chest_interpretation.value')==164128){
										$j('#ct_chest_suggestive_tb_div').show();
									} else {
										$j('#ct_chest_suggestive_tb_div').hide();
									}
										
									$j('#abdomen_div').hide();
									$j('#bone_div').hide();
									$j('#spine_div').hide();
									$j('#brain_div').hide();
									}else if(ctScan.includes("COMPUTED TOMOGRAPHY OF ABDOMEN WITH CONTRAST")){
									$j('#abdomen_div').show();
									
									if(getValue('ct_abdomen_interpretation.value')==164128){
										$j('#ct_abdomen_suggestive_tb_div').show();
									} else {
										$j('#ct_abdomen_suggestive_tb_div').hide();
									}
										
									$j('#chest_div').hide();
									$j('#bone_div').hide();
									$j('#spine_div').hide();
									$j('#brain_div').hide();
								}else if(ctScan.includes("BONE SCAN")){
									$j('#bone_div').show();
										
									$j('#chest_div').hide();
									$j('#abdomen_div').hide();
									$j('#spine_div').hide();
									$j('#brain_div').hide();
								}else if(ctScan.includes("SPINE CT SCAN")){
									$j('#spine_div').show();
										
									$j('#chest_div').hide();
									$j('#abdomen_div').hide();
									$j('#bone_div').hide();
									$j('#brain_div').hide();
								}else if(ctScan.includes("BRAIN CT SCAN")){
									$j('#brain_div').show();
									
									if(getValue('ct_brain_interpretation.value')==164128){
										$j('#ct_brain_suggestive_tb_div').show();
									}else{	
										$j('#ct_brain_suggestive_tb_div').hide();
									}
										
									$j('#chest_div').hide();
									$j('#abdomen_div').hide();
									$j('#bone_div').hide();$j('#spine_div').hide();
								}else{
									
									
									
									$j('#chest_div').hide();
									$j('#abdomen_div').hide();
									$j('#bone_div').hide();
									$j('#spine_div').hide();
									$j('#brain_div').hide();
								}
						}
						
						
					}
			}
		
		getField('ct_chest_interpretation.value').change(function() {
			if(getValue('ct_chest_interpretation.value')==164128){
				setValue('ct_scan_outcome.value', 164128);
				setValue('ct_chest_suggestive_tb.value', 164112);
				$j('#ct_chest_suggestive_tb_div').show();
			}else{
				setValue('ct_scan_outcome.value', 164130);
				setValue('ct_chest_suggestive_tb.value', '');
				$j('#ct_chest_suggestive_tb_div').hide();
			}
		});			
		
		
		getField('ct_abdomen_interpretation.value').change(function() {
			if(getValue('ct_abdomen_interpretation.value')==164128){
				setValue('ct_scan_outcome.value',164128);
				setValue('ct_abdomen_suggestive_tb.value', 164112);
				$j('#ct_abdomen_suggestive_tb_div').show();
			}else{
				setValue('ct_scan_outcome.value', 164130);
				setValue('ct_abdomen_suggestive_tb.value', '');
				$j('#ct_abdomen_suggestive_tb_div').hide();
			}
		});
		
		getField('ct_brain_interpretation.value').change(function() {
			if(getValue('ct_brain_interpretation.value')==164128){
				setValue('ct_scan_outcome.value', 164128);
				$j('#ct_brain_suggestive_tb_div').show();
			}else{
				setValue('ct_scan_outcome.value', 164130);
				setValue('ct_brain_suggestive_tb.value', '');
				$j('#ct_brain_suggestive_tb_div').hide();
			}
		});
		
		getField('ct_bone_interpretation.value').change(function() {
			if(getValue('ct_bone_interpretation.value')==164128){
				setValue('ct_scan_outcome.value', 164128);
			}else{
				setValue('ct_scan_outcome.value', 164130);
			}
		});
		
		getField('ct_spine_interpretation.value').change(function() {
			if(getValue('ct_spine_interpretation.value')==164128){
				setValue('ct_scan_outcome.value', 164128);
			}else{
				setValue('ct_scan_outcome.value', 164130);
			}
		});
		
	});


	
	
	var check=true;
	var orders = document.getElementById('orderids');
	orders.remove(0);
	if(resultValueArray.length==1){
		check=false;
	}else{
		for (i = 0; i &lt; resultValueArray.length; i++) {
			if(resultValueArray[i].length &gt; 0){
				orders.options[i]= new Option(resultValueArray[i]);
			}
		}
	}
	

	beforeSubmit.push(function() {
			var error=true;
			if(getValue('order_id.value')==''){                    	
            getField('order_id.error').html('Order ID can not be null').show();
			error=false;
		}
		else{     
			getField('order_id.error').html('').hide();
		}
			<ifMode mode="ENTER">	
			var OrderIdEncounters = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('a9c69289-20c1-4cbe-8f43-faf90c4a44d9'))  $fn.getObs($encounter, '165715').getValueAsString($!{locale}) #end"/>";
            var OrderIdResult = OrderIdEncounters.replace(/\s\s+/g, '@');
            var OrderIdResultValueArray = OrderIdResult.split('@');
			if(getValue('order_id.value')!=''){
			 for(var j = OrderIdResultValueArray.length-1; 0 &lt;= j; j--){
                if((OrderIdResultValueArray[j]).trim() == (getValue('order_id.value')).trim()){                //if both ids match use 'j' index to retrieve last food intake value                      
                    getField('order_id.error').html('Result for this Order ID already submitted.').show();
					error = false;
                    break;
                }
                else {
                     getField('order_id.error').html('').hide();
                }
			 }
			}
			
			
				//Code for Checking if Test ID already exists.
				myRegExp = new RegExp(/^[a-zA-Z0-9-,.'"()#&amp;:;,'"+%$*=!| \\/]{1,20}$/);
				
				var encounters = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('a9c69289-20c1-4cbe-8f43-faf90c4a44d9'))  $fn.getObs($encounter, '164350').getValueAsString($!{locale}) #end"/>";
		  
				var result = encounters.replace(/\s\s+/g, '@');
				var resultValueArray = result.split('@');

				if(getValue('test_id.value')!=''){
					if(!myRegExp.test(getValue('test_id.value'))) {
						 
						getField('test_id.error').html('Not a valid ID.').show();
						error=false;
					}
					else if(getValue('test_id.value').length > 0 &amp;&amp; getValue('test_id.value').trim() ==''){
						  getField('test_id.error').html('Invalid Test ID.').show();
						  error=false;
					}
					else{
						getField('test_id.error').html('').hide();

						for(var j = resultValueArray.length-1; 0 &lt;= j; j--){
						if((resultValueArray[j]).trim() == (getValue('test_id.value')).trim()){                //if both ids match use 'j' index to retrieve last food intake value                      
						error =false;
									
							getField('test_id.error').html('Test ID already exists.').show();
									break;
								}
						else {
							 getField('test_id.error').html('').hide();
						}       
						}						
					}
				}
			
			</ifMode>
		
		
        if(check==false){
            alert('Can not be Submit. No test order form found');
            error=false;
        } else {
		
			getField('ct_chest_interpretation.error').html('').hide();
			getField('ct_chest_suggestive_tb.error').html('').hide();
			getField('ct_abdomen_interpretation.error').html('').hide();
			getField('ct_abdomen_suggestive_tb.error').html('').hide();
			getField('ct_brain_interpretation.error').html('').hide();
			getField('ct_brain_suggestive_tb.error').html('').hide();
			getField('ct_bone_interpretation.error').html('').hide();
			getField('ct_spine_interpretation.error').html('').hide();

			if(ctScan.includes("CT SCAN, CHEST")){
			
				 if(getValue('ct_chest_interpretation.value')==''){
					getField('ct_chest_interpretation.error').html('Required field').show();
					error=false;                
				}
				else if(getValue('ct_chest_interpretation.value')=='164128' &amp;&amp; getValue('ct_chest_suggestive_tb.value')==''){
					getField('ct_chest_suggestive_tb.error').html('Required field').show();
					error=false; 
				} 
				
			}else if(ctScan.includes("COMPUTED TOMOGRAPHY OF ABDOMEN WITH CONTRAST")){
			
				if(getValue('ct_abdomen_interpretation.value')==''){
					getField('ct_abdomen_interpretation.error').html('Required field').show();
					error=false;                
				}
				else if(getValue('ct_abdomen_interpretation.value')=='164128' &amp;&amp; getValue('ct_abdomen_suggestive_tb.value')==''){
					getField('ct_chest_suggestive_tb.error').html('Required field').show();
					error=false; 
				} 
				
			}else if(ctScan.includes("BONE SCAN")){
			
				 if(getValue('ct_bone_interpretation.value')==''){
					getField('ct_bone_interpretation.error').html('Required field').show();
					error=false;                
				}
				
			}else if(ctScan.includes("SPINE CT SCAN")){
			
				if(getValue('ct_spine_interpretation.value')==''){
					getField('ct_spine_interpretation.error').html('Required field').show();
					error=false;                
				}
				
			}else if(ctScan.includes("BRAIN CT SCAN")){
				
				if(getValue('ct_brain_interpretation.value')==''){
					getField('ct_brain_interpretation.error').html('Required field').show();
					error=false;                
				}
				else if(getValue('ct_brain_interpretation.value')=='164128' &amp;&amp; getValue('ct_brain_suggestive_tb.value')==''){
					getField('ct_brain_suggestive_tb.error').html('Required field').show();
					error=false; 
				} 
			}
		
		}
		

	if(error==false){
				return false;
			}
			else{
			  getField("order_id.value").prop('disabled',false);
				var endDate = new Date();
				var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
				var diffSec = timeDiff/1000;
				alert(diffSec + " seconds to fill form");
				return true;
			}
	});

</script>

</htmlform>