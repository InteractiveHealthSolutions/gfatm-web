<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>Missed Visit Followup (v1.0.0)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="2"  /></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2.Missed Visit Information">
		<div>
			<p>
 				Date of missed visit?
                <br/>
				<obs conceptId="164474" id="missed_visit_date"  required="true" allowFutureDates="true" />
			</p>
			
			<p>
 				Missed Assessment
                <br/>
				<obs conceptId="165803" id="missed_assessment" answerConceptIds="165806,165804,165805,165040,165039,164647,165042,165036,166223,166224" answerLabels="TB Treatment Follow-up,Antibiotic Trial Follow-up,IPT Follow-up,Planned Monthly Assessmenthly,Two-week Assessment,Treatment Initiation,Post Treatment Assessment,Other Assessment,Clinician Followup,Baseline Clinician Evaluation Visit" required="true" />
			</p>
			
			<p>
				Have you been able to contact the patient?
				<br/>
				<obs conceptId="164468" id="patient_contacted" answerConceptIds="1065,1066,165784,160034" answerLabels="Yes,No,Yes; but not interested, Patient Died">
				<controls>
						<when value="1066" thenDisplay="#unable_contact_div,#return_div"/>
						<when value="1065" thenDisplay="#reason_missed_div"/>
					</controls>
				</obs>		
			</p>
			
			<div id="not_interested_div">
				<div id="unable_contact_div">
					<p>
						If no, why were you unable to contact the patient?
						<br/>
						<obs conceptId="164469" id="reason_patient_not_contacted" answerLabels="Phone switched off,Patient not responding,Invalid / incorrect contact number,Wrong number,Other" answerConceptIds="164470,164471,164472,166045,164473">
						<controls>
							<when value="164473" thenDisplay="#unable_contact_other"/>
						</controls>
						</obs>
					</p>
				</div>
					
				<p id="unable_contact_other">
					If other, please specify
					<br/>
					<obs conceptId="164473" id="reason_patient_not_contacted_other" />		
				</p>
				
				<div id="location_transfer_referral">
					<p>
						Location of transfer out / referral
						<br/>
						<obs conceptId="161550" id="transferout_location1" />
					</p>
				</div>
					
				<p id="reason_missed_div">
					Reason why missed visit?
					<br/>
					<obs conceptId="159796" id="reason_missed_visit" answerLabels="Patient Relocated,Patient continuing treatment at another location,Patient unable to visit hospital due to personal reasons,Patient died,Patient refused treatment,Patient unwell,Patient has a service complaint,Patient lacks funds to travel to the facility,Patient out of city,Patient already visited facility,Unable to locate referral site,Want treatment at parent site,Other" answerConceptIds="164454,164410,164451,160034,127750,164453,165753,165754,166226,166227,165755,165756,164458">
						<controls>
							<when value="127750" thenDisplay="#refused_treatment"/>
							<when value="164458" thenDisplay="#other_reason"/>
						</controls>
					</obs>				
				</p>
				

				<p id="refused_treatment">
					If refused, please specify reason
					<br/>
					<obs conceptId="166228" id="reason_patient_refused_treatment" maxlength="250" />				
				</p>
				
				
				<p id="other_reason">
					If other please specify
					<br/>
					<obs conceptId="164458" id="reason_missed_visit_other" maxlength="250" />				
				</p>
				
				
				<div id="relocated_and_another_fac_div">
					<p>
						New Location
						<br/>
						<obs conceptId="165757" id="new_location" maxlength="20" />				
					</p>
				
				
					<p>
						New treatment facility name
						<br/>			
						<obs conceptId="162724" id="facility_treatment" maxlength="20" />		
					</p>
				</div>
				
				<div id="reason_changing_div">
					<p>
						Reason for changing to new facility
						<br/>
						<obsgroup groupingConceptId="165760" id="reason_for_changing_facility">
							<obs conceptId="165760" answerConceptId="164402" style="checkbox" answerLabel="Relocated" id="opt1"/> <b style="color:red;"> * </b>
							<br/>
							<obs conceptId="165760" answerConceptId="165758" answerLabel="Old facility too far" style="checkbox"/>
							<br/>
							<obs conceptId="165760" answerConceptId="165753" answerLabel="Service complaint" style="checkbox"/>					
							<br/>
							<obs conceptId="165760" answerConceptId="165759" answerLabel="Other" style="checkbox"/>
						</obsgroup>			
					</p>
				</div> 
				
				
				<div id="return_div">
					<b> Rescheduling Missed Visit </b>
					<p>
						Date of next visit? 
						<br/>
						<obs conceptId="5096" id="return_visit_date" allowFutureDates="true"/>				
					</p>
				</div>
			</div>
				
			<b> Comments </b> 
			
			<p>
				Please specify, if other
				<br/>
				<obs conceptId="165785" id="cse_comments" maxlength="250" rows="4" cols="80"/>
			</p>
             
        </div>
	</section>
	
	
	<submit/>
	
	<script type="text/javascript">
		var showDate = false;
		var dates=[];
		var encounters = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('31d3a6a3-b7f7-4dc5-8ba9-7d33e6991c9f'))  $fn.getObs($encounter, '161550').getValueAsString($!{locale})  #end"/>";
		encounters = encounters.replace(/\s/g, '');
		 
		var encounterResults = "<lookup complexExpression="#foreach($cd4 in $fn.allObs(5096)) $cd4.getValueAsString($!{locale}) #end" />";
		var result = encounterResults.replace(/\s\s+/g, '@');
        var resultValueArray = result.split('@');
		
		for(var i=0 ; i &lt; resultValueArray.length; i++){
			if(!isNaN(new Date(resultValueArray[i]))){
				dates.push(new Date(resultValueArray[i]));
			}
		}
		
		
		<ifMode mode="ENTER">
			$j('#relocated_and_another_fac_div').hide();
			$j('#reason_changing_div').hide();
			
		</ifMode>
	
		var startDate = new Date();
				
		jQuery(function() {
		
			var maxDate=new Date(Math.max.apply(null,dates));
			if(!isNaN(maxDate)){
				maxDate.setDate(maxDate.getDate() + 1);
				var dateString = maxDate.toISOString().slice(0,10);
				setValue('missed_visit_date.value',dateString);
			}
			
			setValue('transferout_location1.value',encounters);
			getField("transferout_location1.value").prop('disabled',true);
			getField("missed_visit_date.value").prop('disabled',true);
			
			getField('patient_contacted.value').change(function() {
				if(getValue('patient_contacted.value') == 1065 || getValue('patient_contacted.value') == 165784 || getValue('patient_contacted.value') == ''){
					setValue('reason_patient_not_contacted_other.value',);
					$j('#unable_contact_other').hide();
				}
				if(getValue('patient_contacted.value') != 1065){
					$j('#relocated_and_another_fac_div').hide();
					$j('#reason_changing_div').hide();
					$j('#other_reason').hide();
					$j('#refused_treatment').hide();
					setValue('reason_missed_visit_other.value',);
					
				}
				
				if(getValue('patient_contacted.value') == 165784 || getValue('patient_contacted.value') == 160034){
					$j('#not_interested_div').hide();
					showDate = false;
				}else{
					$j('#not_interested_div').show();
					showDate = true;
				}
				
			});
			
			getField('reason_missed_visit.value').change(function() {
				if(getValue('reason_missed_visit.value') == 164454 || getValue('reason_missed_visit.value')== 164410){
					$j('#relocated_and_another_fac_div').show();
				}else{
					$j('#relocated_and_another_fac_div').hide();
				}
				
				if(getValue('reason_missed_visit.value') == 164454 || getValue('reason_missed_visit.value')== 164410 || getValue('reason_missed_visit.value')== 127750 || getValue('reason_missed_visit.value')== 160034){
					$j('#return_div').hide();
					showDate = false;
				}else{
					$j('#return_div').show();
					showDate = true;
				}
				if(getValue('reason_missed_visit.value')== 164410){
					$j('#reason_changing_div').show();
				}else{
					$j('#reason_changing_div').hide();
				}
				
			});
			
		});
			  
		beforeSubmit.push(function() {
			var error=true;
			setValue('reason_patient_not_contacted.error', '');
			setValue('reason_patient_not_contacted_other.error', '');
			setValue('reason_missed_visit.error', '');
			setValue('reason_patient_refused_treatment.error', '');
			setValue('reason_missed_visit_other.error', '');
			setValue('new_location.error','');
			setValue('facility_treatment.error','');
			setValue('return_visit_date.error','');
			
			if(getValue('patient_contacted.value')==1066 &amp;&amp; getValue('reason_patient_not_contacted.value')==''){
				getField('reason_patient_not_contacted.error').html('This field can not be null').show();
							error=false;
			}else{
				getField('reason_patient_not_contacted.error').html('').hide();
			}
			
			
			if(getValue('reason_patient_not_contacted.value')==164473 &amp;&amp; getValue('reason_patient_not_contacted_other.value')==''){
				getField('reason_patient_not_contacted_other.error').html('This field can not be null').show();
							error=false;
			}else{
				getField('reason_patient_not_contacted_other.error').html('').hide();
			}
			
			if(getValue('patient_contacted.value')==1065 &amp;&amp; getValue('reason_missed_visit.value')==''){
				getField('reason_missed_visit.error').html('This field can not be null').show();
							error=false;
			}else{
				getField('reason_missed_visit.error').html('').hide();
			}
			
			if(getValue('reason_missed_visit.value')==127750 &amp;&amp; getValue('reason_patient_refused_treatment.value')==''){
				getField('reason_patient_refused_treatment.error').html('This field can not be null').show();
							error=false;
			}else{
				getField('reason_patient_refused_treatment.error').html('').hide();
			}
			
			if(getValue('reason_missed_visit.value')==164458 &amp;&amp; getValue('reason_missed_visit_other.value')==''){
				getField('reason_missed_visit_other.error').html('This field can not be null').show();
							error=false;
			}else{
				getField('reason_missed_visit_other.error').html('').hide();
			}
			if(getValue('reason_missed_visit.value')==164454 ||  getValue('reason_missed_visit.value')==164410){
				if(getValue('new_location.value')==''){
					getField('new_location.error').html('This field can not be null').show();
					error=false;
				}else{
					getField('new_location.error').html('').hide();
				}
				
				if(getValue('facility_treatment.value')==''){
					getField('facility_treatment.error').html('This field can not be null').show();
					error=false;
				}else{
					getField('facility_treatment.error').html('').hide();
				}
			}
			
			if(showDate==true &amp;&amp; getValue('return_visit_date.value')==''){
				getField('return_visit_date.error').html('This field can not be null').show();
				error=false;
			}else{
				getField('return_visit_date.error').html('').hide();
			}
			
			var cond1=true;
			var len1 = jQuery('#reason_changing_div input[type=checkbox]:checked').length;
			if (len1 > 0) {
				cond1=false;
			} 
			
			
			if(getValue('patient_contacted.value')==1065 &amp;&amp; getValue('reason_missed_visit.value') == 164410){
				if(cond1==true){
					getField('opt1.error').html('This field can not be null').show();
					error=false;
				}else{
					getField('opt1.error').html('').hide();
				}	
			}
			
			if(error==false){
				return false;
			}
			else{
				var endDate = new Date();
				var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
				var diffSec = timeDiff/1000;
				
				getField("missed_visit_date.value").prop('disabled',false);
				
				
				alert(diffSec + " seconds to fill form");
												
				return true;
			}
		});
		
	
	</script>

</htmlform>