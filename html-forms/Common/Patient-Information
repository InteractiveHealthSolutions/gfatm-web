<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>FAST-Presumptive Information Form (v0.0.1)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation /></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Patient Information Form">

<p>
Patient Source
							<br/>
							<obs conceptId="166056" id="patient_source" answerConceptIds="164239,1648,124068,165991,166057" answerLabels="Screening,Referred,Contact of TB Patient,Walk-in / Self Referred,Other" required="true">
                             <controls>
			           <when value="166057" thenDisplay="#other_cnic_patient_source_div"/>
				</controls>
</obs> 
						</p>

<div id="other_cnic_patient_source_div">
<p>If other, specify:<br/>
<obs conceptId="166057" id="other_patient_source" maxlength="50" required="false"/>
</p>	
</div>

<p>
External ID
							<br/>
							<obs conceptId="165100" id="contact_external_id" maxlength="20" />
						</p>


<p>National ID card number?<br/>
<obs conceptId="163084" id="cnic" maxlength="15" required="false"/>
</p>


<div id="cnic_owner_div">
<p> Whose NIC is this?
<br/>
<obs conceptId="164107" id="cnic_owner" answerConceptIds="978,970,971,160730,160729,5617,160725,160726,160724,160723,974,975,160727,160728,164110" answerLabels="Self,Mother,Father,Sister,Brother,Spouse,Paternal Grandfather,Paternal Grandmother,Maternal Grandfather,Maternal Grandmother,Uncle,Aunt,Son,Daughter,Other" defaultValue="978">
			    <controls>
			           <when value="164110" thenDisplay="#other_cnic_owner_div"/>
				</controls>
			</obs> 
</p>	
</div>

<div id="other_cnic_owner_div">
<p>If other, specify:<br/>
<obs conceptId="164110" id="other_cnic_owner" maxlength="50" required="false"/>
</p>	
</div>

<p>Has the patient provided their address?<br/>
<obs conceptId="164299" id="address_provided" answerConceptIds="1065,1066" defaultValue="1065" required = "true">
		     <controls>
			           <when value="1065" thenDisplay="#address1_div,#address2_div"/>
				</controls>
			</obs>
</p>

<div id="address1_div">
<p>Address 1 (House Number, etc.):<br/>
<obs conceptId="162725" id="address1" maxlength="50" required="false"/><label  id="intervention_label" style="color:red">*</label>
</p>
</div>

<div id="address2_div">
<p>Address 2 (Town):<br/>
<obs conceptId="165604" id="address2" maxlength="50"  required="false"/><label  id="intervention_label" style="color:red">*</label>
</p>
</div>

<p>Province:<br/>
<obs conceptId="165714" id="province" maxlength="20" required="false"/><label  id="intervention_label" style="color:red">*</label>
</p>

<p>District:<br/>
<obs conceptId="162689" id="district" maxlength="20" required="false"/><label  id="intervention_label" style="color:red">*</label>
</p>

<p>City / Village:<br/>
<obs conceptId="1354" id="city_village" maxlength="20" required="true" defaultValue="Karachi"/>
</p>

<p>What type of Address is this?<br/>
<obs conceptId="164302" id="address_type" answerConceptIds="164303,164304" answerLabels="Permanent,Temporary"/>
</p>

<p>Nearest Landmark:<br/>
<obs conceptId="164305" id="nearest_landmark" maxlength="50"/>
</p>

<p><b>
Screener Instructions: Inform the patient regarding phone calls/sms
</b></p>

<p>Can we call you and SMS you on any of these numbers for matters related to your TB tests and diagnosis?<br/>
<obs conceptId="164700" id="contact_permission" answerConceptIds="1065,1066" defaultValue="1065" required = "true"/>
</p>

<p>Mobile Number:<br/>
<obs conceptId="159635" id="primary_contact" maxlength="12" required="true"/>
</p>

<p>Secondary Mobile Number:<br/>
<obs conceptId="164701" id="secondary_contact" maxlength="12" required="false"/>
</p>

<p>Landline Number:<br/>
<obs conceptId="165608" id="tertiary_contact" maxlength="12" required="false"/>
</p>

<p>Secondary Landline Number:<br/>
<obs conceptId="164706" id="quaternary_contact" maxlength="12" required="false"/>
</p>



	</section>

	<submit/>

<script type ="text/javascript">

   var startDate = new Date();

myRegExp = new RegExp(/\d{5}-\d{7}-\d/);
		mobileNumberRegex = new RegExp(/03\d{2}-\d{7}/);
		landlineNumberRegex = new RegExp(/0\d{3}-\d{7}/);
		addressRegex = new RegExp(/^[-A-Za-z0-9.#&amp;():;,'" \/]/);


jQuery( document ).ready(function() {
           var externalId = '<lookup expression="patient.getPatientIdentifier(5)"/>';
           <ifMode mode="ENTER">	
           $j('#cnic_owner_div').hide();
           </ifMode>
      });

jQuery(function() {

getField('cnic.value').change(function() {
                        if(myRegExp.test(getValue('cnic.value'))){
                              $j('#cnic_owner_div').show();
                         
                        }
                        else{
                        $j('#cnic_owner_div').hide();
                       }
                });
});


function getPatientAndSavePersonAttribute(primaryContact, secondaryContact, tertiaryContact, quarternaryContact) {
		
		var patientId =  '<lookup expression="patient.getPatientIdentifier(3)"/>';
		
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/patient?q=" + patientId + "",
					dataType: 'json'
					}).done(function(data ) {

                                               
						console.log("patient display : " + data.results[0]['display']);
						console.log("patient uuid : " + data.results[0]['uuid']);
						patientUuid = data.results[0]['uuid'];
						savePersonAttribute(patientUuid, primaryContact, secondaryContact, tertiaryContact, quarternaryContact);
				
				});
			
		}
		
		function savePersonAttribute(patientUuid, primaryContact, secondaryContact, tertiaryContact, quarternaryContact) {
			
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/person/" + patientUuid,
                    processData: false,
                    type: "POST",
					data: JSON.stringify({"attributes": [{"attributeType":"14d4f066-15f5-102d-96e4-000c29c2a5d7","value": primaryContact}, {"attributeType":"0d77f271-e2d0-4f39-898d-1906ff0c5b27","value": secondaryContact}, {"attributeType":"c1c2ba98-dc5f-4cf2-9e44-44cd57b2725a","value": tertiaryContact}, {"attributeType":"1b2ede79-bfee-4e9f-81be-86d6e1567556","value": quarternaryContact}]}),
                    contentType: "application/json"
					
					}).done(function(data ) {
                
						console.log(data['display']);
						
				});
		}

function getPatientAndSavePersonAddress(address1, address2, landmark, cityVillage, province, district, country) {
		
		var patientId =  '<lookup expression="patient.getPatientIdentifier(3)"/>';
		
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/patient?q=" + patientId + "",
					dataType: 'json'
					}).done(function(data ) {

                                               
						console.log("patient display : " + data.results[0]['display']);
						console.log("patient uuid : " + data.results[0]['uuid']);
						patientUuid = data.results[0]['uuid'];
						savePersonAddress(patientUuid, address1, address2, landmark, cityVillage, province, district, country);
				
				});
			
		}
		
		function savePersonAddress(patientUuid, address1, address2, landmark, cityVillage, province, district, country) {
			
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/person/" + patientUuid + "/address",
                    processData: false,
                    type: "POST",
					data: JSON.stringify({"address1": address1, "address2": address2, "address3": landmark, "cityVillage": cityVillage, "stateProvince": province, "countyDistrict": district, "country": country, "preferred": true}),
                    contentType: "application/json"
					
					}).done(function(data ) {
                
						console.log(data['display']);
						
				});
		}
		
		function getPatientAndSavePatientIdentifiers(externalID) {
		
		var patientId =  '<lookup expression="patient.getPatientIdentifier(3)"/>';
		
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/patient?q=" + patientId + "",
					dataType: 'json'
					}).done(function(data ) {

                                               
						console.log("patient display : " + data.results[0]['display']);
						console.log("patient uuid : " + data.results[0]['uuid']);
						patientUuid = data.results[0]['uuid'];
						savePatientIdentifiers(externalID);
				
				});
			
		}
		
		function savePatientIdentifiers(externalID) {
			
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/patient/" + patientUuid + "/identifier",
                    processData: false,
                    type: "POST",
					data: JSON.stringify({"identifier": externalID, "identifierType": "20b16aaf-2851-4662-8292-0e7b89a82448", "preferred": true, "voided": false}),
                    contentType: "application/json"
					
					}).done(function(data ) {
                
						console.log(data['display']);
						
				});
		}


    beforeSubmit.push(function() {

		var error = true;
                        setValue('cnic.error', '');
                        setValue('cnic_owner.error', '');
			setValue('primary_contact.error','');
			setValue('secondary_contact.error','');
			setValue('tertiary_contact.error','');
			setValue('quaternary_contact.error','');
			setValue('address1.error','');
			setValue('address2.error','');
			setValue('other_cnic_owner.error','');
		
		var cnicValue = getValue('cnic.value');
			var mobileNumberValue = getValue('primary_contact.value');
			var secondaryMobileValue = getValue('secondary_contact.value');
			var landlineNumber = getValue('tertiary_contact.value');
			var secondaryLandline = getValue('quaternary_contact.value');
			var address1Value = getValue('address1.value');
			var address2Value = getValue('address2.value');

	if(cnicValue.length &gt; 0){
				if(!myRegExp.test(getValue('cnic.value'))) { 
					getField('cnic.error').html('Invalid CNIC. Please enter CNIC in following format: xxxxx-xxxxxxx-x').show();
					error=false;
				}
				else{
                                       getField('cnic.error').html('').hide();
                                       if(getValue('cnic_owner.value')==''){
                                       		getField('cnic_owner.error').html('This field cannot be empty').show();
                                                error=false;
                                       }

                                       else{
                                          getField('cnic_owner.error').html('').hide();
                                       }
					   
				}
			}
			if(mobileNumberValue.length &gt; 0){
				if(!mobileNumberRegex.test(getValue('primary_contact.value'))) { 
					getField('primary_contact.error').html('Invalid Mobile Number. Please enter Mobile Number in following format: xxxx-xxxxxxx').show();
					error=false;
				}
				else{
					getField('primary_contact.error').html('').hide();
				}
			}
			
			if(secondaryMobileValue.length &gt; 0){
				if(!mobileNumberRegex.test(getValue('secondary_contact.value'))) { 
					getField('secondary_contact.error').html('Invalid Mobile Number. Please enter Mobile Number in following format: xxxx-xxxxxxx').show();
					error=false;
				}
				else{
					getField('secondary_contact.error').html('').hide();
				}
			}
			
			if(landlineNumber.length &gt; 0){
				if(!landlineNumberRegex.test(getValue('tertiary_contact.value'))) { 
					getField('tertiary_contact.error').html('Invalid Landline Number. Please enter Landline Number in following format: xxx-xxxxxxxx').show();
					error=false;
				}
				else{
					getField('tertiary_contact.error').html('').hide();
				}
			}
			
			if(secondaryLandline.length &gt; 0){
				if(!landlineNumberRegex.test(getValue('quaternary_contact.value'))) { 
					getField('quaternary_contact.error').html('Invalid Landline Number. Please enter Landline Number in following format: xxx-xxxxxxxx').show();
					error=false;
				}
				else{
					getField('quaternary_contact.error').html('').hide();
				}
			}
			
			if(address1Value.length &gt; 0){
				if(!addressRegex.test(getValue('address1.value'))) { 
					getField('address1.error').html('Invalid Address format.').show();
					error=false;
				}
				else{
					getField('address1.error').html('').hide();
				}
			}
			
			if(address2Value.length &gt; 0){
				if(!addressRegex.test(getValue('address2.value'))) { 
					getField('address2.error').html('Invalid Address format.').show();
					error=false;
				}
				else{
					getField('address2.error').html('').hide();
				}
			}
			
			if(getValue('address_provided.value')==1065 &amp;&amp; getValue('address1.value')==''){
                getField('address1.error').html('This field can not be empty').show();
                error=false;                
            }
            else{
                getField('address1.error').html('').hide();
            }
			
			if(getValue('address_provided.value')==1065 &amp;&amp; getValue('address2.value')==''){
                getField('address2.error').html('This field can not be empty').show();
                error=false;                
            }
            else{
                getField('address2.error').html('').hide();
            }
			
			if(myRegExp.test(getValue('cnic.value')) &amp;&amp; getValue('cnic_owner.value')==164110 &amp;&amp; getValue('other_cnic_owner.value')==''){
                getField('other_cnic_owner.error').html('This field can not be empty').show();
                error=false;                
            }
            else{
                getField('other_cnic_owner.error').html('').hide();
            }
			

              if(error==false){
                  return false;
              }
             else{
  // Saving Person Attributes
			    var finalMobileNumberValue = getValue('primary_contact.value');
			    var finalSecondaryMobileValue = getValue('secondary_contact.value');
			    var finalLandlineNumber = getValue('tertiary_contact.value');
			    var finalSecondaryLandline = getValue('quaternary_contact.value');
                            var finalPatientSource = getValue('patient_source');
		
			    
			    getPatientAndSavePersonAttribute(finalMobileNumberValue, finalSecondaryMobileValue, finalLandlineNumber, finalSecondaryLandline);

// Saving Person Address
				var finalAddress1Value = getValue('address1.value');
				var finalAddress2Value = getValue('address2.value');
				var finalLandmarkValue = getValue('nearest_landmark.value');
				var finalDistrictValue = getValue('district.value');
				var finalProvinceValue = getValue('province.value');
				var finalCityVillageValue = getValue('city_village.value');
				var finalCountryValue = "Pakistan";
				
				getPatientAndSavePersonAddress(finalAddress1Value, finalAddress2Value, finalLandmarkValue, finalCityVillageValue, finalProvinceValue, finalDistrictValue, finalCountryValue);
				
				// Saving Patient Identifiers - External ID
				var finalExternalID = getValue('contact_external_id.value');
				
				var externalIdFinal = '<lookup expression="patient.getPatientIdentifier(5)"/>';
		   
		        if(externalIdFinal != '') {
				    if(finalExternalID != externalIdFinal) {
					   getPatientAndSavePatientIdentifiers(finalExternalID);
					}
				}
				else {
				    getPatientAndSavePatientIdentifiers(finalExternalID);
				}

			var endDate = new Date();
			var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
			var diffSec = timeDiff/1000;
			alert(diffSec + " seconds to fill form");
            return true;
         }
			
});


</script>

</htmlform>