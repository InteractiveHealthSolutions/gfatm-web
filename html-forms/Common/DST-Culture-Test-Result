<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>DST Culture Test Result</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today" id="encounter_date" allowFutureDates="false"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation  default="1"/></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. DST Results">
   <div>

<p>
							 Order ID
<br/>
							 <select id="order_id_list">			   
				             </select>
<br/>
							 <obs id="order_id" conceptId="165715" required="false" />
							 </p>



		       <p> Type of media for DST
				<br/>
				<obs conceptId="164615" answerConceptIds="160011,164612,164613, 164614, 165658" id="dst_medium"  required="true" defaultValue="160011">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

                        <p>Isoniazid 0.2 µg/ml result
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="INH_0_2_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Isoniazid 1 µg/ml  result
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="INH_1_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Rifampicin
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="rif_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Ethambuthol
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="ETB_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Streptomycin
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="SM_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Pyrazinamide
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="PZA_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Ofloxacin
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="OFX_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Levofloxacin
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="LEVO_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>
<p>Moxifloxacin 0.5 µg/ml
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="MOXI_0_5_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Moxifloxacin 2 µg/ml
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="MOXI_2_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Amikacin
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="AMK_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Kanamycin  
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="KM_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Capreomycin
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="CM_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Ethionamide   
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="ETHIO_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Cycloserine   
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="CS_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>P-Aminosalicylic Acid
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="PAS_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Bedaquiline  
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="BDQ_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Delamanid  
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="DLM_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Linezolid  
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="LZD_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

<p>Clofazamine  
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="CFZ_resistant"  required="true" defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>

 <p>Other drug name   
				<br/>
				<obs conceptId="163101" id="other_drug_name" required = "true"  />
			</p>

<div id ="other_drug_resistant_div">
<p>Other drug Result*
				<br/>
				<obs conceptId="164632" answerConceptIds="164608,164609,1138" id="other_drug_resistant"  defaultValue="164608">
			         <controls>
	                                
					 </controls>
				</obs>
			</p>
</div>

<p>Test ID
				<br/>
				<obs conceptId="164350" id="test_id"/>
			</p>
</div>
	</section>

	<submit/>

<script type = "text/javascript">

var startDate = new Date();

jQuery( document ).ready(function() {  
		
		 getField("order_id.value").prop('disabled',true);
		 
		 var is_visible = false;

		<ifMode mode="VIEW">
			is_visible = true;
		</ifMode>
		
		if(is_visible) {
			document.getElementById('order_id_list').style.display = 'none';
		}
		else {
			document.getElementById('order_id_list').style.display = 'block';
		}
		  
		 var encounters1 = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('934e7667-879c-41eb-859e-ca333a3d50a0'))  $fn.getObs($encounter, '165715').getValueAsString($!{locale}) #end"/>";
		 var result1 = encounters1.replace(/\s\s+/g, '@');
         var resultValueArray1 = result1.split('@');
		
		 var orders = document.getElementById('order_id_list');
		 orders.options.length = 0;
		 for (i = 0; i &lt; resultValueArray1.length; i++) {
			    if(resultValueArray1[i] != '' &amp;&amp; resultValueArray1[i]!="$fn.getObs($encounter, '165715').getValueAsString($!{locale})") {
				   orders.options[i]= new Option(resultValueArray1[i]);
				}
		}
		
		orders.remove(0);

        <ifMode mode="ENTER">		
		setValue('order_id.value', resultValueArray1[1]);
		</ifMode>	  
        });
		
		jQuery(function() {
		var facilities = document.getElementById("order_id_list");
               facilities.onchange = function(){
                var e = document.getElementById("order_id_list");
                var ordersFinal = e.options[e.selectedIndex].value;
												
				setValue('order_id.value', ordersFinal);
                getField('order_id.value').change();
										
		        };
		});


 jQuery(function() {
              $j('#other_drug_resistant_div').hide();

$j('#other_drug_name').on('input', function(){
   if($j.trim(getValue('other_drug_name.value')) != ""){
        $j('#other_drug_resistant_div').show();
}
   else
       $j('#other_drug_resistant_div').hide();
});

});



function convert(str) {
    var mnths = { 
        Jan:"01", Feb:"02", Mar:"03", Apr:"04", May:"05", Jun:"06",
        Jul:"07", Aug:"08", Sep:"09", Oct:"10", Nov:"11", Dec:"12"
    },
    date = str.split(" ");

    return [ date[3], mnths[date[1]], date[2] ].join("-");
}


beforeSubmit.push(function() {
		var error=true;
		setValue('other_drug_resistant.error', '');
 setValue('test_id.error', '');
		setValue('order_id.error', '');


				<ifMode mode="ENTER">	
			var OrderIdEncounters = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('a4506440-48bf-4d03-be69-fff05d5755a2'))  $fn.getObs($encounter, '165715').getValueAsString($!{locale}) #end"/>";
            var OrderIdResult = OrderIdEncounters.replace(/\s\s+/g, '@');
            var OrderIdResultValueArray = OrderIdResult.split('@');
			
			 for(var j = OrderIdResultValueArray.length-1; 0 &lt;= j; j--){
                if((OrderIdResultValueArray[j]).trim() == (getValue('order_id.value')).trim()){                //if both ids match use 'j' index to retrieve last food intake value                      
                                             
                    getField('order_id.error').html('Result for this Order ID already submitted.').show();
					error = false;
                    break;
                }
                else {
                     getField('order_id.error').html('').hide();
                }
			 }
            
			//Code for Checking if Test ID already exists.
            myRegExp = new RegExp(/^[a-zA-Z0-9-,.'"()#&amp;:;,'"+%$*=!| \\/]{1,20}$/);
			
	        var encounters = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('a4506440-48bf-4d03-be69-fff05d5755a2'))  $fn.getObs($encounter, '164350').getValueAsString($!{locale}) #end"/>";
            var result = encounters.replace(/\s\s+/g, '@');
            var resultValueArray = result.split('@');			
               
            if(getValue('test_id.value').length > 0){
            if(!myRegExp.test(getValue('test_id.value'))) { 
			     
				getField('test_id.error').html('Not a valid ID.').show();
                error=false;
            }
             else if(getValue('test_id.value').length > 0 &amp;&amp; getValue('test_id.value').trim() ==''){
               getField('test_id.error').html('Invalid Test ID').show();
               error=false;
            }
            else{
                getField('test_id.error').html('').hide();

                //error=true;
                /*for(var j = resultValueArray.length-1; 0 &lt;= j; j--){
                if((resultValueArray[j]).trim() == (getValue('test_id.value')).trim()){                //if both ids match use 'j' index to retrieve last food intake value
                            error =true;
                            getField('test_id.error').html('').hide();
                            break;
                        }
                else {
                     getField('test_id.error').html('Test Order not found for this ID').show();
                }       

                }*/
				
				for(var j = resultValueArray.length-1; 0 &lt;= j; j--){
                if((resultValueArray[j]).trim() == (getValue('test_id.value')).trim()){                //if both ids match use 'j' index to retrieve last food intake value                      
                error =false;
                            
                    getField('test_id.error').html('Test ID already exists.').show();
                            break;
                        }
                else {
                     getField('test_id.error').html('').hide();
                }       

                }	
		   
            }
}else
                getField('test_id.error').html('').hide();
</ifMode>

         
 if($j.trim(getValue('other_drug_name.value')) != ""&amp;&amp; getValue('other_drug_resistant.value')==''){
					getField('other_drug_resistant.error').html('This field can not be null').show();
					error=false;
	     }

	if(error==false){
            return false;
        }
        else{
			getField("order_id.value").prop('disabled',false);
			var endDate = new Date();
			var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
			var diffSec = timeDiff/1000;
			alert(diffSec + " seconds to fill form");
            return true;
        }

 });

</script>


</htmlform>