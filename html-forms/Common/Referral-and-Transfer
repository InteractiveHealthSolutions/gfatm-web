<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>Referral and Transfer Form (v1.0.0)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="2"  /></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2.Referral and Transfer Information">
		<div>
			<p>
 				Is this patient being referred out or transferred out?
                <br/>
			</p>
			
				<obs conceptId="164408" id="referral_transfer" answerConceptIds="1648,160036" answerLabels="Referral (before starting treatment),Transfer (after starting treatment)" required="true" defaultValue="1648" />
			<p>
 				Reason for referral/transfer
                <br/>
				<obs conceptId="164411" id="reason_referral_transfer" answerConceptIds="164410,166195,156080,159874,164409,166194,165035,165180,164295,164459,165186,165187,165188,165189,1896,164653" defaultValue="164410" answerLabels="Patient chose another facility,DR-TB Suspect,DR-TB,Treatment Failure,Complicated TB,Mycobacterium other than TB (MOTT),Treatment initiation,Infection control,Adverse Event,Comorbidity,Severe clinical condition,Surgical operation,Patient behavior,Social reason,Hospitalization,Other" required="true">
				<controls>
					<when value="164653" thenDisplay="#reason_other"/>
				</controls>
				</obs>
			</p>
			
			
			<p id="reason_other">
				Reason, if Other
				<br/>
				<obs conceptId="164653" id="reason_referral_transferr_other" maxlength="100" />
			</p>
			
			<div id="treat_date_number_div">
				<p id="treat_start_date">
					Treatment start date
					<br/>
					<obs conceptId="163526" id="treatment_start_date" />
				</p>
				
				<p id="national_drtb_reg">
					National DR TB Registration number
					<br/>
					<td><lookup class="value" complexExpression="#foreach( $patId in $patientIdentifiers.get('External ID') ) $patId #end "/></td>
				</p>
			
				<p>
					Current treatment Facility
					<br/>
					<select id="facility_list_1">			   
					</select>
					<obs conceptId="162724" id="facility_treatment" />				
				</p>
				
				<div id="treatment_other">
					<p>
						If treatment facility 'Other', then specify:
						<br/>
						<obs conceptId="165695" id="facility_treatment_other" maxlength="100" />				
					</p>
				</div>
				
				<div id="focal_person_name">
					<p>
						Treatment facility focal person name
						<br/>
						<obs conceptId="165628" id="facility_focal_person_name" maxlength="50" />				
					</p>
				</div>
				
				<div id="focal_person_number">
					<p>
						Treatment facility focal person phone number
						<br/>
						<obs conceptId="165629" id="facility_focal_person_ph_number" maxlength="12" />				
					</p>
				</div>
				
				<div id="coordinator_name">
					<p>
						Treatment facility District Tuberculosis Coordinator name        
						<br/>
						<obs conceptId="165630" id="facility_district_coordinator_name" maxlength="50" />				
					</p>
				</div>
				
				<div id="coordinator_number">
					<p>
						Treatment facility District Tuberculosis Coordinator number        
						<br/>
						<obs conceptId="165631" id="facility_district_coordinator_number" maxlength="12" />				
					</p>
				</div>
				
				<div id="ref_clinician_name">
					<p>
						Name of clinician referring the patient
						<br/>
						<obs conceptId="165632" id="ref_clinician_name" maxlength="50" />				
					</p>
				</div>
			</div>
			
			<div id="location_transfer_referral">
				<p>
					Location of transfer out / referral
					<br/>
					<select id="facility_list">			   
					</select>
					<obs conceptId="161550" id="transferout_location1" required="true"/>
				</p>
			</div>
			
			<div id="other_loc_transfer_referral">
				<p>
					Location, if Other
					<br/>
					<obs conceptId="164667" id="referral_site_transfer_other" maxlength="100" />
				</p>
			</div>
				
			<div id="treatment_div">
				<p>
					Treatment initiated at Referral / Transfer site
					<br/>
					<obs conceptId="164549" id="treatment_initiated_referralsite" answerConceptIds="1065,1066,1067" required="true" >				
					<controls>
						<when value="1066" thenDisplay="#treatment_initiated_div"/>
					</controls>
					</obs>


				</p>
			</div>
			
				
			<div id="treatment_initiated_div">
				<p>
					Reason treatment not initiated at referral site
					<br/>
					<obs conceptId="164541" id="reasontreatment_notinitiated_referralsite" answerConceptIds="164496,164497,127750,159,164538,164438" answerLabels="Patient could not be contacted,Patient left the city,Patient refused treatment,Patient died,DR not confirmed by baseline repeat test,Other">
					<controls>
						<when value="164438" thenDisplay="#reason_not_initiated"/>
					</controls>
					</obs>	
				</p>
			</div>
			
			<div id="reason_not_initiated">
				<p>
					Please specify, if other
					<br/>
					<obs conceptId="164438" id="reasontreatment_notinitiated_referralsite_other" maxlength="100" rows="4" cols="80"/>
				</p>
			</div>
			
			
			<p id="dr_confir">
 				DR Confirmation
                <br/>
				<obs conceptId="164570" id="dr_confirmation" answerConceptIds="1065,1066">	
				<controls>
						<when value="1065" thenDisplay="#enrs_number"/>
				</controls>
				</obs>
			</p>
			
			<p id="enrs_number">
 				ENRS Number
                <br/>
				<input type="text" name="enrs_id"  maxlength="20" />	
			</p>
			
			<div id="provider_details">
				<b> Provide name and contact number of person at referral / transfer site who provided details about the patient </b>			
				<br/>
				
				<p>
					Contact Name
					<br/>
					<obs conceptId="164580" id="refcontact_firstname" maxlength="20" />	
				</p>
				
				<p>
					Primary Contact Number
					<br/>
					<obs conceptId="164587" id="refcontact_number" maxlength="12" />	
				</p>
			</div>	
			
             
        </div>
	</section>
	
	
	<submit/>
	
	<script type="text/javascript">
	
		var encounters = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('f2038177-d0ee-4856-ab41-2b9bad0e949e'))  $fn.getObs($encounter, '164412').getValueAsString($!{locale})  #end"/>";
		if(encounters!=''){
			var regDateArr = encounters.split(/\s\s+/g);
			var regDate = regDateArr[regDateArr.length-2];
		}
		
		
		
		
		var mobileNumberRegex = new RegExp(/03\d{2}-\d{7}/);
		function doRes1t(){
			jQuery.ajax({
				url: "/openmrs/ws/rest/v1/location?v=custom:(uuid,display,name,description)&amp;tag=Transfer Location",
				dataType: 'json'
				}).done(function(data ) {
					console.log(data.results[0].name);
					console.log(data.results.length);
					locationData = data;
					populate(data);
			});
		}
		
		function doRest2(){
			jQuery.ajax({
				url: "/openmrs/ws/rest/v1/location?v=custom:(uuid,display,name,description)",
				dataType: 'json'
				}).done(function(data ) {
					console.log(data.results[0].name);
					console.log(data.results.length);
					locationData = data;
					populate2(data);
			});
		}
		
		function populate2(data) {
								
			var s1= document.getElementById('facility_list_1');
			
			for (i = 0; i &lt; data.results.length; i++) { 
				s1.options[i+1]= new Option(data.results[i].description, data.results[i].name);
				var resultObject =  JSON.parse(JSON.stringify(data.results[i].description || null));
			}
			
			s1.options[i+1] = new Option('Other', 'Other');			
		}
		
		
		function populate(data) {
								
			var s= document.getElementById('facility_list');
			
			for (i = 0; i &lt; data.results.length; i++) { 
				s.options[i+1]= new Option(data.results[i].description, data.results[i].name);
				var resultObject =  JSON.parse(JSON.stringify(data.results[i].description || null));
			}
			
			s.options[i+1] = new Option('Other', 'Other');
		}

		
		
		function getPatientAndUpdateENRS(enrsNumber) {
		
			var patientId =  '<lookup expression="patient.getPatientIdentifier(3)"/>';
		
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/patient?q=" + patientId + "",
					dataType: 'json'
					}).done(function(data ) {

                                               
						console.log("patient display : " + data.results[0]['display']);
						console.log("patient uuid : " + data.results[0]['uuid']);
						patientUuid = data.results[0]['uuid'];
						savePatientIdentifiers(enrsNumber);		
				});
		}
		
		function savePatientIdentifiers(enrsNumber) {
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/patient/" + patientUuid + "/identifier",
                    processData: false,
                    type: "POST",
					data: JSON.stringify({"identifier": enrsNumber, "identifierType": "0481be90-41be-4aa2-b0dc-0e82ccff6f5c", "preferred": true, "voided": false}),
                    contentType: "application/json"
					}).done(function(data ) {
						console.log(data['display']);
				});
		}
		
		<ifMode mode="ENTER">
			if(getValue('referral_site.value')==63){
				$j('#location_other').show();
			}else{
				$j('#location_other').hide();
			}
			$j('#dr_confir').hide();
			$j('#treat_date_number_div').hide();
			$j('#other_loc_transfer_referral').hide();
			$j('#treatment_other').hide();
			doRes1t();
			doRest2();
		</ifMode>
		
		 jQuery(window).bind("load", function() {
				<ifMode mode="EDIT">
					if(getValue('referral_site.value')==63){
						$j('#location_other').show();
					}else{
						$j('#location_other').hide();
					}
				</ifMode>
		
        });
		
		var startDate = new Date();
				
		jQuery(function() {	
		
			if(!isNaN(new Date(regDate))){
				var d = new Date(regDate);
				var dateString = d.toISOString().slice(0,10);
				setValue('treatment_start_date.value',dateString);
			}
			getField("transferout_location1.value").prop('disabled',true);
			getField("facility_treatment.value").prop('disabled',true);
			getField("treatment_start_date.value").prop('disabled',true);
			
			var facilities = document.getElementById("facility_list");
			facilities.onchange = function(){
				var e = document.getElementById("facility_list");
				var locationDescription = e.options[e.selectedIndex].text;
                var locationName = e.options[e.selectedIndex].value;
				setValue('transferout_location1.value',locationName );
				if(getValue('transferout_location1.value')=='Other'){
					$j('#other_loc_transfer_referral').show();
				}else{
					$j('#other_loc_transfer_referral').hide();
				}
				doRest(getValue('transferout_location1.value'));						
			};
		
			var facilities1 = document.getElementById("facility_list_1");
			facilities1.onchange = function(){
                var e1 = document.getElementById("facility_list_1");
				var locationDescription1 = e1.options[e1.selectedIndex].text;
                var locationName1 = e1.options[e1.selectedIndex].value;
				setValue('facility_treatment.value',locationName1 );
				if(getValue('facility_treatment.value')=='Other'){
					$j('#treatment_other').show();
				}else{
					$j('#treatment_other').hide();
				}
										
			};
			
			getField('treatment_initiated_referralsite.value').change(function(){
				if(getValue('treatment_initiated_referralsite.value')==1066 &amp;&amp; getValue('reasontreatment_notinitiated_referralsite.value')==164438){
					$j('#reason_not_initiated').show();
				}else{
					$j('#reason_not_initiated').hide();
				}
				
				if(getValue('treatment_initiated_referralsite.value')==1065 &amp;&amp; (getValue('reason_referral_transfer.value')==156080 || getValue('reason_referral_transfer.value')==166195)){
					$j('#dr_confir').show();
                                        if(getValue('dr_confirmation.value')==1065) {
                                           $j('#enrs_number').show();
                                       }else{
                                          $j('#enrs_number').hide();
                                      }
				}else {
					$j('#dr_confir').hide();
                                        $j('#enrs_number').hide();
				}
			});
			
			getField('referral_transfer.value').change(function(){
				if(getValue('reason_referral_transfer.value')==156080 &amp;&amp; getValue('referral_transfer.value')==160036){
					$j('#treat_date_number_div').show();
				}else{
					$j('#treat_date_number_div').hide();
				}
			});
					
			getField('facility_treatment.value').change(function(){
				if(getValue('facility_treatment.value')==183){
					$j('#treatment_other').show();
				}else{
					$j('#treatment_other').hide();
				}
			});
			
			getField('reason_referral_transfer.value').change(function(){
				if(getValue('reason_referral_transfer.value')==156080 &amp;&amp; getValue('referral_transfer.value')==160036){
					$j('#treat_date_number_div').show();
				}else{
					$j('#treat_date_number_div').hide();
				}

				if(getValue('treatment_initiated_referralsite.value')==1065 &amp;&amp; (getValue('reason_referral_transfer.value')==156080 || getValue('reason_referral_transfer.value')==166195)){
					$j('#dr_confir').show();
					if(getValue('dr_confirmation.value')==1065) {
						$j('#enrs_number').show();
					}else{
						$j('#enrs_number').hide();
					}
			}else {
					$j('#dr_confir').hide();
					$j('#enrs_number').hide();
			}
			});
		});
			  

		beforeSubmit.push(function() {
			setValue('reason_referral_transferr_other.error', '');
			setValue('reasontreatment_notinitiated_referralsite_other.error', '');
			setValue('reasontreatment_notinitiated_referralsite.error', '');
			setValue('referral_site_transfer_other.error', '');
			setValue('facility_focal_person_ph_number.error','');
			setValue('facility_district_coordinator_number.error','');
			setValue('refcontact_number.error','');
			
			var error=true;
			 if(getValue('reason_referral_transfer.value')==164653 &amp;&amp; getValue('reason_referral_transferr_other.value')==''){
                getField('reason_referral_transferr_other.error').html('This field can not be empty').show();
                error=false;                
            }
            else{
                getField('reason_referral_transferr_other.error').html('').hide();
                
            }
			if(getValue('treatment_initiated_referralsite.value')==1065 &amp;&amp; (getValue('reason_referral_transfer.value')==156080 || getValue('reason_referral_transfer.value')==166195) &amp;&amp; getValue('dr_confirmation.value')==1065 ){
				var enrs = document.getElementsByName('enrs_id')[0].value;
				if(enrs==null || enrs==''){
					alert('ENRS can not be null');
					error=false;
				}
			}
			
			if(getValue('referral_transfer.value')==160036 &amp;&amp; getValue('reason_referral_transfer.value')==156080){
               if(getValue('facility_focal_person_ph_number.value').length > 0){
						if(!mobileNumberRegex.test(getValue('facility_focal_person_ph_number.value'))) { 
							getField('facility_focal_person_ph_number.error').html('Invalid Mobile Number. Please enter Mobile Number in following format: 03xx-xxxxxxx').show();
							error=false;
						}
						else{
							getField('facility_focal_person_ph_number.error').html('').hide();
						}
					}

				if(getValue('facility_district_coordinator_number.value').length > 0){
						if(!mobileNumberRegex.test(getValue('facility_district_coordinator_number.value'))) { 
							getField('facility_district_coordinator_number.error').html('Invalid Mobile Number. Please enter Mobile Number in following format: 03xx-xxxxxxx').show();
							error=false;
						}
						else{
							getField('facility_district_coordinator_number.error').html('').hide();
						}
					}					
            }
			
			if(getValue('refcontact_number.value').length > 0){
				if(!mobileNumberRegex.test(getValue('refcontact_number.value'))) { 
					getField('refcontact_number.error').html('Invalid Mobile Number. Please enter Mobile Number in following format: 03xx-xxxxxxx').show();
					error=false;
				}else{
					getField('refcontact_number.error').html('').hide();
				}
			}	
			else{
                getField('facility_district_coordinator_number.error').html('').hide();
                
            }		
					
			if(getValue('reasontreatment_notinitiated_referralsite.value')==164438 &amp;&amp; getValue('reasontreatment_notinitiated_referralsite_other.value')==''){
                getField('reasontreatment_notinitiated_referralsite_other.error').html('This field can not be empty').show();
                error=false;                
            }
            else{
                getField('reasontreatment_notinitiated_referralsite_other.error').html('').hide();
                
            }
			
			if(getValue('treatment_initiated_referralsite.value')==1066 &amp;&amp; getValue('reasontreatment_notinitiated_referralsite.value')==''){
                getField('reasontreatment_notinitiated_referralsite.error').html('This field can not be empty').show();
                error=false;                
            }
            else{
                getField('reasontreatment_notinitiated_referralsite.error').html('').hide();
                
            }
			
			if(getValue('transferout_location1.value')== 'Other' &amp;&amp; getValue('referral_site_transfer_other.value')==''){
				getField('referral_site_transfer_other.error').html('This field can not be empty').show();
                error=false;                
            }
            else{
                getField('referral_site_transfer_other.error').html('').hide();
            }			
			
			if(getValue('facility_treatment.value')==183 &amp;&amp; getValue('facility_treatment_other.value')==''){
				 getField('facility_treatment_other.error').html('This field can not be empty').show();
                error=false;                
            }
            else{
                getField('facility_treatment_other.error').html('').hide();
            }

			if(getValue('treatment_initiated_referralsite.value')==1065 &amp;&amp; (getValue('reason_referral_transfer.value')==156080 || getValue('reason_referral_transfer.value')==166195) &amp;&amp; getValue('dr_confirmation.value')==''){				
                getField('dr_confirmation.error').html('This field can not be empty').show();
                error=false;
			}else{
                getField('dr_confirmation.error').html('').hide();
            }
			
			if(error==false){
				return false;
			}
			else{
				var endDate = new Date();
				var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
				var diffSec = timeDiff/1000;
				alert(diffSec + " seconds to fill form");
				
				getField("transferout_location1.value").prop('disabled',false);
				getField("facility_treatment.value").prop('disabled',false);
			
				var enrs = document.getElementsByName('enrs_id')[0].value;
				getPatientAndUpdateENRS(enrs);
								
				return true;
			}
		});
		
		
		function doRest(val){
			jQuery.ajax({
				url: "/openmrs/ws/rest/v1/location?v=custom:(attributes)&amp;q=" + val,
				dataType: 'json'
				}).done(function(data) {
					var array = data.results[0].attributes;
					var nameExist = false,contactExist=false;
					for (i in array) {
						var obj = array[i];
						if(obj.voided == false){
							if(obj.display.includes("Primary Contact Name")){
							nameExist = true;
							setValue('refcontact_firstname.value', obj.value);
					   }
					   else if(obj.display.includes("Primary Contact")){
							contactExist = true;
							if(obj.value.length==11){
								obj.value = obj.value.substring(0, 4) + '-' + obj.value.substring(4, obj.value.length);
							}
							setValue('refcontact_number.value', obj.value);
					   }
					  }
					}
					if(nameExist==false){
						setValue('refcontact_firstname.value', );
					}
					if(contactExist==false){
						setValue('refcontact_number.value', );
					}
			});
		}
	
	</script>

</htmlform>