<htmlform>
	<!-- Developed by Tahira -->
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PMDT-Treatment Supporter Discontinuation(v0.0.1-alpha)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="2"  tags="PMDT" /></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Treatment Supporter Discontinuation Information ">           
             
		<div>
				<p>
				Treatment Supporter ID
				<br/>
				<obs id="treatment_supporter_id" conceptId="165524" required="true"/>
				</p>

				<p>
				Reason for discontinuation
				<br/>
				<obs id="reason_dissociation" conceptId="164397" answerConceptIds="164394,164398,164399,164400,164401,164402,164403,164404,164405,164406,165660" 
				answerLabels="Patient is not satisfied with the Treatment Supporter,Supervisor is not satisfied with Treatment Supporter's performance,Treatment outcome has been declared for the patient,Treatment Supporter is unwilling to continue with this patient,Treatment Supporter has relocated,Patient has relocated,Treatment Supporter has been shifted to another program location,Patient has been transferred to another program location,Treatment Supporter is unwilling to continue with the program,Treatment Supporter has been asked to leave the program,Other"
				defaultValue="164399" required="true"/>
				</p>

				<div id="display_reason_dissociation_other">
				<p>
				If reason 'other', then specify:
				<br/>
				<obs id="reason_dissociation_other" conceptId="165660" maxlength="255"  style="textarea" />
				</p>
				</div>
				
				<div id="time_taken_div">
				<p> 
				Time taken to fill form
				<br/>
				<obs id="time_taken" conceptId="165044" />
				</p>
				</div>

		</div> 	
		
	</section>

	<submit/>

    <script type="text/javascript">
	var startDate = new Date();
	
	var reason_dissociation_other =jQuery("#display_reason_dissociation_other");
	
	   jQuery( document ).ready(function() {
                 
			var timeTakenDiv = jQuery("#time_taken_div");
			timeTakenDiv.hide();
			
			getField("treatment_supporter_id.value").prop('disabled', true);
			
			<ifMode mode='VIEW' include="false"> 
				if(getValue('reason_dissociation.value') == 165660 ){
					reason_dissociation_other.show();
				}
				else{
					reason_dissociation_other.hide();	
				}
			</ifMode>
			<ifMode mode='ENTER' > 
				var treatmentSupporter="<lookup expression="personAttributes.get('Treatment Supporter')"/>";
				console.log(treatmentSupporter);
				if(treatmentSupporter==""){
					alert("Please assign Treatment Supporter to this patient first.");
				}
				else{
					setValue("treatment_supporter_id.value",treatmentSupporter);
				}
			</ifMode>		
		});
		
		jQuery(function() {
			getField('reason_dissociation.value').change(function() {
				
				if(getValue('reason_dissociation.value') == 165660 ){
					reason_dissociation_other.show();
				}
				else{
					setValue("reason_dissociation_other.value","");
					reason_dissociation_other.hide();	
				}			
				});	
			});
			
		<!-- Error Checking before Form Submit -->
		beforeSubmit.push(function() {
			
			var valid=true;
			
			setValue('reason_dissociation.error','');
			setValue('reason_dissociation_other.error','');
			setValue('treatment_supporter_id.error','');
			

			if(getValue('reason_dissociation.value')==""){
				getField('reason_dissociation.error').html('Please select a value').show();
                valid=false;                
            }
            else{
                getField('reason_dissociation.error').html('').hide(); 
            }
			
			if(getValue('reason_dissociation.value')==165660 &amp;&amp; getValue('reason_dissociation_other.value')==''){
                getField('reason_dissociation_other.error').html('Please input a value').show();
                valid=false;                
            }
            else{
                getField('reason_dissociation_other.error').html('').hide(); 
            }
			
			if(getValue('treatment_supporter_id.value')==""){
				alert("Please assign Treatment Supporter to this patient first.");
				getField('treatment_supporter_id.error').html('Please assign Treatment Supporter to this patient first.').show();
                valid=false;                
            }
            else{
                getField('treatment_supporter_id.error').html('').hide(); 
            }
		
			if(valid==false){
				return false;
            }
			else {
				getField("treatment_supporter_id.value").prop('disabled', false);
			
				<ifMode mode='EDIT' include="false">  
					getPatientAndSavePersonTreatmentSupporterAttribute("");
					getPatientAndSavePersonTreatmentCoordinatorAttribute("");
				</ifMode>
	
				var timeTakenDiv = $j("#time_taken_div");
		
				var endDate = new Date();
				var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
				var diffSec = timeDiff/1000;
				
				timeTakenDiv.show();
				setValue("time_taken.value",diffSec);
				timeTakenDiv.hide();

                return true;
            }			
		});

		function getPatientAndSavePersonTreatmentSupporterAttribute(treatmentSupporterName){
				
			var patientId =  '<lookup expression="patient.getPatientIdentifier(3)"/>';
		
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/patient?q=" + patientId + "",
					dataType: 'json'
					}).done(function(data ) {                                      
						console.log("patient display : " + data.results[0]['display']);
						console.log("patient uuid : " + data.results[0]['uuid']);
						patientUuid = data.results[0]['uuid'];
						savePersonTreatmentSupporterAttribute(patientUuid,treatmentSupporterName );
				
				});
		}
	
		function savePersonTreatmentSupporterAttribute(patientUuid, personAttribute) {
			
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/person/" + patientUuid + "/attribute?",
                    processData: false,
                    type: "POST",
					data: JSON.stringify({"attributeType":"f083e422-b1e9-4951-8bc9-95c2992a6a72","value": personAttribute}),
                    contentType: "application/json"
					
					}).done(function(data ) {
                
						console.log(data['display']);
						
				});
		}
		
		function getPatientAndSavePersonTreatmentCoordinatorAttribute(treatmentCoordinatorName){
				
			var patientId =  '<lookup expression="patient.getPatientIdentifier(3)"/>';
		
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/patient?q=" + patientId + "",
					dataType: 'json'
					}).done(function(data ) {                                      
						console.log("patient display : " + data.results[0]['display']);
						console.log("patient uuid : " + data.results[0]['uuid']);
						patientUuid = data.results[0]['uuid'];
						savePersonTreatmentCoordinatorAttribute(patientUuid,treatmentCoordinatorName );
				
				});
		}
	
		function savePersonTreatmentCoordinatorAttribute(patientUuid, personAttribute) {
			
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/person/" + patientUuid + "/attribute?",
                    processData: false,
                    type: "POST",
					data: JSON.stringify({"attributeType":"03ae5e95-c8a6-439c-b1cf-9cc0ac38f607","value": personAttribute}),
                    contentType: "application/json"
					
					}).done(function(data ) {
                
						console.log(data['display']);
						
				});
		}
	
    </script>

</htmlform>