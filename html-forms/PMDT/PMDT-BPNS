<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PMDT-Brief Peripheral Neuropathy Screen (v0.0.1)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="2"  tags="PMDT" /></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Brief Peripheral Neuropathy Screen (BPNS)">
		<div>	
		
			<p>
			Date of assessment
			<br/>
			<obs id="date_assessment" conceptId="165469" defaultValue="today" required="true"/>
			</p>

			<p>
			Type of assessment
			<br/>
			<obs id="assessment_type" conceptId="165103" answerConceptIds="165348,165035,165039,165040,165036,165041,165042" 
			answerLabels="Baseline Assessment,Treatment initiation,Two week assessment,Planned monthly assessment,Other assessment,End of treatment assessment,Post-treatment assessment" 
			defaultValue="165348" required="true"/>
			</p>

			<div id="display_other_assessment">
			<p>
			Other assessment reason
			<br/>
			<obs id="other_assessment" conceptId="165036" maxlength="100" />
			</p>
			</div>
			
			<div id="display_followup_month">
			<p>
			Month of treatment
			<br/>
			<obs id="followup_month" conceptId="164327" />
			</p>
			</div>

			<p>
			BPNS: LEFT Pain, aching, or burning in feet, legs
			<br/>
			<obs id="bpns_left_pain" conceptId="164944" answerConceptIds="1115,164964,164966,164968,164969,165763,164938,164939,164940,164941,164942,1118" 
			answerLabels="Normal,1,2,3,4,5,6,7,8,9,10,Not done" defaultValue="1118" required="true"/>
			</p>

			<p>
			BPNS: RIGHT Pain, aching, or burning in feet, legs
			<br/>
			<obs id="bpns_right_pain" conceptId="164945" answerConceptIds="1115,164964,164966,164968,164969,165763,164938,164939,164940,164941,164942,1118" 
			answerLabels="Normal,1,2,3,4,5,6,7,8,9,10,Not done" defaultValue="1118" required="true"/>
			</p>

			<p>
			BPNS: LEFT Pins and needles in feet, legs
			<br/>
			<obs id="bpns_left_needles" conceptId="164946" answerConceptIds="1115,164964,164966,164968,164969,165763,164938,164939,164940,164941,164942,1118"
			answerLabels="Normal,1,2,3,4,5,6,7,8,9,10,Not done" defaultValue="1118" required="true"/>
			</p>

			<p>
			BPNS: RIGHT Pins and needles in feet, legs
			<br/>
			<obs id="bpns_right_needles" conceptId="164948" answerConceptIds="1115,164964,164966,164968,164969,165763,164938,164939,164940,164941,164942,1118"
			answerLabels="Normal,1,2,3,4,5,6,7,8,9,10,Not done" defaultValue="1118" required="true"/>
			</p>

			<p>
			BPNS: LEFT Numbness (lack of feeling) in feet, legs
			<br/>
			<obs id="bpns_left_numbness" conceptId="164951" answerConceptIds="1115,164964,164966,164968,164969,165763,164938,164939,164940,164941,164942,1118"
			answerLabels="Normal,1,2,3,4,5,6,7,8,9,10,Not done" defaultValue="1118" required="true"/>
			</p>

			<p>
			BPNS: RIGHT Numbness (lack of feeling) in feet, legs
			<br/>
			<obs id="bpns_right_numbness" conceptId="164952" answerConceptIds="1115,164964,164966,164968,164969,165763,164938,164939,164940,164941,164942,1118" 
			answerLabels="Normal,1,2,3,4,5,6,7,8,9,10,Not done" defaultValue="1118" required="true"/>
			</p>

			<p>
			BPNS: vibration perception LEFT
			<br/>
			<obs id="bpns_left_vibration" conceptId="164959" answerConceptIds="164954,164955,164956,164957,164958" 
			answerLabels="Felt &gt;10 seconds,Felt 6-10 seconds,Felt &lt;5 seconds,Not felt,Unable to or did not assess" defaultValue="164958" required="true"/>
			</p>

			<p>
			BPNS: vibration perception RIGHT
			<br/>
			<obs id="bpns_right_vibration" conceptId="164960" answerConceptIds="164954,164955,164956,164957,164958" 
			answerLabels="Felt  &gt;10 seconds,Felt 6-10 seconds,Felt &lt;5 seconds,Not felt,Unable to or did not assess" defaultValue="164958" required="true"/>
			</p>

			<p>
			BPNS: ankle reflexes LEFT
			<br/>
			<obs id="bpns_left_ankle" conceptId="164971" answerConceptIds="163747,164963,1115,164967,145040,164958" 
			answerLabels="Absent,Hypoactive,Normal,Hyperactive,Clonus,Unable to or did not assess" defaultValue="164958" required="true"/>
			</p>

			<p>
			BPNS: ankle reflexes RIGHT
			<br/>
			<obs id="bpns_right_ankle" conceptId="164972" answerConceptIds="163747,164963,1115,164967,145040,164958" 
			answerLabels="Absent,Hypoactive,Normal,Hyperactive,Clonus,Unable to or did not assess" defaultValue="164958" required="true"/>
			</p>
			
			<div id="time_taken_div">
			<p> 
			Time taken to fill form
			<br/>
			<obs id="time_taken" conceptId="165044" />
			</p>
			</div>
		</div>
	</section>

	<submit/>
	
	<script type="text/javascript">
		var startDate = new Date();	
	
	    var other_assessment = jQuery("#display_other_assessment");
		var followup_month = jQuery("#display_followup_month");
		

 
jQuery( document ).ready(function() {

		var timeTakenDiv = jQuery("#time_taken_div");
		timeTakenDiv.hide();
		getField("followup_month.value").prop("disabled", true);
		
		<ifMode mode='VIEW' include="false"> 
					 		
		if(getValue('assessment_type.value') == 165036 ){
			other_assessment.show();
		}
		else{
			other_assessment.hide();					
		}
		
		if(getValue('assessment_type.value') == 165040 ){
			if(! isRegistrationFormFilled() ){
				alert("Please fill PMDT-Treatment Registration Form first ");
			}
			else{
				setValue('followup_month.value',getFollowupMonth());
				followup_month.show();
			}
		}
		else{
			followup_month.hide();							
		}

		</ifMode> 
		
		});

function isRegistrationFormFilled(){
		var isFilled=true;
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('f2038177-d0ee-4856-ab41-2b9bad0e949e'))  $fn.getObs($encounter, '164412').getValueAsString($!{locale}) #end"/>";		
		var registrationDateResult = latestEncounter.replace(/\s\s+/g, '@');
        var registrationDateResultArray = registrationDateResult.split('@');
		var registrationDate = registrationDateResultArray[registrationDateResultArray.length-1];
		
		if( registrationDate==null || registrationDate=='' ){
			isFilled=false;
		}
		return isFilled;
}

function getFollowupMonth(){		
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('f2038177-d0ee-4856-ab41-2b9bad0e949e'))  $fn.getObs($encounter, '164412').getValueAsString($!{locale}) #end"/>";		
		var registrationDateResult = latestEncounter.replace(/\s\s+/g, '@');
        var registrationDateResultArray = registrationDateResult.split('@');
		var registrationDate = registrationDateResultArray[registrationDateResultArray.length-1];
		
		var assessmentDate=getValue('date_assessment.value') ;		   
		
		var date1 = new Date(registrationDate);
		var date2 = new Date(assessmentDate);
		var timeDiff = date2.getTime() - date1.getTime();
		var diffDays = Math.floor(timeDiff / (1000 * 3600 * 24));
        var followupMonth=Math.floor(diffDays/30);
		return followupMonth;
}

jQuery(function() {
			getField('assessment_type.value').change(function() {
				
				if(getValue('assessment_type.value') == 165036 ){
					other_assessment.show();
				}
				else{
					setValue('other_assessment.value', "");  
					other_assessment.hide();				
				}
				
				if(getValue('assessment_type.value') == 165040 ){
					if(! isRegistrationFormFilled() ){
						alert("Please fill PMDT-Treatment Registration Form first ");
					}
					else{//set followup month acc to calculation
						setValue('followup_month.value',getFollowupMonth());						
					}
					followup_month.show();
					
				}
				else{
					setValue('followup_month.value', "");  
					followup_month.hide();					
				}
			});

			getField('date_assessment.value').change(function() {	
				
				if(!isRegistrationFormFilled()) {
					if(getValue('assessment_type.value') == 165040 ){
						alert("Please fill Treatment Registration Form first");
					}
				}
				else{
					//set followup month acc to calculation
					setValue('followup_month.value',getFollowupMonth());
				}				
			
				
			});	

});
		
beforeSubmit.push(function() {

	setValue('other_assessment.error','');
	setValue('followup_month.error','');
	

	var valid=true;
	
	if(getValue('assessment_type.value') == 165036 &amp;&amp; (getValue('other_assessment.value') =='' ) ){	
		getField('other_assessment.error').html('Please input a value.').show();
		valid=false;		
	}
	else{
		getField('other_assessment.error').html('').hide();
	}

	if( getValue('assessment_type.value') == 165040 &amp;&amp; getValue('date_assessment.value') != '') {
	
		if(! isRegistrationFormFilled() ){
			getField('followup_month.error').html('Please fill PMDT-Treatment Registration Form first').show();
			valid = false;
		}
		
		else if(getValue('followup_month.value') &lt; 0) {
			getField('followup_month.error').html('Please select correct assessment date. Follow-up Month Date should be after Treatment registration.').show();
			valid = false;
		}
		else if(getValue('followup_month.value') &gt; 24) {
			getField('followup_month.error').html('Follow-up Month can not be greater than 24. Please select correct assessment date').show();
			valid = false;
		}
		else {
			getField('followup_month.error').html('').hide();
		}
	
	}
	
	if( getValue('assessment_type.value') != 165040 ){
		setValue('followup_month.value',"");
	}
	
	if(valid==true){

		getField("followup_month.value").prop("disabled", false);
		
		var timeTakenDiv = $j("#time_taken_div");
		
		var endDate = new Date();
		var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
		var diffSec = timeDiff/1000;
		
		timeTakenDiv.show();
		setValue("time_taken.value",diffSec);
		timeTakenDiv.hide();
	
		return true;
}
	return false;
});
		
</script>
</htmlform>