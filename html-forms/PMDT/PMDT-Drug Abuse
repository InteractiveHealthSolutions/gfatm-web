<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PMDT-Drug Abuse (v0.1.1)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="2"  tags="PMDT" /></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Drug Abuse">
		<div>	

			<p>
			How many drugs/substances
			<br/>
			<obs id="drugs_count" conceptId="166089" maxlength="2" required="true"/>
			</p>
			
			<div id="repeat_container">
			<repeat>
			<template>
		 
			<div id="{n}-toggleContainer" class="{n}-toggleContainer"   >
			<b><label>{n}-Drugs/Substances details</label></b> <br/>
			<obsgroup groupingConceptId="166090">
				<p>
				Which drugs/substances
				<br/>
				<obs id="{n}-type_non_injectable_drugs" class="drugs_substances" conceptId="165562" answerConceptIds="165563,164690,164691,164692,164693,164694,77443,81092,164685,164696,79665,164697,164698,164699,73650,70468,164770" 
				answerLabels="Cigarette smoking,Gutka (crushed areca nut&amp;comma; tobacco&amp;comma;  catechu&amp;comma; paraffin wax&amp;comma; calcium hydroxide),Tobacco snuff (Naswar),Liquid cannabis (Bhang),Hashish cannabis (Charas),Marijuana (ghanja),Heroin,Opium (Afeem),Ecstasy (Methylenedioxymethamphetamine),Liquid ecstasy (Gamma-hydroxybutyrate),Chalk (Methamphetamine),Hookah (shisha tobacco),Paan (betel leaf with or without tobacco),Glue sniffing (polychloropene),Cocaine,Alcohol,Other" 
				defaultValue="164690" />
				</p>

				<div id="{n}-display_non_injectable_drug_other">
				<p>
				If other, then specify:
				<br/>
				<obs id="{n}-non_injectable_drug_other" conceptId="164770" maxlength="25" />
				</p>
				</div>

				<p>
				Quantity per week
				<br/>
				<obs id="{n}-present_drug_abuse_quantity" conceptId="165564" maxlength="25"/>
				</p>

				<p>
				Duration
				<br/>
				<obs id="{n}-present_drug_abuse_duration" class="duration"  conceptId="165565" maxlength="2"/>
				</p>

				<div id="{n}-display_duration_unit">
				<p>
				Duration unit
				<br/>
				<obs id="{n}-duration_unit" conceptId="1732" answerConceptIds="1072,1073,1074,1734" answerLabels="Days,Weeks,Months,Years" defaultValue="1074" />
				</p>
				</div>
				 
			</obsgroup>
				
				<br/>
				<label>---------------------------------------------------------------------------------------------------</label>
			</div>
			</template>
			<render n="1" />
			<render n="2" />
			<render n="3" />
			<render n="4" />
			<render n="5" />
			<render n="6" />
			<render n="7" />
			<render n="8" />
			<render n="9" />
			<render n="10" />
			</repeat>
			</div>

			<p>
			Drug abuse currently or in the past?
			<br/>
			<obs id="drug_abuse_history" conceptId="158304" answerConceptIds="163748,166084" answerLabels="Present,Past" defaultValue="166084"/>
			</p>

			<p>
			Initial Age of substance abuse (years)
			<br/>
			<obs id="past_drug_abuse_age" conceptId="165566" maxlength="2"/>
			</p>

		
			<div id="time_taken_div">
			<p> 
			Time taken to fill form
			<br/>
			<obs id="time_taken" conceptId="165044" />
			</p>
			</div>
		</div>
	</section>

	<submit/>
	
	<script type="text/javascript">
		var startDate = new Date();	

		var repeat_container =jQuery("#repeat_container");
		var repeatLimit=11;
 
jQuery( document ).ready(function() {
		
		var timeTakenDiv = jQuery("#time_taken_div");
		timeTakenDiv.hide();
		
		///////////////////////////////////////////////////////////////////////////////////////////////////////
		//repeat logic start
		
		<ifMode mode='EDIT' include="true"> 
			for(var i=1; i &lt; repeatLimit; i++ ){
				//show/hide fields to acc to values
				durationChange(i+"-");
				drugsSubstancesChange(i+"-");
			}
		</ifMode>
		<ifMode mode='VIEW' include="false"> 							 		
			if(getValue('drugs_count.value') > 0 ){
				repeat_container.show();
			}			
			else{
				repeat_container.hide();
			}
		</ifMode> 
		
		<ifMode mode='ENTER' include="true"> 					
			//show 1st repeat box and hide all others in enter mode as values are not retrived 
			for(var i=2; i &lt; repeatLimit; i++ ){
				jQuery("#"+i+"-toggleContainer").toggle(false);
			}			
		</ifMode>
		
		<ifMode mode='EDIT' include="true"> 				
			
			//show and hide repeat boxes acc to values as values are retrived during EDIT mode
			for(var i=1; i &lt; repeatLimit; i++ ){
				if( getValue((i)+'-type_non_injectable_drugs.value') == "" ){
					jQuery("#"+i+"-toggleContainer").toggle(false);
				}
				else{
					jQuery("#"+i+"-toggleContainer").toggle(true);
				}
			}  
		</ifMode>
		
		<ifMode mode='View' include="true">
			//show and hide repeat boxes acc to values 		
			for(var i=1; i &lt; repeatLimit; i++ ){
				if(jQuery("#"+i+'-type_non_injectable_drugs > span ').hasClass('value'))
				{
					jQuery("#"+i+"-toggleContainer").toggle(true);
				}
				else{
					jQuery("#"+i+"-toggleContainer").toggle(false);
				}
				jQuery("#"+1+"-toggleContainer").toggle(true);// visible only first in view mode
			}			
		</ifMode>
		
		});

<ifMode mode='VIEW' include="false">


	//hide and show duration based on entered value		
	$j(document).ready(function(){
      $j('.duration').change(function() {
				durationChange(this.id);
     });
	});
	
	function durationChange(idNo){
		var res = idNo.split("-");
		var n=res[0];
		
		if(getValue(n+'-present_drug_abuse_duration.value') != "" ){
			jQuery("#"+n+"-display_duration_unit").show();
		}
		else{		
			setValue(n+'-duration_unit.value', 1074);  
			jQuery("#"+n+"-display_duration_unit").hide();				
		}
	}	
	
	//hide and show other based on selection		
	$j(document).ready(function(){
      $j('.drugs_substances').change(function() {
				drugsSubstancesChange(this.id);
     });
	});
	
	function drugsSubstancesChange(idNo){
		var res = idNo.split("-");
		var n=res[0];
		
		if(getValue(n+'-type_non_injectable_drugs.value') == 164770 ){
			jQuery("#"+n+"-display_non_injectable_drug_other").show();
		  }
		else{
			setValue(n+'-non_injectable_drug_other.value', "");  
			jQuery("#"+n+"-display_non_injectable_drug_other").hide();				
		  }
	}
	
</ifMode>
	//repeat logic end
	//////////////////////////////////////////////////////////////////////////////////////////////////////////		
	
jQuery(function() {
		
			//repeat logic start
			///////////////////////////////////////////////////////////////////////////
			getField('drugs_count.value').change(function() {	
				var count= parseInt(getValue('drugs_count.value'));
				
				if(count &gt; 0 &amp;&amp; count &lt; 11  ){
				
					//hide repeat boxes above count 
					for(var j=(count+1); j &lt; repeatLimit; j++ ){
					//set values to empty
						setValue((j)+'-type_non_injectable_drugs.value','');
						setValue((j)+'-non_injectable_drug_other.value','');
						setValue((j)+'-present_drug_abuse_quantity.value','');
						setValue((j)+'-present_drug_abuse_duration.value','');
						setValue((j)+'-duration_unit.value','');
						//set values to acc to values
						durationChange(j+"-");
						drugsSubstancesChange(j+"-");
						jQuery("#"+j+"-toggleContainer").toggle(false);
					}
					//show repeat boxes acc to range
					for(var i=1; i &lt; (count+1); i++ ){
						//set values to acc to values
						durationChange(i+"-");
						drugsSubstancesChange(i+"-");
						jQuery("#"+i+"-toggleContainer").toggle(true);//
					}
					repeat_container.show();
				}
				//alert messages on out of range count
				else if(count &gt; 10 ){
					alert("please put value between 1-10");
				}
				//hide all boxes on not selecting count value or when count=0;
				else{
					for(var i=1; i &lt; repeatLimit; i++ ){
						//set values to empty
						setValue((i)+'-type_non_injectable_drugs.value','');
						setValue((i)+'-non_injectable_drug_other.value','');
						setValue((i)+'-present_drug_abuse_quantity.value','');
						setValue((i)+'-present_drug_abuse_duration.value','');
						setValue((i)+'-duration_unit.value','');
						durationChange(i+"-");
						drugsSubstancesChange(i+"-");
						jQuery("#"+i+"-toggleContainer").toggle(false);
					}
					repeat_container.hide();
				}
				
			});
			//repeat logic end
			//////////////////////////////////////////////////////////////////////////////

});
	
function checkIfAlreadySelected(myArray,value) {
	isAlreadyExit=false;
	for(var i=0; i &lt; myArray.length; i++ ){
		if(myArray[i]==value){
			isAlreadyExit=true;
		}
	}
	return isAlreadyExit;
}
 
beforeSubmit.push(function() {

	var valid=true;
	var drugSubstances = [];
	var drugSubstancesCount=0;
	setValue('past_drug_abuse_age.error','');
	
	///
	var drugs_count=getValue('drugs_count.value');

	if( drugs_count.trim() == ""  || getValue('drugs_count.value') == null)
	{
		getField('drugs_count.error').html('This field can not be empty').show();
		valid=false;
	}
	else if(!(drugs_count.match(/^\d+$/))){
		getField('drugs_count.error').html('Not an integer').show();
		valid=false;
	}
	else if( drugs_count &lt; 0  ){
        getField('drugs_count.error').html('Cannot be less than 0').show();
		valid=false;	
	}
	else if( drugs_count &gt; 10  ){
        getField('drugs_count.error').html('Cannot be gretaer than 10').show();
		valid=false;	
	}
	
	//
	
	
if(valid){	
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//repeat logic start
	for(var i=1; i &lt; repeatLimit; i++ ){
		setValue((i)+'-type_non_injectable_drugs.error','');
		setValue((i)+'-non_injectable_drug_other.error','');
		setValue((i)+'-present_drug_abuse_quantity.error','');
		setValue((i)+'-present_drug_abuse_duration.error','');
		setValue((i)+'-duration_unit.error','');

	}
	//empty all values on not selecting count value or when count=0;
	if( ! (getValue('drugs_count.value') > 0) ){
		for(var i=1; i &lt; repeatLimit; i++ ){
			//set values to empty
			setValue((i)+'-type_non_injectable_drugs.value','');
			setValue((i)+'-non_injectable_drug_other.value','');
			setValue((i)+'-present_drug_abuse_quantity.value','');
			setValue((i)+'-present_drug_abuse_duration.value','');
			setValue((i)+'-duration_unit.value','');
		}
	}
	
	//check validation on repeat boxes
	if(getValue('drugs_count.value') > 0) {
	 
		for(var i=1; i &lt; repeatLimit; i++ ){
			if(jQuery("#"+(i)+"-toggleContainer").is(":visible") &amp;&amp; getValue((i)+'-type_non_injectable_drugs.value') == "" ){
				getField((i)+'-type_non_injectable_drugs.error').html('Please select a value.').show();
				valid=false;
			}
			else {
				getField((i)+'-type_non_injectable_drugs.error').html('').hide();
			}
		}
		
		for(var i=1; i &lt; repeatLimit; i++ ){
			if( jQuery("#"+(i)+"-toggleContainer").is(":visible") &amp;&amp; getValue((i)+'-type_non_injectable_drugs.value') == 164770
			    &amp;&amp; getValue((i)+'-non_injectable_drug_other.value') == "" ){
				getField((i)+'-non_injectable_drug_other.error').html('Please input a value.').show();
				valid=false;
			}
			else {
				getField((i)+'-non_injectable_drug_other.error').html('').hide();
			}
		}
		
		for(var i=1; i &lt; repeatLimit; i++ ){
			var present_drug_abuse_quantity=getValue((i)+'-present_drug_abuse_quantity.value');
			if( ( present_drug_abuse_quantity == ""  || present_drug_abuse_quantity == null ) ){
			// do nothing as this field is not mandatory	
			}
			else if( jQuery("#"+(i)+"-toggleContainer").is(":visible") ){
				if(!(present_drug_abuse_quantity.match(/^\d+$/))){
					getField((i)+'-present_drug_abuse_quantity.error').html('Not an integer').show();
					valid=false;
				}
				else if( present_drug_abuse_quantity &lt; 1  ){
			        getField((i)+'-present_drug_abuse_quantity.error').html('Cannot be less than 1').show();
					valid=false;	
				}
				else if( present_drug_abuse_quantity &gt; 25 ){
			        getField((i)+'-present_drug_abuse_quantity.error').html('Cannot be greater than 25').show();
					valid=false;	
				}
			}
		}
		
		for(var i=1; i &lt; repeatLimit; i++ ){
			var present_drug_abuse_duration=getValue((i)+'-present_drug_abuse_duration.value');
			if( ( present_drug_abuse_duration == ""  || present_drug_abuse_duration == null ) ){
			// do nothing as this field is not mandatory	
			}
			else if (jQuery("#"+(i)+"-toggleContainer").is(":visible") ){
				if(!(present_drug_abuse_duration.match(/^\d+$/))){
					getField((i)+'-present_drug_abuse_duration.error').html('Not an integer').show();
					valid=false;
				}
				else if( present_drug_abuse_duration &lt; 1  ){
			        getField((i)+'-present_drug_abuse_duration.error').html('Cannot be less than 1').show();
					valid=false;	
				}
				else if( present_drug_abuse_duration &gt; 99 ){
			        getField((i)+'-present_drug_abuse_duration.error').html('Cannot be greater than 99').show();
					valid=false;	
				}
			}
		}
		
		for(var i=1; i &lt; repeatLimit; i++ ){
			var duration_unit=getValue((i)+'-duration_unit.value');
			if( getValue((i)+'-present_drug_abuse_duration.value') != ""  ){			
				if( duration_unit == "" &amp;&amp; jQuery("#"+(i)+"-toggleContainer").is(":visible")   )
				{
					getField((i)+'-duration_unit.error').html('Please Select a Value').show();
					valid=false;
				}
				else {
			        getField((i)+'-duration_unit.error').html('').hide();
				}			
			}
		}
	}
	
	//remove values from hidden boxes
	for(var i=1; i &lt; repeatLimit; i++ ){
		//set values to empty
		if( ! jQuery("#"+(i)+"-toggleContainer").is(":visible") ){
			//set values to empty
			setValue((i)+'-type_non_injectable_drugs.value','');
			setValue((i)+'-non_injectable_drug_other.value','');
			setValue((i)+'-present_drug_abuse_quantity.value','');
			setValue((i)+'-present_drug_abuse_duration.value','');
			setValue((i)+'-duration_unit.value','');
		}
	}
	
	//check if already selected drugsubstances is selected again
	if(getValue('drugs_count.value') &gt; 0) {
		for(var i=1; i &lt; repeatLimit; i++ ){
			if(jQuery("#"+(i)+"-toggleContainer").is(":visible") &amp;&amp; getValue((i)+'-type_non_injectable_drugs.value') != "" ){
				if(checkIfAlreadySelected(drugSubstances,getValue((i)+'-type_non_injectable_drugs.value'))){
					getField((i)+'-type_non_injectable_drugs.error').html('Please select another value. It is already selected.').show();
					valid=false;
				}
				//save value for future campare
				drugSubstances[drugSubstancesCount]= getValue((i)+'-type_non_injectable_drugs.value');
				drugSubstancesCount++;
			}
		}
	}
	
	
	
	//repeat logic end
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	var past_drug_abuse_age=getValue('past_drug_abuse_age.value');
    if(past_drug_abuse_age == ""  || getValue('past_drug_abuse_age.value') == null ){
	// do nothing as this field is not mandatory	
	}
	else{
		if(!(past_drug_abuse_age.match(/^\d+$/))){
			getField('past_drug_abuse_age.error').html('Not an integer').show();
			valid=false;
        }
        else if( past_drug_abuse_age &lt; 1  ){
	        getField('past_drug_abuse_age.error').html('Cannot be less than 1').show();
			valid=false;	
		}
        else if( past_drug_abuse_age &gt; 99 ){
	        getField('past_drug_abuse_age.error').html('Cannot be greater than 99').show();
			valid=false;	
		}
    }

	if(valid==true){
			for(var i=1; i &lt; repeatLimit; i++ ){
				//remove default values
				if(  getValue((i)+'-present_drug_abuse_duration.value')  == ""){
					setValue((i)+'-duration_unit.value',"");
				}
				if(  getValue((i)+'-type_non_injectable_drugs.value') != 164770 ){
					setValue((i)+'-non_injectable_drug_other.value',"");
				}
				
			}
			

			var timeTakenDiv = $j("#time_taken_div");
			
			var endDate = new Date();
			var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
			var diffSec = timeDiff/1000;
			
			timeTakenDiv.show();
			setValue("time_taken.value",diffSec);
			timeTakenDiv.hide();
		
			return true;
	}
}
	return false;
});
		
</script>
</htmlform>