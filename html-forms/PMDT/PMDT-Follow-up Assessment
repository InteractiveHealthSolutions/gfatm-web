<htmlform>
	<!-- Developed by Ali -->
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PMDT-Follow-up Assessment (v0.0.1)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation id="encounter_location" required="true" tags="PMDT" default="2"/></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider id="encounter_provider" default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Follow up Assessment - Clinical Form">
		<div>
			<p>
				Visit Date
                <br/>
				<obs conceptId="5096" id="return_visit_date" defaultValue="today" required="true" />
			</p>
			
			<p>
				Type of assessment
                <br/>
				<obs conceptId="165103" id="assessment_type" answerConceptIds="165039,165040,165041,165042,165036" required="true" answerLabels="Two Week Assessment, Planned Monthly Assessment , End of Treatment Assessment, Post-treatment Assessment, Other Assessment" />
			</p>
			
			<div id="other_assessment_type_div">
			<p>
				Other assessment type
                <br/>
				<obs conceptId="165036" id="other_assessment_type" maxlength="100"/>
			</p>
			</div>
			
			<div id="follow_up_month">
			<p>
				Month of treatment
                <br/>
				<obs conceptId="164327" id="treatment_month" maxlength="2"/>
			</p>
			</div>
			
			<div id="facility_treatment">
				<p>
                    Treatment Facility.
					 <br/>
                                    <select id="facility_list"><option>Please select location</option>			   
				    </select>
                                                                                  
					<obs conceptId="162724" id="treatment_facility" required="true"/>
 				</p>
			</div>
			
			<div id="other_treatment_facility_div">
			<p>
  			    Other treatment facility
                <br/>
				<obs conceptId="165697" id="other_treatment_facility" maxlength="100" />
			</p>
			</div>
			
			<p>
				Clinical status of patient
                <br/>
				<obs conceptId="166061" id="clinical_status" answerConceptIds="162677,166062,162679,1175" required="true" answerLabels="Improved, Worsened , Unchanged, Not Applicable"  defaultValue="162677"/>
			</p>
			
			<div id="patient_clinical_status_details">
			<p>
				If not improved, then specify (i.e. weight loss, loss of appetite)
                <br/>
				<obs conceptId="166063" id="clinical_status_details" maxlength="500" style="textarea"/>
			</p>
			</div>
			
			<p>
				Performance status (ECOG)
                <br/>
				<obs conceptId="165507" id="performance_status" answerConceptIds="165502,165503,165504,165505,165506" required="true" answerLabels="Fully active, Restricted , Ambulatory, Capable, Completely disabled"  defaultValue="165502"/>
			</p>
			
			<p>
				Performance status comment
                <br/>
				<obs conceptId="165508" id="performance_status_comment" maxlength="500" style="textarea"/>
			</p>
			
			<p>
				Has the patient DST Pattern changed?
                <br/>
				<obs conceptId="166064" id="dst_pattern_changed" required = "true" answerConceptIds="1065,1066" answerLabels="Yes, No"  defaultValue="1066"/>
			</p>
			 
			<div id="drug_resistance_profile_div">
            <p>
				Drug resistance profile
                <br/>
				<obs conceptId="165029" id="drug_resistance_profile" answerConceptIds="165026,165027,165028,1067" answerLabels="Profile Unconfirmed, Confirmed drug susceptible, Confirmed drug resistant TB, Unknown"  defaultValue="165028"/>
			</p>
			</div>
			
			<div id="subclassification_drug_resistant">
			<p>
				Subclassification for confirmed drug resistant cases
                <br/>
				<obs conceptId="165025" id="drug_resistant_profile_class" answerConceptIds="165009,165010,165011,165012,165014,165019,165020,165021,5622 " answerLabels="H(S) resistance, HE(S) resistance, R resistance with H susceptibility, GeneXpert RIF resistance only, Confirmed MDR, Confirmed pre-XDR (FQ), Confirmed pre-XDR (Inj), Confirmed XDR, Other"  defaultValue="165014"/>
			</p>
			</div>
			
			<p>
				Is the patient reporting a NEW Adverse Event?
                <br/>
				<obs conceptId="165128" id="new_adverse_event" answerConceptIds="1065, 1066 " answerLabels="Yes, No"  required = "true" defaultValue="1066"/>
			</p>
			
			<p>
				Expert panel review required?
                <br/>
				<obs conceptId="166065" id="expert_review_required" answerConceptIds="1065, 1066 " answerLabels="Yes, No"  required = "true" defaultValue="1066"/>
			</p>
			
			<p>
				Clinician notes
                <br/>
				<obs conceptId="164237" id="clinician_notes" maxlength="500" style="textarea"/>
			</p>
			
			<p>
				Next assessment date:
                <br/>
				<obs conceptId="165033" id="next_assessment_date" required = "true" allowFutureDates="true"/>
			</p>
			
			
			<p>
				Reason for next assessment
                <br/>
				<obs conceptId="165034" id="assessment_reason" answerConceptIds="165039,165040,165041,165042,165037" required="true" answerLabels="Two Week Assessment, Planned Monthly Assessment , End of Treatment Assessment, Post-treatment Assessment, Other assessment reason" defaultValue="165039"/>
			</p>
			
			<div id="other_assessment_reason_div">
			<p>
				Other assessment reason
                <br/>
				<obs conceptId="165037" id="other_assessment_reason" maxlength="100"/>
			</p>
			</div>
			
			<div id="time_taken_div">
			<p> 
			Time taken to fill form
			<br/>
			<obs id="time_taken" conceptId="165044" />
			</p>
			</div>
			
		</div>
	</section>

	<submit/>
	
	<script type="text/javascript">
	var startDate = new Date();
	var otherAssessmentDiv = jQuery("#other_assessment_type_div");
	var followUpMonthDiv = jQuery("#follow_up_month");
	var clinicalStatusDetailsDiv = jQuery("#patient_clinical_status_details");
	var drugResistanceProfileDiv = jQuery("#drug_resistance_profile_div");
	var subClassificationDiv = jQuery("#subclassification_drug_resistant");
	var otherAssessmentReasonDiv = jQuery("#other_assessment_reason_div");
	
	if(jQuery){
		jQuery(document).ready(function(){
			
			var timeTakenDiv = jQuery("#time_taken_div");
			timeTakenDiv.hide();
			
			doRest();
			getField('treatment_facility.value').change();
			getField("treatment_facility.value").prop('readonly',true);
			
			<ifMode mode='VIEW' include="false"> 
			
			
			if(getValue('assessment_type.value')== 165036){
                       
				otherAssessmentDiv.show();				 
			}
			else {
				setValue('other_assessment_type.value', "");
				otherAssessmentDiv.hide();
			}

			if(getValue('assessment_type.value')== 165040){
				if(!isRegistrationDone) {
					alert("Please fill Treatment Registration Form first ");
				}
				else {
				
					setValue('treatment_month.value',getFollowupMonth());
					getField("treatment_month.value").prop("disabled", true);
					followUpMonthDiv.show();
				}
			}
			else {
				
				followUpMonthDiv.hide();
			}
			
			if(getValue('clinical_status.value')== 166062){
                       
				   clinicalStatusDetailsDiv.show();
            }
			else {
				setValue('clinical_status_details.value', "");
				clinicalStatusDetailsDiv.hide();
			}
			
			if(getValue('dst_pattern_changed.value')== 1065){
                       
			   drugResistanceProfileDiv.show();
			}
			else {
				setValue('drug_resistance_profile.value', "");
				drugResistanceProfileDiv.hide();
			}
			
			if(getValue('drug_resistance_profile.value')== 165028){
				   subClassificationDiv.show();
			}
			else {
				setValue('drug_resistant_profile_class.value', "");
				subClassificationDiv.hide();
			}
			
			if(getValue('assessment_reason.value')== 165037){
				   otherAssessmentReasonDiv.show();
            }
			else {
				setValue('other_assessment_reason.value', "");
				otherAssessmentReasonDiv.hide();
			}
			
			</ifMode>			
		});
		
		function doRest(){
			jQuery.ajax({
				url: "/openmrs/ws/rest/v1/location?v=custom:(uuid,display,name,description)&amp;tag=PMDT",
				dataType: 'json'
				}).done(function(data ) {
					console.log(data.results[0].name);
					console.log(data.results.length);
					locationData = data;
					populate(data);
			});
		}
		
		function populate(data) {
								
			var s= document.getElementById('facility_list');
			
			for (i = 0; i &lt; data.results.length; i++) { 
				s.options[i+1]= new Option(data.results[i].description, data.results[i].name);                      
				var resultObject =  JSON.parse(JSON.stringify(data.results[i].description || null));
			}
		}
		
		function getFollowupMonth(){		
			var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('f2038177-d0ee-4856-ab41-2b9bad0e949e'))  $fn.getObs($encounter, '164412').getValueAsString($!{locale}) #end"/>";		
			var registrationDateResult = latestEncounter.replace(/\s\s+/g, '@');
			var registrationDateResultArray = registrationDateResult.split('@');
			var registrationDate = registrationDateResultArray[registrationDateResultArray.length-1];
			
			var visitDate=getValue('return_visit_date.value');
			
			var date1 = new Date(registrationDate);
			var date2 = new Date(visitDate);
			var timeDiff = date2.getTime() - date1.getTime();
			var diffDays = Math.floor(timeDiff / (1000 * 3600 * 24));
			var followupMonth=Math.floor(diffDays/30);
			
			return followupMonth;
		}
		
		function isRegistrationDone () {
			var isRegistered = true;
			
			var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('f2038177-d0ee-4856-ab41-2b9bad0e949e'))  $fn.getObs($encounter, '164412').getValueAsString($!{locale}) #end"/>";		
			var registrationDateResult = latestEncounter.replace(/\s\s+/g, '@');
			var registrationDateResultArray = registrationDateResult.split('@');
			var registrationDate = registrationDateResultArray[registrationDateResultArray.length-1];
			
			if( registrationDate==null || registrationDate=='' ){
				isRegistered = false;
			}
			return isRegistered;
		}
		
	}
	
	
	
	var otherFacilityDiv = $j("#other_treatment_facility_div");
		otherFacilityDiv.hide();
	
	jQuery(function() { 
	
			var facilities = document.getElementById("facility_list");
			facilities.onchange = function(){
				var e = document.getElementById("facility_list");
				var locationDescription = e.options[e.selectedIndex].text;
				var locationName = e.options[e.selectedIndex].value;
					
				setValue('treatment_facility.value',locationName );
				getField('treatment_facility.value').change();
											
			};
			
			getField('treatment_facility.value').change(function() {
				if(getValue('treatment_facility.value')=='OTHER'){
						   
					otherFacilityDiv.show();	
				}
				else {
					otherFacilityDiv.hide();
				}
			});
	});
	
	jQuery(function() {
	
		getField('assessment_type.value').change(function() {
                
				if(getValue('assessment_type.value')== 165036){
                       
				   otherAssessmentDiv.show();
				 
                }
				else {
					setValue('other_assessment_type.value', "");
					otherAssessmentDiv.hide();
				}

				if(getValue('assessment_type.value')== 165040){
					
					if(!isRegistrationDone) {
						alert("Please fill Treatment Registration Form first ");
					}
					else {
					
						setValue('treatment_month.value',getFollowupMonth());
						getField("treatment_month.value").prop("disabled", true);
						followUpMonthDiv.show();
					}
                }
				else {
					setValue('treatment_month.value', "");
					followUpMonthDiv.hide();
				}
		});
		
		getField('return_visit_date.value').change(function() {
                
				if(getValue('return_visit_date.value') != '' &amp;&amp; getValue('assessment_type.value')== 165040) {
					if(!isRegistrationDone) {
						alert("Please fill Treatment Registration Form first ");
					}
					else {
					
						setValue('treatment_month.value',getFollowupMonth());
						getField("treatment_month.value").prop("disabled", true);
						followUpMonthDiv.show();
					}
				}
				else {
					setValue('treatment_month.value', "");
				}
				
		});
		
		getField('clinical_status.value').change(function() {
                
				if(getValue('clinical_status.value')== 166062){
                       
				   clinicalStatusDetailsDiv.show();
                }
				else {
					setValue('clinical_status_details.value', "");
					clinicalStatusDetailsDiv.hide();
				}
		});
		
		getField('dst_pattern_changed.value').change(function() {
                
				if(getValue('dst_pattern_changed.value')== 1065){
                       
				   drugResistanceProfileDiv.show();
                }
				else {
					setValue('drug_resistance_profile.value', "");
					drugResistanceProfileDiv.hide();
				}
		});
		
		getField('drug_resistance_profile.value').change(function() {
                
				if(getValue('drug_resistance_profile.value')== 165028){
				   subClassificationDiv.show();
                }
				else {
					setValue('drug_resistant_profile_class.value', "");
					subClassificationDiv.hide();
				}
		});
		
		getField('assessment_reason.value').change(function() {
                
				if(getValue('assessment_reason.value')== 165037){
				   otherAssessmentReasonDiv.show();
                }
				else {
					setValue('other_assessment_reason.value', "");
					otherAssessmentReasonDiv.hide();
				}
		});
		
	});
	
	beforeSubmit.push(function() {
			setValue('treatment_month.error','');
			setValue('other_assessment_type.error','');
            setValue('clinical_status_details.error','');
			setValue('drug_resistance_profile.error','');
			setValue('drug_resistant_profile_class.error','');
			setValue('other_treatment_facility.error','');
			setValue('other_assessment_reason.error','');
			
			var valid=true;
			
			
			if( getValue('assessment_type.value') == 165040 &amp;&amp; getValue('return_visit_date.value') != '') {
				
				if(! isRegistrationDone() ){
					getField('treatment_month.error').html('Please fill PMDT-Treatment Registration Form first').show();
					valid = false;
				}
				
				else if(getValue('treatment_month.value') &lt; 0) {
					getField('treatment_month.error').html('Please select correct visit date. Follow-up Assessment should be after Treatment registration.').show();
					valid = false;
				}
				else if(getValue('treatment_month.value') &gt; 24) {
					getField('treatment_month.error').html('Follow up month can not be greater than 24. Please select correct visit date').show();
					valid = false;
				}
				else {
					getField('treatment_month.error').html('').hide();
				}
				
			}
			
			if(getValue('assessment_type.value')==165036 &amp;&amp; getValue('other_assessment_type.value')=='') {
				   getField('other_assessment_type.error').html('Please provide an input.').show();
				   valid=false;
				   
			}
			else {
				   getField('other_assessment_type.error').html('').hide();
			}
			      
			if(getValue('clinical_status.value')==166062 &amp;&amp; getValue('clinical_status_details.value')=='') {
				   getField('clinical_status_details.error').html('Please provide an input.').show();
				   valid=false;
			}
			else {
				   getField('clinical_status_details.error').html('').hide();
			}
			
			if(getValue('dst_pattern_changed.value')==1065 &amp;&amp; getValue('drug_resistance_profile.value')=='') {
				   getField('drug_resistance_profile.error').html('Please provide an input.').show();
				   valid=false;
			}
			else {
				   getField('drug_resistance_profile.error').html('').hide();
			}
			
			if(getValue('drug_resistance_profile.value')== 165028 &amp;&amp; getValue('drug_resistant_profile_class.value')=='') {
				   getField('drug_resistant_profile_class.error').html('Please provide an input.').show();
				   valid=false;
			}
			else {
				   getField('drug_resistant_profile_class.error').html('').hide();
			}
			
			if(getValue('assessment_reason.value')== 165037 &amp;&amp; getValue('other_assessment_reason.value')=='') {
				
				   getField('other_assessment_reason.error').html('Please provide an input.').show();
				   valid=false;
			}
			else {
				   getField('other_assessment_reason.error').html('').hide();
			}
			
			if(getValue('treatment_facility.value')!='') {
				if(getValue('treatment_facility.value')=='OTHER' &amp;&amp; getValue('other_treatment_facility.value')=='') {
					valid = false;
					getField('other_treatment_facility.error').html('Please provide an input.').show();
				}
				else {
					getField('other_treatment_facility.error').html('').hide();
				}
			}
			
			if(valid==true){
				
				getField("treatment_month.value").prop("disabled", false);
				
				var timeTakenDiv = $j("#time_taken_div");
				
				var endDate = new Date();
                var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
				var diffSec = timeDiff/1000;
				
				timeTakenDiv.show();
				setValue("time_taken.value",diffSec);
				timeTakenDiv.hide();
                return true;
			}
			else{
			  return false;
			}
			
	});
		
		
	</script>

<!-- END OF FORM

Simple examples to copy-and-paste. Full reference at http://wiki.openmrs.org/x/kg8z

SECTION
	<section headerLabel="\#. Title">
		Content
	</section>

NUMERIC OBSERVATION
	<obs conceptId="id-of-numeric-concept" labelText="Label before"/>

DATE OBSERVATION
	<obs conceptId="id-of-date-concept" labelText="Label before"/>

CODED OBSERVATION
(as a dropdown)
	<obs conceptId="id-of-coded-concept" labelText="Label before"/>
(as radio buttons)
	<obs conceptId="id-of-coded-concept" labelText="Label before" style="radio"/>
(as an autocomplete)
	<obs conceptId="id-of-coded-concept" labelText="Label before" style="autocomplete" answerClasses="Diagnosis"/>
(as a checkbox for a specific answer)
	<obs conceptId="id-of-coded-concept" labelText="Label before" answerConceptId="id-of-answer-concept" answerLabel="label for answer"/>
(as a dropdown with specific choices)
	<obs conceptId="id-of-coded-concept" labelText="Label before" answerConceptIds="concept-id-1,concept-id-2,concept-id-3" answerLabels="Label 1,Label 2, Label 3"/>


FREE TEXT OBSERVATION
(as a normal text field)
	<obs conceptId="id-of-text-concept" labelText="Label before"/>
(as a textarea)
	<obs conceptId="id-of-text-concept" labelText="Label before" rows="4" cols="80"/>
-->
</htmlform>