<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PMDT-House Hold TB History (v0.0.1)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="2"  tags="PMDT" /></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. House Hold TB History">
		<div>	
	
			<p>
			Family history of TB?
			<br/>
			<obs id="family_history_tb" conceptId="152460" answerConceptIds="1065,1066,1067" answerLabels="Yes,No,Unknown"  required="true"/>
			</p>
			
			<p>
			How many family members have TB History?
			<br/>
			<obs id="number_family_history_tb" conceptId="165557"/>
			</p>
			
			<div id="display_repeat_container">
			<repeat>
			<template>
		 
			<div id="{n}-toggleContainer" class="{n}-toggleContainer"   >
			<b><label>{n}-House Hold TB History details</label></b> <br/>
			<obsgroup groupingConceptId="166091">

			<p>
			Gender
			<br/>
			<obs id="{n}-gender_hh_member_tb" conceptId="165559" answerConceptIds="1534,1535" answerLabels="Male,Female" defaultValue="1534" />
			</p>

			<p>
			Relationship with patient
			<br/>
			<obs id="{n}-relationship" class="relationship" conceptId="1560" answerConceptIds="971,970,5617,160727,160728,160729,160730,164383,164384,160273,159772,164385,164386,159720,159684,164388,164387,163357,163358,974,975,163356,5620" 
			answerLabels="Father,Mother,Spouse,Son,Daughter,Brother,Sister,Nephew,Neice,Grandfather,Grandmother,Grandson,Granddaughter,Father in law,Mother in law,Daughter in law,Son in law,Brother in law,Sister in law,Uncle,Aunt,Cousin,Other"
			defaultValue="971" />
			</p>

			<div id="{n}-display_other_family_member">
			<p>
			If relationship 'other' , specify:
			<br/>
			<obs id="{n}-other_family_member" conceptId="5620" maxlength="25" />
			</p>
			</div>

			<p>
			Is taking treatment or has taken treatment?
			<br/>
			<obs id="{n}-treatment_hh_member_tb" class="treatment" conceptId="165560" answerConceptIds="1065,1066,1067" answerLabels="Yes,No,Unknown" defaultValue="1065"  />
			</p>
			
			<div id="{n}-display_treatment_hh_member_tb">
			<p>
			Outcome of last TB treatment
			<br/>
			<obs id="{n}-past_outcome_treatment" conceptId="164799" answerConceptIds="159791,1267,160034,159874,160031,164791,164792,160037" answerLabels="Cured,Completed,Died,Failed,Lost to follow-up,Not evaluated,Treatment adapted,Still on treatment"/>
			</p>
			
			<p>
			If yes, where?
			<br/>
				<select id="{n}-facility_list" onchange="facilityChange({n})">			   
				    </select>
			<obs id="{n}-facility_treatment" conceptId="162724" />
			</p>
			</div>

			<div id="{n}-display_facility_treatment_other">
			<p>
			If other, then specify:
			<br/>
			<obs id="{n}-facility_treatment_other" conceptId="165695" maxlength="50"/>
			</p>
			</div>
			
			</obsgroup>
				
				<br/>
				<label>---------------------------------------------------------------------------------------------------</label>
			</div>
			</template>
			<render n="1" />
			<render n="2" />
			<render n="3" />
			<render n="4" />
			<render n="5" />
			<render n="6" />
			<render n="7" />
			<render n="8" />
			<render n="9" />
			<render n="10" />
			</repeat>
			</div>
			
		</div>
	</section>
			
	<section headerLabel="2. Substance Abuse">
		<div>
			<p>
			Are you using any kind of non-prescribed drug/substance presently?
			<br/>
			<obs id="present_drug_abuse" conceptId="165561" answerConceptIds="1065,1066,1067,164106" answerLabels="Yes,No,Unknown,Refuse to answer" defaultValue="1066" required="true"/>
			</p>

			<div id="display_non_injectable_drugs">
			<p>
			If yes, then which drugs/substances
			<br/>
			<div id="display_non_injectable_drugs_child">
			<obsgroup  id="type_non_injectable_drugs" groupingConceptId="165562" >					
				<obs conceptId="165562" id="cigrate" answerConceptId= "165563" answerLabel="Cigarette smoking" defaultValue="165563" style="checkbox"  /><br/>						
				<obs conceptId="165562" id="gutka" answerConceptId= "164690" answerLabel="Gutka (crushed areca nut&amp;comma; tobacco&amp;comma;  catechu&amp;comma; paraffin wax&amp;comma; calcium hydroxide)" style="checkbox"   /><br/>					
				<obs conceptId="165562" id="tobacco" answerConceptId= "164691" answerLabel="Tobacco snuff (Naswar)" style="checkbox" /><br/>					 
				<obs conceptId="165562" id="liquid" answerConceptId= "164692" answerLabel="Liquid cannabis (Bhang)" style="checkbox" /><br/>
				<obs conceptId="165562" id="hashish" answerConceptId= "164693" answerLabel="Hashish cannabis (Charas)" style="checkbox"  /><br/>						
				<obs conceptId="165562" id="ghanja" answerConceptId= "164694" answerLabel="Marijuana (ghanja)" style="checkbox"   /><br/>					
				<obs conceptId="165562" id="heroin" answerConceptId= "77443" answerLabel="Heroin" style="checkbox" /><br/>					 
				<obs conceptId="165562" id="afeem" answerConceptId= "81092" answerLabel="Opium (Afeem)" style="checkbox" /><br/>
				<obs conceptId="165562" id="ecstasy" answerConceptId= "164685" answerLabel="Ecstasy (Methylenedioxymethamphetamine)" style="checkbox" /><br/>
				<obs conceptId="165562" id="gamma" answerConceptId= "164696" answerLabel="Liquid ecstasy (Gamma-hydroxybutyrate)" style="checkbox"  /><br/>						
				<obs conceptId="165562" id="chalk" answerConceptId= "79665" answerLabel="Chalk (Methamphetamine)" style="checkbox"   /><br/>					
				<obs conceptId="165562" id="hookah" answerConceptId= "164697" answerLabel="Hookah (shisha tobacco)" style="checkbox" /><br/>					 
				<obs conceptId="165562" id="paan" answerConceptId= "164698" answerLabel="Paan (betel leaf with or without tobacco)" style="checkbox" /><br/>		
				<obs conceptId="165562" id="glue" answerConceptId= "164699" answerLabel="Glue sniffing (polychloropene)" style="checkbox"  /><br/>						
				<obs conceptId="165562" id="cocaine" answerConceptId= "73650" answerLabel="Cocaine" style="checkbox"   /><br/>					
				<obs conceptId="165562" id="alcohol" answerConceptId= "70468" answerLabel="Alcohol" style="checkbox" /><br/>					 
				<obs conceptId="165562" id="other" answerConceptId= "164770" answerLabel="Other" style="checkbox" /><br/>	 		
			</obsgroup>	
			</div>
			</p>
			</div>

			<div id="display_non_injectable_drug_other">
			<p>
			If other, then specify:
			<br/>
			<obs id="non_injectable_drug_other" conceptId="164770" maxlength="25" />
			</p>
			</div>
				
			<div id="time_taken_div">
			<p> 
			Time taken to fill form
			<br/>
			<obs id="time_taken" conceptId="165044" />
			</p>
			</div>
		</div>
	</section>

	<submit/>
	
	<script type="text/javascript">
		var startDate = new Date();	
	
		var repeat_container = jQuery("#display_repeat_container");
	    var non_injectable_drug = jQuery("#display_non_injectable_drugs");
		var non_injectable_drug_other = jQuery("#display_non_injectable_drug_other");
		var type_non_injectable_drugs_check = false;
		
		var repeatLimit=11;

jQuery( document ).ready(function() {

		var timeTakenDiv = jQuery("#time_taken_div");
		timeTakenDiv.hide();
		
		getField("family_history_tb.value").prop("disabled", true);
		getField("number_family_history_tb.value").prop("disabled", true);
		
		for(var i=1; i &lt; repeatLimit; i++ ){	
			getField((i)+"-facility_treatment.value").prop("disabled", true);
		}
		
		<ifMode mode='VIEW' include="false"> 
			doRest();
			
		if( ! isBaselineCouncelingFormFilled() ){
			alert("Please Fill PMDT-Baseline Counselling Form First");
			setValue('family_history_tb.value',"");	
			setValue('number_family_history_tb.value',"");
		}
		else{
			getDataFromBaselineCouncelingForm();
		}
				
		///substances check
		if(getValue('present_drug_abuse.value') ==1065 ){
			non_injectable_drug.show();
		}
		else{
			non_injectable_drug.hide();
			non_injectable_drug_other.hide();				
		}
		//
		

		</ifMode>
		
		///////////////////////////////////////////////////////////////////////////////////////////////////////
		//repeat logic start
		
		<ifMode mode='VIEW' include="false"> 					
			//show  repeat box acc to value of number_family_history_tb
			if(getValue('number_family_history_tb.value') &gt; 0 ){
				repeat_container.show();
			}			
			else{
				repeat_container.hide();
			}
			//show repeat box upto number_family_history_tb 
			for(var i=1; i &lt; ( parseInt( getValue('number_family_history_tb.value') ) +1 ); i++ ){
				jQuery("#"+i+"-toggleContainer").toggle(true);
			}
			//show repeat box above number_family_history_tb 
			for(var i=( parseInt( getValue('number_family_history_tb.value') ) +1 ); i &lt; repeatLimit ; i++ ){
				jQuery("#"+i+"-toggleContainer").toggle(false);
			}			
		</ifMode>
		
		<ifMode mode='View' include="true">
			//show and hide repeat boxes acc to values 		
			for(var i=1; i &lt; repeatLimit; i++ ){
				if(jQuery("#"+i+'-gender_hh_member_tb > span ').hasClass('value'))
				{
					jQuery("#"+i+"-toggleContainer").toggle(true);
				}
				else{
					jQuery("#"+i+"-toggleContainer").toggle(false);
				}
				jQuery("#"+1+"-toggleContainer").toggle(true);// visible only first in view mode
			}			
		</ifMode>
		
		<ifMode mode='VIEW' include="false"> 
			for(var i=1; i &lt; repeatLimit; i++ ){
				//show/hide fields to acc to values
				relationshipChange(i+"-");
				treatmentChange(i+"-");
			}
		</ifMode>
	
		
		});

<ifMode mode='VIEW' include="false">


	//hide and show relationship based on selected value		
	$j(document).ready(function(){
      $j('.relationship').change(function() {
				relationshipChange(this.id);
     });
	});
	
	function relationshipChange(idNo){
		var res = idNo.split("-");
		var n=res[0];
		
		if(getValue(n+'-relationship.value') == 5620 ){
			jQuery("#"+n+"-display_other_family_member").show();
		}
		else{		
			setValue(n+'-other_family_member.value', "");  
			jQuery("#"+n+"-display_other_family_member").hide();				
		}
	}	
	
	//hide and show other based on selection		
	$j(document).ready(function(){
      $j('.treatment').change(function() {
				treatmentChange(this.id);
     });
	});
	
	function treatmentChange(idNo){
		var res = idNo.split("-");
		var n=res[0];
		
		if(getValue(n+'-treatment_hh_member_tb.value') == 1065 ){
			jQuery("#"+n+"-display_treatment_hh_member_tb").show();
		  }
		else{
			setValue(n+'-past_outcome_treatment.value', "");  
			jQuery("#"+n+"-facility_list").val("");
			setValue(n+'-facility_treatment.value',"");  
			jQuery("#"+n+"-display_treatment_hh_member_tb").hide();				
		  }
		facilityTreatmentChange(n);
	}
	
	function facilityChange(n){
		setValue(n+'-facility_treatment.value',jQuery("#"+n+"-facility_list").val());  
		facilityTreatmentChange(n);		
	}
	
	function facilityTreatmentChange(n){
		if(getValue(n+'-facility_treatment.value') == "OTHER" ){
			jQuery("#"+n+"-display_facility_treatment_other").show();
		 }
		else{
			setValue(n+'-facility_treatment_other.value', "");  
			jQuery("#"+n+"-display_facility_treatment_other").hide();				
		 }
	}	

</ifMode>
	//repeat logic end
	//////////////////////////////////////////////////////////////////////////////////////////////////////////		
	
		
function isBaselineCouncelingFormFilled(){		
		var isFilled=true;
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('d84de31f-3dff-4aac-b92d-d1a77cfa66df'))  $fn.getObs($encounter, '152460').valueCoded #end"/>";		
		var familyHistoryTbResult = latestEncounter.replace(/\s\s+/g, '@');
        var familyHistoryTbResultArray = familyHistoryTbResult.split('@');
		var familyHistoryTb = familyHistoryTbResultArray[familyHistoryTbResultArray.length-1];
		
		if( familyHistoryTb==null || familyHistoryTb=='' ){
			isFilled=false;
		}
		return isFilled;
}

function getDataFromBaselineCouncelingForm(){		
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('d84de31f-3dff-4aac-b92d-d1a77cfa66df'))  $fn.getObs($encounter, '152460').valueCoded #end"/>";		
		var familyHistoryTbResult = latestEncounter.replace(/\s\s+/g, '@');
        var familyHistoryTbResultArray = familyHistoryTbResult.split('@');
		var familyHistoryTb = familyHistoryTbResultArray[familyHistoryTbResultArray.length-1];
		
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('d84de31f-3dff-4aac-b92d-d1a77cfa66df'))  $fn.getObs($encounter, '165557').getValueAsString($!{locale}) #end"/>";		
		var numberFamilyHistoryTbResult = latestEncounter.replace(/\s\s+/g, '@');
        var numberFamilyHistoryTbResultArray = numberFamilyHistoryTbResult.split('@');
		var numberFamilyHistoryTbString = numberFamilyHistoryTbResultArray[numberFamilyHistoryTbResultArray.length-1];
		
		var numberFamilyHistoryTb = parseInt(numberFamilyHistoryTbString.trim());
		
		setValue('family_history_tb.value',familyHistoryTb.trim());	
		
		if(isNaN(numberFamilyHistoryTb) || numberFamilyHistoryTb=="" || numberFamilyHistoryTb==null){
			setValue('number_family_history_tb.value',"");
		//donot save NAN value
			return 0;
		}
		else{
			setValue('number_family_history_tb.value',numberFamilyHistoryTb);
			return numberFamilyHistoryTb;
		}
		
		
}


		
		
function doRest(){
	jQuery.ajax({
		url: "/openmrs/ws/rest/v1/location?v=custom:(uuid,display,name,description)&amp;tag=PMDT",
		dataType: 'json'
		}).done(function(data ) {
			console.log(data.results[0].name);
			console.log(data.results.length);
			locationData = data;
			populate(data);
	});
}

function populate(data) {
	var facilityList =[] ;
	for(var i=1; i &lt; repeatLimit; i++ ){					
		facilityList[i]= document.getElementById((i)+'-facility_list');
	}
	for (i = 0; i &lt; data.results.length; i++) { 
		for(var j=1; j &lt; repeatLimit; j++ ){					
			facilityList[j].options[i+1]= new Option(data.results[i].description, data.results[i].name);
		}	
		var resultObject =  JSON.parse(JSON.stringify(data.results[i].description || null));
	}
}


function uncheckAllCheckBoxes(divName) {
	var divCompleteName = "#" + divName;
	$j(divCompleteName).find('input[type=checkbox]:checked').removeAttr('checked'); // Uncheck all the checkboxes
}

jQuery(":checkbox").click(function(){
	var $this = jQuery(this);
	var checkBoxId = jQuery(this).closest('span').attr('id')
								
	if($this.is(":checked") &amp;&amp; checkBoxId == "other") {
		non_injectable_drug_other.show();
	}
	else if(checkBoxId == "other"){
		non_injectable_drug_other.hide();
		setValue('non_injectable_drug_other.value', "");
	}
});



jQuery(function() {

		//substances
		getField('present_drug_abuse.value').change(function() {
			if(getValue('present_drug_abuse.value') ==1065 ){
				non_injectable_drug.show();
			}
			else{
				// uncheck all checkbox first
				uncheckAllCheckBoxes("display_non_injectable_drugs_child");
				non_injectable_drug.hide();
				setValue('non_injectable_drug_other.value', "");
				non_injectable_drug_other.hide();				
			}							
		});
		
});

		
beforeSubmit.push(function() {

	setValue('cigrate.error','');
	setValue('non_injectable_drug_other.error','');
	
	var valid=true;

	
	if(! isBaselineCouncelingFormFilled()){
		alert("Please Fill PMDT-Baseline Counselling Form First");
		valid=false;
	}

	/////////////////////////////checkbox valid checks for fields
	///
	if (jQuery("#display_non_injectable_drugs_child input[type=checkbox]:checked").length > 0)
	{
		non_injectable_drug_check = true;
	}
	else
	{
		non_injectable_drug_check = false;
	}

	if(getValue('present_drug_abuse.value')== 1065 &amp;&amp; 	non_injectable_drug_check == false) {
		   getField('cigrate.error').html('Please select a value.').show();
		   valid=false;   
	}
	else {
		   getField('cigrate.error').html('').hide();
	}
	//
	if(getValue('present_drug_abuse.value')== 1065 &amp;&amp; getField("other.value").prop('checked')== true &amp;&amp; getValue('non_injectable_drug_other.value')=='') {	
		   getField('non_injectable_drug_other.error').html('Please input a value.').show();
		   valid=false;	   
	}
	else {
		   getField('non_injectable_drug_other.error').html('').hide();
	}
	///////////////////	
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//repeat logic start
	for(var i=1; i &lt; repeatLimit; i++ ){
		setValue((i)+'-gender_hh_member_tb.error','');
		setValue((i)+'-relationship.error','');
		setValue((i)+'-other_family_member.error','');
		setValue((i)+'-treatment_hh_member_tb.error','');
		setValue((i)+'-past_outcome_treatment.error','');
		setValue((i)+'-facility_treatment.error','');
		setValue((i)+'-facility_treatment_other.error','');

	}
	 
	//empty all values when number_family_history_tb lt 0
	if( ! (getValue('number_family_history_tb.value') &gt; 0) ){
		for(var i=1; i &lt; repeatLimit; i++ ){
			//set values to empty
			setValue((i)+'-gender_hh_member_tb.value','');
			setValue((i)+'-relationship.value','');
			setValue((i)+'-other_family_member.value','');
			setValue((i)+'-treatment_hh_member_tb.value','');
			setValue((i)+'-past_outcome_treatment.value','');
			setValue((i)+'-facility_treatment.value','');
			setValue((i)+'-facility_treatment_other.value','');
		}
	}
	
	//check validation on repeat boxes when number_family_history_tb gt 0
	if(getValue('number_family_history_tb.value') &gt; 0) {
	 
		for(var i=1; i &lt; repeatLimit; i++ ){
			if(jQuery("#"+(i)+"-toggleContainer").is(":visible") &amp;&amp; getValue((i)+'-gender_hh_member_tb.value') == "" ){
				getField((i)+'-gender_hh_member_tb.error').html('Please select a value.').show();
				valid=false;
			}
			else {
				getField((i)+'-gender_hh_member_tb.error').html('').hide();
			}
		}
		
		for(var i=1; i &lt; repeatLimit; i++ ){
			if( jQuery("#"+(i)+"-toggleContainer").is(":visible") &amp;&amp; getValue((i)+'-relationship.value') == "" ){
				getField((i)+'-relationship.error').html('Please select a value.').show();
				valid=false;
			}
			else {
				getField((i)+'-relationship.error').html('').hide();
			}
		}
		
		for(var i=1; i &lt; repeatLimit; i++ ){
			if( jQuery("#"+(i)+"-toggleContainer").is(":visible") &amp;&amp; getValue((i)+'-relationship.value') == 5620
			    &amp;&amp; getValue((i)+'-other_family_member.value') == "" ){
				getField((i)+'-other_family_member.error').html('Please input a value.').show();
				valid=false;
			}
			else {
				getField((i)+'-other_family_member.error').html('').hide();
			}
		}

		for(var i=1; i &lt; repeatLimit; i++ ){
			if( jQuery("#"+(i)+"-toggleContainer").is(":visible") &amp;&amp; getValue((i)+'-treatment_hh_member_tb.value') == "" ){
				getField((i)+'-treatment_hh_member_tb.error').html('Please select a value.').show();
				valid=false;
			}
			else {
				getField((i)+'-treatment_hh_member_tb.error').html('').hide();
			}
		}
		
		for(var i=1; i &lt; repeatLimit; i++ ){
			if( jQuery("#"+(i)+"-toggleContainer").is(":visible") &amp;&amp; getValue((i)+'-treatment_hh_member_tb.value') == 1065
			    &amp;&amp; getValue((i)+'-facility_treatment.value') == "OTHER" &amp;&amp; getValue((i)+'-facility_treatment_other.value') == "" ){
				getField((i)+'-facility_treatment_other.error').html('Please input a value.').show();
				valid=false;
			}
			else {
				getField((i)+'-facility_treatment_other.error').html('').hide();
			}
		}
		
	}

	//remove values from hidden boxes
	for(var i=1; i &lt; repeatLimit; i++ ){
		//set values to empty
		if( ! jQuery("#"+(i)+"-toggleContainer").is(":visible") ){
			//set values to empty
			setValue((i)+'-gender_hh_member_tb.value','');
			setValue((i)+'-relationship.value','');
			setValue((i)+'-other_family_member.value','');
			setValue((i)+'-treatment_hh_member_tb.value','');
			setValue((i)+'-past_outcome_treatment.value','');
			setValue((i)+'-facility_treatment.value','');
			setValue((i)+'-facility_treatment_other.value','');
		}
	}
	
	//repeat logic end
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	
	
	
	if(valid==true){
		//enable before submit
		getField("family_history_tb.value").prop("disabled", false);
		getField("number_family_history_tb.value").prop("disabled", false);
		
		for(var i=1; i &lt; repeatLimit; i++ ){	
			getField((i)+"-facility_treatment.value").prop("disabled", false);
		}
		
		//remove default values
		if(getValue('present_drug_abuse.value') !=1065 ){
				// uncheck all checkbox first
				uncheckAllCheckBoxes("display_non_injectable_drugs_child");
				setValue('non_injectable_drug_other.value', "");				
		}	
	
		var timeTakenDiv = $j("#time_taken_div");
		
		var endDate = new Date();
		var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
		var diffSec = timeDiff/1000;
		
		timeTakenDiv.show();
		setValue("time_taken.value",diffSec);
		timeTakenDiv.hide();
	
		return true;
}
	return false;
});
		
</script>
</htmlform>