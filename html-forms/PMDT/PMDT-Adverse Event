<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PMDT-Adverse Event (v0.0.1)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="2"  tags="PMDT" /></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Adverse Event Form">
		<div>	

			<p>
			Date of Adverse Event onset
			<br/>
			<obs id="date_adverse_event_onset" conceptId="165198"  required="true"/>
			</p>

			<p>
			Adverse Event term:
			<br/>
			<obs id="adverse_events" conceptId="164295" answerConceptIds="165202,165203,165204,159570,165205,147241,117399,116214,114257,165206,117460,126656,165228,165229,165230,165231,138281,138264,138253,129113,138111,138086,165230,138061,138056,117341,138039,138031,136162,139075,123588,123188,138176,117321,654,149125,126660,165208,165209,165210,165211,156769,165212,120860,119108,113257,996,142412,111,118789,114382,122983,140501,140238,139084,116130,114403,165213,165214,130737,121629,162183,140484,165217,165218,165219,2,165220,165221,135849,142904,165223,165224,165225,165226,128331,165227,165232,165233,165234,165235,165236,165237,165238,5544,832,142630,115115,80,148432,121,165239,118789,165240,142039,165241,165242,6004,206,125166,165243,165244,121543,119537,113517,165245,148143,121849,145438,148048,139223,119209,134345,132419,146871,143264,122496,460,118536,165246,165247,165248,879,165249,165250,840,128340,164294"
				defaultValue="164294" required="true" size="100" style="autocomplete" maxlength="150" />
			</p>

			<div id="display_adverse_event_other">
			<p>
			If Adverse Event term 'Other', then specify:
			<br/>
			<obs id="adverse_event_other" conceptId="164294" maxlength="50" />
			</p>
			</div>

			<p>
			Adverse Event ID
			<br/>
			<obs id="adverse_event_id" conceptId="165200" maxlength="2" required="true"/>
			</p>
			
			<p><!-- //1 -->
			Adverse Event ID and term
			<br/>
			<obs conceptId="166075" id="adverse_event_id_term"  size="60" required="true" />
			</p>

			<p>
			Were any TB drug suspended due to this AE?
			<br/>
			<obs id="adverse_event_drug_suspend" conceptId="165201" answerConceptIds="1065,1066" answerLabels="Yes,No" defaultValue="1066" required="true" />
			</p>
			
			<div id="display_suspended_tb_drugs">
			<p>
			If Yes, which TB drugs suspended?
			<br/>
			<div id="display_suspended_tb_drugs_child">
				<obsgroup  id="suspended_tb_drugs" groupingConceptId="160021" >					
					<obs conceptId="160021" id="amikacin" answerConceptId= "71060" answerLabel="Amikacin" style="checkbox" value="true" /><br/>						
					<obs conceptId="160021" id="Amoxicillin_clavulanate" answerConceptId= "450" answerLabel="Amoxicillin and Clavulanate acid" style="checkbox" /><br/>					
					<obs conceptId="160021" id="Bedaquiline" answerConceptId= "163143" answerLabel="Bedaquiline" style="checkbox" /><br/>					 
					<obs conceptId="160021" id="Capreomycin" answerConceptId= "72794" answerLabel="Capreomycin" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Ciprofloxacin" answerConceptId= "73449" answerLabel="Ciprofloxacin" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Clarithromycin" answerConceptId= "73498" answerLabel="Clarithromycin" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Clofazimine" answerConceptId= "73581" answerLabel="Clofazimine" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Cycloserine" answerConceptId= "74123" answerLabel="Cycloserine" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Delamanid" answerConceptId= "163144" answerLabel="Delamanid" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Ethambutol" answerConceptId= "75948" answerLabel="Ethambutol" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Ethionamide" answerConceptId= "75976" answerLabel="Ethionamide" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Gatifloxacin" answerConceptId= "76835" answerLabel="Gatifloxacin" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Gemifloxacin" answerConceptId= "76862" answerLabel="Gemifloxacin" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="High_Dose_Isoniazid" answerConceptId= "164086" answerLabel="High Dose Isoniazid" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Imipenem_cilastatin" answerConceptId= "104315" answerLabel="Imipenem and cilastatin" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Isoniazid" answerConceptId= "78280" answerLabel="Isoniazid" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Kanamycin" answerConceptId= "78385" answerLabel="Kanamycin" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Levofloxacin" answerConceptId= "78788" answerLabel="Levofloxacin" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Linezolid" answerConceptId= "78879" answerLabel="Linezolid" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Meropenem" answerConceptId= "79611" answerLabel="Meropenem" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Moxifloxacin" answerConceptId= "80133" answerLabel="Moxifloxacin" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Nalidixic_acid" answerConceptId= "80363" answerLabel="Nalidixic Acid" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Norfloxacin" answerConceptId= "80792" answerLabel="Norfloxacin" style="checkbox" /><br/>							 
					<obs conceptId="160021" id="Ofloxacin" answerConceptId= "81022" answerLabel="Ofloxacin" style="checkbox" /><br/>							 
					<obs conceptId="160021" id="PAS" answerConceptId= "81457" answerLabel="P-Aminosalicylic Acid" style="checkbox" /><br/>					 
					<obs conceptId="160021" id="PAS_Monosodium" answerConceptId= "81458" answerLabel="P-Aminosalicylic Acid Monosodium" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Prothionamide" answerConceptId= "82772" answerLabel="Prothionamide" style="checkbox" /><br/>								 
					<obs conceptId="160021" id="Pyrazinamide" answerConceptId= "82900" answerLabel="Pyrazinamide" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Pyridoxine" answerConceptId= "82912" answerLabel="Pyridoxine" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Rifabutin" answerConceptId= "83352" answerLabel="Rifabutin" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Rifampicin" answerConceptId= "767" answerLabel="Rifampicin" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Rifapentine" answerConceptId= "83360" answerLabel="Rifapentine" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Sparfloxacin" answerConceptId= "84206" answerLabel="Sparfloxacin" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Streptomycin" answerConceptId= "84360" answerLabel="Streptomycin" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Terizidone" answerConceptId= "84836" answerLabel="Terizidone" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Thioacetazone" answerConceptId= "160019" answerLabel="Thioacetazone" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="Viomycin" answerConceptId= "160020" answerLabel="Viomycin" style="checkbox" /><br/>						 
					<obs conceptId="160021" id="other_tb_drug" answerConceptId= "164805" answerLabel="OTHER TB DRUGS" style="checkbox" /><br/>                         						 
				</obsgroup>	
			</div>
			</p>
		    </div>
			
			<div id="display_suspended_tb_drugs_other">
			<p>
			If 'other' suspended tb drug, then specify:
			<br/>
			<obs id="tb_drugs_other" conceptId="164805" maxlength="100"/>
			</p>
			</div>

			<p>
			Adverse Event Severity (1 = Mild; 2 = Moderate; 3 = Severe; 4 = Life-threatening)
			<br/>
			<obs id="adverse_event_severity" conceptId="165275" answerConceptIds="164964,164966,164968,164969" answerLabels="1,2,3,4" defaultValue="164964" required="true"/>
			</p>

			<p>
			Report AE related test?
			<br/>
			<obs id="rep_ae_test" conceptId="166073" answerConceptIds="1065,1066" answerLabels="Yes,No" defaultValue="1066" required="true"/>
			</p>

			<p>
			Is this Adverse Event serious?
			<br/>
			<obs id="adverse_event_serious" conceptId="162867" answerConceptIds="1065,1066" answerLabels="Yes,No" defaultValue="1066" required="true"/>
			</p>

			<div id="display_adverse_event_serious_criterion">
			<p>
			If yes, then seriousness criterion:
			<br/>
			<obs id="adverse_event_serious_criterion" conceptId="162760" answerConceptIds="165318,165319,162693,165320,119975,165321" answerLabels="Hospitalization required / prolonged,Death,Life threatening,Persistent or significant disability / incapacity,Congenital abnormality,Otherwise medically important" defaultValue="165318"  />
			</p>
			</div>
		
			<div id="time_taken_div">
			<p> 
			Time taken to fill form
			<br/>
			<obs id="time_taken" conceptId="165044" />
			</p>
			</div>
		</div>
	</section>

	<submit/>
	
	<script type="text/javascript">
		var startDate = new Date();	
	
	    var adverse_event_other = jQuery("#display_adverse_event_other");
		var suspended_tb_drugs = jQuery("#display_suspended_tb_drugs");
		var suspended_tb_drugs_other = jQuery("#display_suspended_tb_drugs_other");
		var adverse_event_serious_criterion = jQuery("#display_adverse_event_serious_criterion");
		
		var suspended_tb_drugs_check=false;
		
		

jQuery( document ).ready(function() {

		jQuery("#w10").attr("size", "60");

		var timeTakenDiv = jQuery("#time_taken_div");
		timeTakenDiv.hide();
		
		getField("adverse_event_id.value").prop("disabled", true);
		//2
		getField("adverse_event_id_term.value").prop("disabled", true);
		//2
		
		<ifMode mode='ENTER'  >
		//generate new id for adverse event only when new form is created for first time
			setValue("adverse_event_id.value",getAdverseEventId());
			//3		
			//as default value is set
			var aETerm = getAdverseEventIdAndTerm("OTHER ADVERSE EVENT");
				
			if(aETerm=='not completed'){
				setValue("adverse_event_id_term.value",'');
				getField('adverse_event_id_term.error').html('Outcome of this Adverse Term is not completed yet.').show();
			}
			else if(aETerm!=''){
				setValue("adverse_event_id_term.value",aETerm);
				getField('adverse_event_id_term.error').html('').hide();
			}
			else{
				setValue("adverse_event_id_term.value",'');
				getField('adverse_event_id_term.error').html('Please select Correct Adverse Term.').show();
			}
			//
			//getField("adverse_event_id.value").prop("disabled", false);
			//getField("adverse_event_id.value").prop("disabled", true);
			//3
		</ifMode>
		
		<ifMode mode='VIEW' include="false"> 
		
		
				 				 		
		if(getValue('adverse_events.value') == "OTHER ADVERSE EVENT" ){
			adverse_event_other.show();
		}
		else{
			adverse_event_other.hide();					
		}
		
		if(getValue('adverse_event_drug_suspend.value') == 1065 ){
			suspended_tb_drugs.show();
			suspended_tb_drugs_other.show();
		}
		else{
			suspended_tb_drugs.hide();
			// uncheck all checkbox first
			uncheckAllCheckBoxes("display_suspended_tb_drugs_child");
			setValue('tb_drugs_other.value', ""); 
			suspended_tb_drugs_other.hide();
		}

		if(getValue('adverse_event_serious.value') == 1065 ){
			adverse_event_serious_criterion.show();
		}
		else{
			adverse_event_serious_criterion.hide();
		}		
		
		</ifMode>
		
		});

function uncheckAllCheckBoxes(divName) {
	var divCompleteName = "#" + divName;
	$j(divCompleteName).find('input[type=checkbox]:checked').removeAttr('checked'); // Uncheck all the checkboxes
}


function getAdverseEventId(){

		var adverseEventId;
		var allEncounters = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('77b4254d-afab-4b3a-aff3-584e79b2c1e5'))  $fn.getObs($encounter, '164295').getValueAsString($!{locale}) #end"/>";		
		var allEncountersDateResult = allEncounters.replace(/\s\s+/g, '@');
        var allEncountersResultArray = allEncountersDateResult.split('@');
		adverseEventId = allEncountersResultArray.length; 
		
		return adverseEventId;
} 
//5
function getAdverseEventIdAndTerm(adverseTerm){

		var adverseEventIdAndTerm;
		//if user has filled empty selection
		if(adverseTerm==''){
			adverseEventIdAndTerm='';
			return adverseEventIdAndTerm;
		}
		else{
		
			var completedAdverseEventOutcomeIdAndTerms = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('4e17094b-13f4-46c4-b6fa-bafe544be791'))  $fn.getObs($encounter, '166075').getValueAsString($!{locale}) #end"/>";		
			var completedAdverseEventOutcomeIdAndTermsResult = completedAdverseEventOutcomeIdAndTerms.replace(/\s\s+/g, '@');
			var completedAdverseEventOutcomeIdAndTermsResultArray = completedAdverseEventOutcomeIdAndTermsResult.split('@');
						
			var adverseEventOutcomeIdsAndTermsLength=[];
			var j=0;
			for(var i=0; i &lt; completedAdverseEventOutcomeIdAndTermsResultArray.length; i++ ){
				if(getAdverseTerm(completedAdverseEventOutcomeIdAndTermsResultArray[i]).trim()==adverseTerm.trim()){
						adverseEventOutcomeIdsAndTermsLength[j]=i;
						j++;
						console.log("out match "+getAdverseTerm(completedAdverseEventOutcomeIdAndTermsResultArray[i]).trim());
				}
			}
			var adverseEventOutcomeCount=adverseEventOutcomeIdsAndTermsLength.length;
			
			//now check and campare values b/w AE form and AE Outcome form
			var previousAdverseEventIdAndTerms = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('77b4254d-afab-4b3a-aff3-584e79b2c1e5'))  $fn.getObs($encounter, '166075').getValueAsString($!{locale}) #end"/>";		
			var previousAdverseEventIdAndTermsResult = previousAdverseEventIdAndTerms.replace(/\s\s+/g, '@');
			var previousAdverseEventIdAndTermsResultArray = previousAdverseEventIdAndTermsResult.split('@');

			var adverseEventIdsAndTermsLength=[];
			var l=0;
			
			for(var k=0; k &lt; previousAdverseEventIdAndTermsResultArray.length; k++ ){
				if(getAdverseTerm(previousAdverseEventIdAndTermsResultArray[k]).trim()==adverseTerm.trim()){
						adverseEventIdsAndTermsLength[l]=k;
						l++;
						console.log("adverse match "+getAdverseTerm(previousAdverseEventIdAndTermsResultArray[k]).trim());
				}
			}
			
			
			var adverseEventCount=adverseEventIdsAndTermsLength.length;
			//if adverseterm is not reported yet for this patient so return adverseEventIdAndTerm;
			if(adverseEventCount == 0){
				adverseEventIdAndTerm=adverseTerm;
				return getValue("adverse_event_id.value")+" - "+adverseEventIdAndTerm;				
			}
			else{
				//previous advertsterm completed
				if(adverseEventCount==adverseEventOutcomeCount){
					adverseEventIdAndTerm=adverseTerm;
					return getValue("adverse_event_id.value")+" - "+adverseEventIdAndTerm;	
				}
				//previous advertsterm not completed
				else{
					adverseEventIdAndTerm='not completed';
					console.log(adverseEventCount+"==:"+adverseEventOutcomeCount);
					return adverseEventIdAndTerm;
				}
			}

	
		}
} 
//split id and term and return adverse term
function getAdverseTerm(str) {
    return str.substr(str.indexOf('-')+2);
}
//5
jQuery(function() {
			getField('adverse_events.value').change(function() {
				
				if(getValue('adverse_events.value') == "OTHER ADVERSE EVENT" ){
					adverse_event_other.show();
				}
				else{
					setValue('adverse_event_other.value', "");  
					adverse_event_other.hide();				
				}
				
				//4 adverse event term is new or previous are resolved.
				var adverseEventIdAndTerm = getAdverseEventIdAndTerm( getValue('adverse_events.value') );
				
				if(adverseEventIdAndTerm=='not completed'){
					setValue("adverse_event_id_term.value",'');
					getField('adverse_event_id_term.error').html('Outcome of this Adverse Term is not completed yet.').show();
				}
				else if(adverseEventIdAndTerm!=''){
					setValue("adverse_event_id_term.value",adverseEventIdAndTerm);
					getField('adverse_event_id_term.error').html('').hide();
				}
				else{
					setValue("adverse_event_id_term.value",'');
					getField('adverse_event_id_term.error').html('Please select Correct Adverse Term.').show();
				}
				//4
								
			});	
				
			getField('adverse_event_drug_suspend.value').change(function() {
				
				if(getValue('adverse_event_drug_suspend.value') == 1065 ){
					suspended_tb_drugs.show();
					//check if other drug is selected
					if (getField("other_tb_drug.value").prop('checked')== true) {
						suspended_tb_drugs_other.show();
					}
					else {
						suspended_tb_drugs_other.hide();
					}
					 
				}
				else{
					suspended_tb_drugs.hide();
					// uncheck all checkbox first
					uncheckAllCheckBoxes("display_suspended_tb_drugs_child");
					setValue('tb_drugs_other.value', ""); 
					suspended_tb_drugs_other.hide()					
				}
								
			});	
			
			getField('adverse_event_serious.value').change(function() {
					if(getValue('adverse_event_serious.value') == 1065 ){
						adverse_event_serious_criterion.show();
					}
					else{					
						setValue('adverse_event_serious_criterion.value', "");
						adverse_event_serious_criterion.hide();
					}	
			});				
			
			jQuery(":checkbox").click(function(){
				var $this = jQuery(this);
				var checkBoxId = jQuery(this).closest('span').attr('id')
				
				if($this.is(":checked") &amp;&amp; checkBoxId == "other_tb_drug") {
						suspended_tb_drugs_other.show();
				}
				else if(checkBoxId == "other_tb_drug") {
						setValue('tb_drugs_other.value', "");
						suspended_tb_drugs_other.hide();
					
				}
				
			});	

});
		
beforeSubmit.push(function() {
 
	setValue('adverse_event_other.error','');
	setValue('amikacin.error','');
	setValue('adverse_event_serious_criterion.error','');
	setValue('tb_drugs_other.error','');
	setValue('adverse_event_id_term.error','');
	
	var valid=true;
	
	if(getValue('adverse_events.value') == "OTHER ADVERSE EVENT" &amp;&amp; (getValue('adverse_event_other.value') =='' ) ){	
		getField('adverse_event_other.error').html('Please input a value.').show();
		valid=false;		
	}
	else{
		getField('adverse_event_other.error').html('').hide();
	}
		
	//
	/*jQuery('#display_suspended_tb_drugs_child input[type=checkbox]').on('change', function () {
		var len = jQuery('#display_suspended_tb_drugs_child input[type=checkbox]:checked').length;
		if (len > 0) {
			suspended_tb_drugs_check = false;
		 } 
	}).trigger('change');*/
	
	if (jQuery("#display_suspended_tb_drugs_child input[type=checkbox]:checked").length > 0)
	{
		suspended_tb_drugs_check = true;
	}
	else
	{
	    suspended_tb_drugs_check = false;
	}

	if(getValue('adverse_event_drug_suspend.value')==1065 &amp;&amp;  suspended_tb_drugs_check == false) {
	   getField('amikacin.error').html('Please select a value.').show();
	   valid=false;	   
	}
	else {
	   getField('amikacin.error').html('').hide();
	   //other field null check
	   	if( getField('other_tb_drug.value').prop("checked") &amp;&amp;  getValue('tb_drugs_other.value').trim() =="" ){			
			getField('tb_drugs_other.error').html('Please input a value.').show();
			valid=false;	
		}
		else{
			getField('tb_drugs_other.error').html('').hide();
		}
	   
	}
	
	if(!getField('other_tb_drug.value').prop("checked")){
		setValue('tb_drugs_other.value', ""); 
	}
	
	 
	if(getValue('adverse_event_serious.value') == 1065 &amp;&amp; getValue('adverse_event_serious_criterion.value') =='' ){	
		getField('adverse_event_serious_criterion.error').html('Please input a value.').show();
		valid=false;		
	}
	else{
		getField('adverse_event_serious_criterion.error').html('').hide();
	}
	
	//
	if( ! (getValue('adverse_event_serious.value') == 1065)){
		setValue('adverse_event_serious_criterion.value', "");    
	}
	//
		
	if(valid==true){
	
		if( getValue("rep_ae_test.value") == 1065 ){
			alert("Please fill the relevant Lab Test Form");
		}
		
		getField("adverse_event_id.value").prop("disabled", false);
		getField("adverse_event_id_term.value").prop("disabled", false);

		var timeTakenDiv = $j("#time_taken_div");
		
		var endDate = new Date();
		var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
		var diffSec = timeDiff/1000;
		
		timeTakenDiv.show();
		setValue("time_taken.value",diffSec);
		timeTakenDiv.hide();
	
		return true;
}
	return false;
});
		
</script>
</htmlform>