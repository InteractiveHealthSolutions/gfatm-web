<htmlform>
	<!-- Developed by Tahira -->
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PMDT-Patient Dissociation(v0.0.1-alpha)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="1"/></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Patient Dissociation Information ">           
             
		<div>
  
                                <p>
					Treatment Supporter ID:  
					<font color="#2200ff"><lookup expression="fn.latestObs(165524).getValueAsString($!{locale})"/></font>
				</p>
				
				<p>
					Treatment Supporter First Name:
					<font color="#2200ff"><lookup expression="fn.latestObs(164368).getValueAsString($!{locale})"/></font>
					
				</p>
				
				<p>
					Treatment Supporter Last Name:
					
					<font color="#2200ff"><lookup expression="fn.latestObs(164372).getValueAsString($!{locale})"/></font>
				</p>

				<p>
					Reason for dissociation:
					
					<obs conceptId="164397" id="reason_dissociation" answerConceptIds="164394, 164398, 164399, 164400, 164401, 164402, 164403, 164404, 164405, 164406, 165660" defaultValue="164399" required="true">
						<controls>
							<when value="165660" thenDisplay="#reason"/>
								
						</controls>
                    </obs>
				</p>
				
							
				<div id="reason">
				<p>
					If reason 'other', then specify:
					<obs conceptId="165660" id="other_reason"/>
				</p>
				</div>

<patient field="Health District" />
 
		</div> 	
		
	</section>

	<submit/>

    <script type="text/javascript">
	
	    var startDate = new Date();
		var userData;
		var userAddress;
		var patientUuid;
		var treatmentSupporterFullName;
	
	
	   jQuery( document ).ready(function() {
			
            var uname = '<lookup expression="fn.latestObs(164372).getValueAsString($!{locale})"/>';
            if(uname == '') {             
			    getField("other_reason.value").prop('disabled',true);
			    getField("reason_dissociation.value").prop('disabled',true);
                            
                alert("Error! Please assign Treatment Supporter to this patient first.");
                            
            }         
                 
		});
		
		
		function getPatientAndUpdatePersonAttribute(treatmentSupporterName) {
		
		var patientId =  '<lookup expression="patient.getPatientIdentifier(3)"/>';
		
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/patient?q=" + patientId + "",
					dataType: 'json'
					}).done(function(data ) {

                                               
						console.log("patient display : " + data.results[0]['display']);
						console.log("patient uuid : " + data.results[0]['uuid']);
						patientUuid = data.results[0]['uuid'];
						updatePersonAttribute(patientUuid, treatmentSupporterName);
				
				});
			
		}
		
		
		function updatePersonAttribute(patientUuid, personAttribute) {
			
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/person/" + patientUuid + "/attribute?",
                    processData: false,
                    type: "POST",
					data: JSON.stringify({"attributeType":"f083e422-b1e9-4951-8bc9-95c2992a6a72","value": personAttribute}),
                    contentType: "application/json"
					
					}).done(function(data ) {
                
						console.log(data['display']);
						
				});
		}
		
		<!-- Error Checking before Form Submit -->
		beforeSubmit.push(function() {
			
			var valid=true;
			
			setValue('other_reason.error','');
			
			if(getValue('reason_dissociation.value')==165660 &amp;&amp; getValue('other_reason.value')==''){
                getField('other_reason.error').html('This field can not be empty').show();
                valid=false;                
            }
            else{
                getField('other_reason.error').html('').hide();
                
            }
			
			if(valid==false){
				return false;
            }
			else {
				var endDate = new Date();
                var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
				var diffSec = timeDiff/1000;
				alert(diffSec + " seconds to fill form");
				
				getPatientAndUpdatePersonAttribute("");
				
                return true;
            }			
		});
		

	
    </script>

<!-- END OF FORM

Simple examples to copy-and-paste. Full reference at http://wiki.openmrs.org/x/kg8z

SECTION
	<section headerLabel="\#. Title">
		Content
	</section>

NUMERIC OBSERVATION
	<obs conceptId="id-of-numeric-concept" labelText="Label before"/>

DATE OBSERVATION
	<obs conceptId="id-of-date-concept" labelText="Label before"/>

CODED OBSERVATION
(as a dropdown)
	<obs conceptId="id-of-coded-concept" labelText="Label before"/>
(as radio buttons)
	<obs conceptId="id-of-coded-concept" labelText="Label before" style="radio"/>
(as an autocomplete)
	<obs conceptId="id-of-coded-concept" labelText="Label before" style="autocomplete" answerClasses="Diagnosis"/>
(as a checkbox for a specific answer)
	<obs conceptId="id-of-coded-concept" labelText="Label before" answerConceptId="id-of-answer-concept" answerLabel="label for answer"/>
(as a dropdown with specific choices)
	<obs conceptId="id-of-coded-concept" labelText="Label before" answerConceptIds="concept-id-1,concept-id-2,concept-id-3" answerLabels="Label 1,Label 2, Label 3"/>


FREE TEXT OBSERVATION
(as a normal text field)
	<obs conceptId="id-of-text-concept" labelText="Label before"/>
(as a textarea)
	<obs conceptId="id-of-text-concept" labelText="Label before" rows="4" cols="80"/>
-->
</htmlform>