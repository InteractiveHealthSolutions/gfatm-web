<htmlform>
	<!-- Developed by Tahira -->
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PMDT-Patient Assignment (v0.0.1-alpha)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="1"/></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Patient Assignment Information ">           
             
		<div>

                 <ifMode mode="ENTER">
                <p>
                    List of all Treatment Supporters. Please select one
					<select id="treatment_supporters">			   

				    </select>
 				</p>   
               </ifMode>

                                <p>
					Treatment Supporter ID
					
					<obs conceptId="165524" id="treatment_supporter_id" required="true" style="dropdown"/>
				</p>
				
				<p>
					Treatment Supporter First Name
					
					<obs conceptId="164368" id="treatment_supporter_first_name" required="true"/>
				</p>
				
				<p>
					Treatment Supporter Last Name
					
					<obs conceptId="164372" id="treatment_supporter_last_name" required="true"/>
				</p>

				<ifMode mode="ENTER">
					
					<p>
						Address 1 <input id="address1"></input>
					</p>
					
					<p>
						Address 2 <input id="address2"></input>
					</p>
					
					<p>
						City/Village <input id="city_village"></input>
					</p>
					
					<p>
						District <input id="district"></input>
					</p>
					
					<p>
						Landmark <input id="landmark"></input>
					</p>
					
				</ifMode>
				

				<p>
					Is the Treatment Supporter a household member of the patient?
					
					<obs conceptId="164374" id="household_treatment_supporter" answerConceptIds="1065, 1066" defaultValue="1066" required="true">
						<controls>
							<when value="1065" thenDisplay="#relation,#reason"/>
							
							
						</controls>
                    </obs>
				</p>
				
				<div id="relation">
				<p>
					Treatment Supporter relationship with the patient:
					
					<obs conceptId="160640" id="treatment_supporter_relation" answerConceptIds = "971,970,164382,5617,160728,160729,160730,164383,164384,160723,160724,160726,160725,164385,164386,159720,159684,164388,164387,163357,163358,974,975,163356,5620" defaultValue="971">
					<controls>
							<when value="5620" thenDisplay="#other_relation"/>
						</controls>
					</obs>
				</p>
				
				</div>
				
				<div id="other_relation">
				<p>
					If relationship other, then specify:
					
					<obs conceptId="5620" id="other_family_member"/>
				</p>
				</div>
				
				<div id="reason">
				<p>
					Reason for having household member as a Treatment Supporter:
					
					<obs conceptId="164393" id="reason_household_treatment_supporter" defaultValue="164389">
					<controls>
							<when value="164392" thenDisplay="#other_reason_household_member"/>
						</controls>
					</obs>
				</p>
				</div>
				
				<div id="other_reason_household_member">
				<p>
					Other reason for having household member as a Treatment Supporter:
					
					<obs conceptId="164392" id="other_reason"/>
				</p>
				
				</div>
				
 
		</div> 
 
               
				
		
	</section>

	<submit/>

    <script type="text/javascript">
	
	    var startDate = new Date();
		var userData;
		var userAddress;
		var patientUuid;
		var treatmentSupporterFullName;
	
	
	   jQuery( document ).ready(function() {

			getField("treatment_supporter_id.value").prop('disabled',true);
			getField("treatment_supporter_first_name.value").prop('disabled',true);
			getField("treatment_supporter_last_name.value").prop('disabled',true);
             
            document.getElementById('address1').disabled = true;
            document.getElementById('address2').disabled = true;
            document.getElementById('city_village').disabled = true;
            document.getElementById('district').disabled = true;
            document.getElementById('landmark').disabled = true;
                        		
			doRest();
		});
  
        var supporters = document.getElementById("treatment_supporters");
        supporters.onchange = function(){
                var e = document.getElementById("treatment_supporters");
				var treatmentSupporterId = e.options[e.selectedIndex].text;
				settingValues(treatmentSupporterId);
				
		};

		function doRest(){
			jQuery.ajax({
				url: "/openmrs/ws/rest/v1/user?v=custom:(uuid,username,person)&amp;roles=PMDT Treatment Supporter",
				dataType: 'json'
				}).done(function(data ) {
					console.log(data.results[0].username);
					console.log(data.results.length);
					userData = data;
					populate(data);
			});
		}
				
		function populate(data) {
								
			var s= document.getElementById('treatment_supporters');
			
			for (i = 0; i &lt; data.results.length; i++) { 
				s.options[i+1]= new Option(data.results[i].username, data.results[i].username);                      
				var resultObject =  JSON.parse(JSON.stringify(data.results[i].person['display'] || null));
			}
		}
				
		function settingValues(username) {
			for (i = 0; i &lt; userData.results.length; i++) { 
				if(userData.results[i].username == username) {
					var displayName =  JSON.parse(JSON.stringify(userData.results[i].person['display'] || null));
					treatmentSupporterFullName = displayName;
					var firstName = displayName.split(" ")[0];
					var lastName = displayName.split(" ")[1];
					setValue('treatment_supporter_id.value',username);
					setValue('treatment_supporter_first_name.value',firstName);
					setValue('treatment_supporter_last_name.value',lastName);
					
					var uuid = JSON.parse(JSON.stringify(userData.results[i].person['uuid'] || null));
					retrieveUserAddress(uuid);
					
					/* if(userAddress.results.length > 0) {
						setValue('address1.value', userAddress.results[0]['address1']);
						setValue('address2.value', userAddress.results[0]['address2']);
						setValue('city_village.value',userAddress.results[0]['cityVillage']);
						setValue('district.value',userAddress.results[0]['countyDistrict']);
						setValue('landmark.value',userAddress.results[0]['address3']);
					} */												
				}
			}
		}
			
		function retrieveUserAddress(uuid) {
			
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/person/" + uuid + "/address",
					dataType: 'json'
					}).done(function(data ) {

						jQuery('#address1').val('');
						jQuery('#address2').val('');
						jQuery('#city_village').val('');
						jQuery('#district').val('');
						jQuery('#landmark').val('');

						console.log(data.results[0]['address3']);
						
						userAddress = data;
						console.log(userAddress.results.length);
						console.log(userAddress.results[0]);
						console.log(userAddress.results[0]['address3']);
						
						jQuery('#address1').val(userAddress.results[0]['address1']);
						jQuery('#address2').val(userAddress.results[0]['address2']);
						jQuery('#city_village').val(userAddress.results[0]['cityVillage']);
						jQuery('#district').val(userAddress.results[0]['countyDistrict']);
						jQuery('#landmark').val(userAddress.results[0]['address3']);
				});
				
		}
		
		function getPatientAndSavePersonAttribute(treatmentSupporterName) {
		
		var patientId =  '<lookup expression="patient.getPatientIdentifier(3)"/>';
		
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/patient?q=" + patientId + "",
					dataType: 'json'
					}).done(function(data ) {

                                               
						console.log("patient display : " + data.results[0]['display']);
						console.log("patient uuid : " + data.results[0]['uuid']);
						patientUuid = data.results[0]['uuid'];
						savePersonAttribute(patientUuid, treatmentSupporterName);
				
				});
			
		}
		
		
		function savePersonAttribute(patientUuid, personAttribute) {
			
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/person/" + patientUuid + "/attribute?",
                    processData: false,
                    type: "POST",
					data: JSON.stringify({"attributeType":"f083e422-b1e9-4951-8bc9-95c2992a6a72","value": personAttribute}),
                    contentType: "application/json"
					
					}).done(function(data ) {
                
						console.log(data['display']);
						
				});
		}
		
		
		
		
		
		<!-- Error Checking before Form Submit -->
		beforeSubmit.push(function() {
			
			getField("treatment_supporter_id.value").prop('disabled',false);
			getField("treatment_supporter_first_name.value").prop('disabled',false);
			getField("treatment_supporter_last_name.value").prop('disabled',false);

                        /* getField("address1.value").prop('disabled',false);
			getField("address2.value").prop('disabled',false);
			getField("city_village.value").prop('disabled',false);
                        getField("district.value").prop('disabled',false);
			getField("landmark.value").prop('disabled',false); */


			document.getElementById('address1').disabled = false;
			document.getElementById('address2').disabled = false;
			document.getElementById('city_village').disabled = false;
			document.getElementById('district').disabled = false;
			document.getElementById('landmark').disabled = false; 
			
			var valid=true;
			
			
			
			
			setValue('treatment_supporter_relation.error', '');
			setValue('other_family_member.error', '');
            setValue('reason_household_treatment_supporter.error','');
			setValue('other_reason.error','');
			

            
            
               
            if(getValue('household_treatment_supporter.value')==1065 &amp;&amp; getValue('treatment_supporter_relation.value')==''){
                getField('treatment_supporter_relation.error').html('This field can not be empty').show();
                valid=false;                
            }
            else{
                getField('treatment_supporter_relation.error').html('').hide();
                
            }
			
			if(getValue('treatment_supporter_relation.value')==5620 &amp;&amp; getValue('other_family_member.value')==''){
                getField('other_family_member.error').html('This field can not be empty').show();
                valid=false;                
            }
            else{
                getField('other_family_member.error').html('').hide();
                
            }
			
			if(getValue('household_treatment_supporter.value')==1065 &amp;&amp; getValue('reason_household_treatment_supporter.value')==''){
                getField('reason_household_treatment_supporter.error').html('This field can not be empty').show();
                valid=false;                
            }
            else{
                getField('reason_household_treatment_supporter.error').html('').hide();
                
            }
			
			if(getValue('reason_household_treatment_supporter.value')==164392 &amp;&amp; getValue('other_reason.value')==''){
                getField('other_reason.error').html('This field can not be empty').show();
                valid=false;                
            }
            else{
                getField('other_reason.error').html('').hide();
                
            }
			
			
			
			
			if(valid==false){
				return false;
            }
			else {
				var endDate = new Date();
                var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
				var diffSec = timeDiff/1000;
				alert(diffSec + " seconds to fill form");
				
				getPatientAndSavePersonAttribute(treatmentSupporterFullName);
				
				
                return true;
            }			
		});
		

	
    </script>

<!-- END OF FORM

Simple examples to copy-and-paste. Full reference at http://wiki.openmrs.org/x/kg8z

SECTION
	<section headerLabel="\#. Title">
		Content
	</section>

NUMERIC OBSERVATION
	<obs conceptId="id-of-numeric-concept" labelText="Label before"/>

DATE OBSERVATION
	<obs conceptId="id-of-date-concept" labelText="Label before"/>

CODED OBSERVATION
(as a dropdown)
	<obs conceptId="id-of-coded-concept" labelText="Label before"/>
(as radio buttons)
	<obs conceptId="id-of-coded-concept" labelText="Label before" style="radio"/>
(as an autocomplete)
	<obs conceptId="id-of-coded-concept" labelText="Label before" style="autocomplete" answerClasses="Diagnosis"/>
(as a checkbox for a specific answer)
	<obs conceptId="id-of-coded-concept" labelText="Label before" answerConceptId="id-of-answer-concept" answerLabel="label for answer"/>
(as a dropdown with specific choices)
	<obs conceptId="id-of-coded-concept" labelText="Label before" answerConceptIds="concept-id-1,concept-id-2,concept-id-3" answerLabels="Label 1,Label 2, Label 3"/>


FREE TEXT OBSERVATION
(as a normal text field)
	<obs conceptId="id-of-text-concept" labelText="Label before"/>
(as a textarea)
	<obs conceptId="id-of-text-concept" labelText="Label before" rows="4" cols="80"/>
-->
</htmlform>