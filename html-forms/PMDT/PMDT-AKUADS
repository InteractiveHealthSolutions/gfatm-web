<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PMDT-AKUADS FORM (v0.0.1-alpha)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation/></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Treatment Information">
	
		<p>
			Date of assessment
			<br/>
			<obs conceptId="165469" id="date_assessment" default="today" required="true"/>
		</p>
		
		<p>
			Type of assessment
			<br/>
			<obs conceptId="165103" id ="assessment_type" answerConceptIds="165348,165035,165102,165040,165036,165041,165042" answerLabels="Baseline Assessment,Treatment initiation,2 week assessment,Planned monthly assessment, Other assessment,End of treatment assessment,Post-treatment assessment" required="true" default="165348">
			<controls>
				<when value="165036" thenDisplay="#other_assessment_div"/>
				<when value="165040" thenDisplay="#treatment_month_div"/>
				<when value="165041" thenDisplay="#treatment_outcome_div"/>
				<when value="165042" thenDisplay="#post_treatment_outcome_div"/>
			</controls>
			</obs>
		</p>
		
		<div id="other_assessment_div">
			<p>
				Other assessment reason
				<br/>
				<obs conceptId="165036" id="assessment_type_other"  maxlength="100"/>
			</p>
		</div>
		
		<div id="treatment_month_div">
			<p>
				Month of treatment
				<br/>
				<obs conceptId="164327" id="treatment_month"  maxlength="3"/>
			</p>
		</div>
		
		<div id="treatment_outcome_div">
			<p>
				Treatment Outcome
				<br/>
				<lookup expression="fn.latestObs('159786').getValueAsString(en)"/>
			</p>
		</div>
		
		<div id="post_treatment_outcome_div">
			<p>
				Post-treatment Outcome
				<br/>
				<lookup expression="fn.latestObs('165175').getValueAsString(en)"/>
			</p>
		</div>
		
	</section>
	
	<section headerLabel="2. AKUADS Questionnaire">
		<p>
			In the past 2 weeks, Have you been sleeping less?
			<br/>
			<obs conceptId="164555" id="akuads_sleep" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you had lack of interest in your daily activities?
			<br/>
			<obs conceptId="164557" id="akuads_interest_loss" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true" />
		</p>
		<p>
			In the past 2 weeks, Have you lost interest in your hobbies?
			<br/>
			<obs conceptId="164560" id="akuads_hobby_interest_loss" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you been anxious?
			<br/>
			<obs conceptId="164561" id="akuads_anxious" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you had a sensation of impending doom?
			<br/>
			<obs conceptId="164562" id="akuads_doom_sensation" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you had difficulty in thinking clearly?
			<br/>
			<obs conceptId="164563" id="akuads_difficulty_thinking" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you preferred to be alone?
			<br/>
			<obs conceptId="164564" id="akuads_alone" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you felt unhappy?
			<br/>
			<obs conceptId="164565" id="akuads_unhappy" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you felt hopeless?
			<br/>
			<obs conceptId="164566" id="akuads_hopeless" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you felt helpless?
			<br/>
			<obs conceptId="164567" id="akuads_helpless" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you been worried?
			<br/>
			<obs conceptId="164568" id="akuads_worried" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you cried?
			<br/>
			<obs conceptId="164569" id="akuads_cried" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you thought of taking your life?
			<br/>
			<obs conceptId="164571" id="akuads_suicidal" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you had loss of appetite?
			<br/>
			<obs conceptId="164572" id="akuads_appetite_loss" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you had retrosternal burning?
			<br/>
			<obs conceptId="164573" id="akuads_retrosternal_burning" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you had indigestion?
			<br/>
			<obs conceptId="164574" id="akuads_indigestion" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you had nausea?
			<br/>
			<obs conceptId="164575" id="akuads_nausea" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you had constipation?
			<br/>
			<obs conceptId="164576" id="akuads_constipation" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you felt difficulty in breathing?
			<br/>
			<obs conceptId="164577" id="akuads_breathing_difficulty" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you felt tremulous?
			<br/>
			<obs conceptId="164578" id="akuads_tremulous" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you felt numbness of hands and feet?
			<br/>
			<obs conceptId="164579" id="akuads_numbness" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you felt a sensation of tension in your neck and shoulders?
			<br/>
			<obs conceptId="164581" id="akuads_tension" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you had headaches?
			<br/>
			<obs conceptId="164582" id="akuads_headaches" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you felt pain all over your body?
			<br/>
			<obs conceptId="164584" id="akuads_body_pain" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			In the past 2 weeks, Have you passes urine more frequently?
			<br/>
			<obs conceptId="164585" id="akuads_frequent_urination" answerConceptIds="1090,1385,1804,1358,1067" defaultValue="1067" required="true"/>
		</p>
		<p>
			Total Score:
			<br/>
			<obs conceptId="164586" id="akuads_score"/>		
		</p>
		<p>
			AKUADS result:
			<br/>
			<obs conceptId="164588" id="akuads_severity"/>		
		</p>
		
	</section>

	<submit/>
	
	<script type="text/javascript">
		var sum =0;
		
		
		/*getField("akuads_score.value").prop('disabled',true);
		getField("akuads_severity.value").prop('disabled',true);
		
		var treatmentStartDate = "<lookup expression="fn.latestObs('159786').obsDatetime"/>";*/
		
		jQuery(function() {
			getField('assessment_type.value').change(function(){
					if(getValue('assessment_type.value') == 165040){
						var encounters = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('7915fa1c-e3f8-47c2-aa4d-e20a5b0ef31b')) 
						$fn.getObs($encounter, '159786').obsDatetime #end"/>";
						var result = encounters.replace(/\s\s+/g, '@');
						var resultValueArray = result.split('@');
						var treatmentInitDate = resultValueArray[resultValueArray.length-1];
						
						var assessment_date = getValue('date_assessment.value');
						var oneDay = 24*60*60*1000; // hours*minutes*seconds*milliseconds
						var treatmentStartDate = new Date(treatmentInitDate);
						var visit_date = new Date(assessment_date);

						var diffDays = Math.round(Math.abs((treatmentStartDate.getTime() - visit_date.getTime())/(oneDay)));
						var treatment_month = diffDays/30;
						
						setValue('treatment_month.value', treatment_month);						
					}
			});
		});
		
		var akuads_ids = ['akuads_sleep', 'akuads_interest_loss', 'akuads_hobby_interest_loss', 'akuads_anxious', 'akuads_doom_sensation', 'akuads_difficulty_thinking'
		, 'akuads_alone', 'akuads_unhappy', 'akuads_hopeless', 'akuads_helpless', 'akuads_worried', 'akuads_cried', 'akuads_suicidal', 'akuads_appetite_loss', 
		'akuads_retrosternal_burning', 'akuads_indigestion', 'akuads_nausea', 'akuads_constipation', 'akuads_breathing_difficulty', 'akuads_tremulous', 'akuads_numbness',
		'akuads_tension', 'akuads_headaches', 'akuads_body_pain', 'akuads_frequent_urination'];
		
		function getNumericValue(str) {
			if(str == 1090 || str == 1067)
			{
				return 0;
			}else if (str == 1385){
				return 1;
			}
			else if (str == 1804){
				return 2;
			}
			else if (str == 1358){
				return 3;
			}
		}
		function recalculateSum() {
		
			sum = 0;
			var values = [];
		
			 values[0]= getNumericValue(getValue('akuads_sleep.value'));
			 values[1]= getNumericValue(getValue('akuads_interest_loss.value'));
			 values[2]= getNumericValue(getValue('akuads_hobby_interest_loss.value'));
			 values[3]= getNumericValue(getValue('akuads_anxious.value'));
			 values[4]= getNumericValue(getValue('akuads_doom_sensation.value'));
			 values[5]= getNumericValue(getValue('akuads_difficulty_thinking.value'));
			 values[6]= getNumericValue(getValue('akuads_alone.value'));
			 values[7]= getNumericValue(getValue('akuads_unhappy.value'));
			 values[8]= getNumericValue(getValue('akuads_hopeless.value'));
			 values[9]= getNumericValue(getValue('akuads_helpless.value'));
			 values[10]= getNumericValue(getValue('akuads_worried.value'));
			 values[11]= getNumericValue(getValue('akuads_cried.value'));
			 values[12]= getNumericValue(getValue('akuads_suicidal.value'));
			 values[13]= getNumericValue(getValue('akuads_appetite_loss.value'));
			 values[14]= getNumericValue(getValue('akuads_retrosternal_burning.value'));
			 values[15]= getNumericValue(getValue('akuads_indigestion.value'));
			 values[16]= getNumericValue(getValue('akuads_nausea.value'));
			 values[17]= getNumericValue(getValue('akuads_constipation.value'));
			 values[18]= getNumericValue(getValue('akuads_breathing_difficulty.value'));
			 values[19]= getNumericValue(getValue('akuads_tremulous.value'));
			 values[20]= getNumericValue(getValue('akuads_numbness.value'));
			 values[21]= getNumericValue(getValue('akuads_tension.value'));
			 values[22]= getNumericValue(getValue('akuads_headaches.value'));
			 values[23]= getNumericValue(getValue('akuads_body_pain.value'));
			 values[24]= getNumericValue(getValue('akuads_frequent_urination.value'));
			
			for(var i=0; i &lt; values.length; i++){
				sum = sum + values[i];
			}
			
			var result = getResult(sum);
			setValue('akuads_severity.value', result);
			
			return sum;
		}
		
		function getResult(score) {
			if(score &lt; 21) {
				return 165602;  /*No depresssion and anxiety*/
			}else if (score &gt; 20 &amp;&amp; score &lt; 42) {
				return 1498; /*mild*/
			}
			else if (score &gt; 41 &amp;&amp; score &lt; 62) {
				return 1499; /*moderate*/
			}
			else if (score &gt; 61) {
				return 1500; /*severe*/
			}
			
			return 0;
		}
		
		jQuery(function() {
			
			getField('akuads_sleep.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			getField('akuads_interest_loss.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			getField('akuads_hobby_interest_loss.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			getField('akuads_hobby_interest_loss.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			getField('akuads_anxious.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			getField('akuads_doom_sensation.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			getField('akuads_difficulty_thinking.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			getField('akuads_alone.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			
			getField('akuads_unhappy.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			getField('akuads_hopeless.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			getField('akuads_helpless.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			getField('akuads_worried.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			getField('akuads_cried.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			getField('akuads_suicidal.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			getField('akuads_appetite_loss.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			getField('akuads_retrosternal_burning.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			getField('akuads_indigestion.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			getField('akuads_nausea.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			getField('akuads_constipation.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			getField('akuads_breathing_difficulty.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			getField('akuads_tremulous.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			getField('akuads_numbness.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			getField('akuads_tension.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			getField('akuads_headaches.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			getField('akuads_body_pain.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			getField('akuads_frequent_urination.value').change(function(){
						var score = recalculateSum();
						setValue('akuads_score.value', score);
			});
			
			getField('akuads_score.value').change(function(){
						var result = getResult(getValue('akuads_score.value'));
						setValue('akuads_severity.value', result);
			});
		});
		
		
	</script>

<!-- END OF FORM

Simple examples to copy-and-paste. Full reference at http://wiki.openmrs.org/x/kg8z

SECTION
	<section headerLabel="\#. Title">
		Content
	</section>

NUMERIC OBSERVATION
	<obs conceptId="id-of-numeric-concept" labelText="Label before"/>

DATE OBSERVATION
	<obs conceptId="id-of-date-concept" labelText="Label before"/>

CODED OBSERVATION
(as a dropdown)
	<obs conceptId="id-of-coded-concept" labelText="Label before"/>
(as radio buttons)
	<obs conceptId="id-of-coded-concept" labelText="Label before" style="radio"/>
(as an autocomplete)
	<obs conceptId="id-of-coded-concept" labelText="Label before" style="autocomplete" answerClasses="Diagnosis"/>
(as a checkbox for a specific answer)
	<obs conceptId="id-of-coded-concept" labelText="Label before" answerConceptId="id-of-answer-concept" answerLabel="label for answer"/>
(as a dropdown with specific choices)
	<obs conceptId="id-of-coded-concept" labelText="Label before" answerConceptIds="concept-id-1,concept-id-2,concept-id-3" answerLabels="Label 1,Label 2, Label 3"/>


FREE TEXT OBSERVATION
(as a normal text field)
	<obs conceptId="id-of-text-concept" labelText="Label before"/>
(as a textarea)
	<obs conceptId="id-of-text-concept" labelText="Label before" rows="4" cols="80"/>
-->
</htmlform>