<htmlform>
	<!-- Developed by Tahira -->
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PMDT-Treatment Supporter Assignment (v0.0.1-alpha)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="2"  tags="PMDT" /></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Treatment Supporter Assignment Form">           
             
		<div>

               
                <p>
                    List of all Treatment Supporters. Please select one
					<select id="treatment_supporters">			   
				    </select>
 				</p>   
               
				<p>
				Treatment Supporter ID
				<br/>
				<obs id="treatment_supporter_id" conceptId="165524"  required="true" style="dropdown"/>
				</p>
				
				
				<p>
                    List of all Treatment Coordinator. Please select one
					<select id="treatment_coordinators">			   
				    </select>
 				</p> 
				
				<p>
				Treatment Coordinator ID
				<br/>
				<obs id="treatment_coordinator_id" conceptId="166105" required="true"/>
				</p>

				<p>
				Treatment Coordinator First Name
				<br/>
				<obs id="treatment_coordinator_first_name" conceptId="166133" />
				</p>

				<p>
				Treatment Coordinator Last Name
				<br/>
				<obs id="treatment_coordinator_last_name" conceptId="166134"/>
				</p>
				
				
				<p>
				Is the Treatment Supporter a family member of the patient?
				<br/>
				<obs id="household_treatment_supporter" conceptId="164374" answerConceptIds="1065,1066" answerLabels="Yes,No" defaultValue="1066" required="true"/>
				</p>

				<div id="display_treatment_supporter_relation">
				<p>
				Treatment Supporter relationship with the patient
				<br/>
				<obs id="treatment_supporter_relation" conceptId="160640" 
				answerConceptIds="971,970,5617,160727,160728,160729,160730,164383,164384,160723,160724,160726,160725,164385,164386,159720,159684,164388,164387,163357,163358,974,975,163356,5620" 
				answerLabels="Father,Mother,Spouse,Son,Daughter,Brother,Sister,Nephew,Niece,Maternal Grandmother,Maternal Grandfather,Paternal Grandmother,Paternal Grandfather,Grandson,Granddaughter,Father in law,Mother in law,Daughter in law,Son in law,Brother in law,Sister in law,Uncle,Aunt,Cousin,Other" 
				defaultValue="971" />
				</p>
				</div>

				<div id="display_other_family_member">
				<p>
				If relationship other, then specify:
				<br/>
				<obs id="other_family_member" conceptId="5620" maxlength="50"/>
				</p>
				</div>
				
				<div id="display_reason_household_treatment_supporter">
				<p>
				Reason for having household member as a Treatment Supporter:
				<br/>
				<obs id="reason_household_treatment_supporter" conceptId="164393" answerConceptIds="164389,164390,164391,164392" 
				answerLabels="Family refused to have a Treatment Supporter who is not a family member,Patient refused to have a Treatment Supporter who is not a family member,Unable to appoint Treatment Supporter as incentive not being provided,Other" 
				defaultValue="164389" />
				</p>
				</div>
				
				
				<div id="display_reason_household_treatment_supporter_other">
				<p>
				Other reason for having household member as a Treatment Supporter:
				<br/>
				<obs id="reason_household_treatment_supporter_other" conceptId="164392" maxlength="255" style="textarea" />
				</p>
				</div>
				
				<div id="time_taken_div">
				<p> 
				Time taken to fill form
				<br/>
				<obs id="time_taken" conceptId="165044" />
				</p>
				</div>

		</div> 
	</section>

	<submit/>

    <script type="text/javascript">
	
	    var startDate = new Date();
		var userData;
		var userAddress;
		var patientUuid;
		var treatmentSupporterFullName;
		
		var coordinatorData;
		var coordinatorFullName;
		
		var treatment_supporter_relation = jQuery("#display_treatment_supporter_relation");
		var other_family_member = jQuery("#display_other_family_member");
		var reason_household_treatment_supporter = jQuery("#display_reason_household_treatment_supporter");
		var reason_household_treatment_supporter_other = jQuery("#display_reason_household_treatment_supporter_other");
		
		var isTreatmentSupporterAlreadySelected=false;
		var treatmentSupporter="";
		
		alphaRegExp = new RegExp(/^[A-Za-z,. \n]+/);
		
	   jQuery( document ).ready(function() {
			
		var timeTakenDiv = jQuery("#time_taken_div");
		timeTakenDiv.hide();
		
		<ifMode mode='EDIT'>  
			jQuery("#treatment_supporters").prop('disabled', true);
			jQuery("#treatment_coordinators").prop('disabled', true);
		</ifMode> 
		
		getField("treatment_supporter_id.value").prop("disabled", true);
		getField("treatment_coordinator_id.value").prop("disabled", true);
		getField("treatment_coordinator_first_name.value").prop("disabled", true);
		getField("treatment_coordinator_last_name.value").prop("disabled", true);

		<ifMode mode='VIEW' include="false"> 
						 		
		if(getValue('household_treatment_supporter.value') == 1065 ){
			treatment_supporter_relation.show();
			reason_household_treatment_supporter.show();
		}
		else{
			treatment_supporter_relation.hide();
			other_family_member.hide();	
			reason_household_treatment_supporter.hide();		
			reason_household_treatment_supporter_other.hide();		
		}
		
		if(getValue('treatment_supporter_relation.value') == 5620 ){
			other_family_member.show();
		}
		else{
			other_family_member.hide();					
		}
		
		if(getValue('reason_household_treatment_supporter.value') == 164392 ){
			reason_household_treatment_supporter_other.show();
		}
		else{
			reason_household_treatment_supporter_other.hide();					
		}
		getSupporters();
		getCoordinators();
		</ifMode>
		
		<ifMode mode='ENTER' > 
				var treatmentSupporterTemp="<lookup expression="personAttributes.get('Treatment Supporter')"/>";
				console.log(treatmentSupporterTemp);
				if(treatmentSupporterTemp==""){
					isTreatmentSupporterAlreadySelected=false;					
				}
				else{
					isTreatmentSupporterAlreadySelected=true;
					treatmentSupporter=treatmentSupporterTemp;
					alert("Treatment Supporter: '"+treatmentSupporter+"' For this patient is already selected. Please Discontinue it from PMDT-Treatment Supporter Discontinuation Form First.");
					jQuery("#treatment_supporters").prop('disabled', true);
					jQuery("#treatment_coordinators").prop('disabled', true);
				}
		</ifMode>
		
		});
		
		function getSupporters(){
			jQuery.ajax({
				url: "/openmrs/ws/rest/v1/user?v=custom:(uuid,username,person)&amp;roles=PMDT Treatment Supporter",
				dataType: 'json'
				}).done(function(data ) {
					console.log(data.results[0].username);
					console.log(data.results.length);
					userData = data;
					setSupporters(data);
			});
		}
		
		function setSupporters(data) {
								
			var s= document.getElementById('treatment_supporters');
			
			for (i = 0; i &lt; data.results.length; i++) { 
				s.options[i+1]= new Option(data.results[i].username, data.results[i].username);                      
				var resultObject =  JSON.parse(JSON.stringify(data.results[i].person['display'] || null));
			}
		}
		
		function getPatientAndSavePersonTreatmentSupporterAttribute(treatmentSupporterName){
				
			var patientId =  '<lookup expression="patient.getPatientIdentifier(3)"/>';
		
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/patient?q=" + patientId + "",
					dataType: 'json'
					}).done(function(data ) {                                      
						console.log("patient display : " + data.results[0]['display']);
						console.log("patient uuid : " + data.results[0]['uuid']);
						patientUuid = data.results[0]['uuid'];
						savePersonTreatmentSupporterAttribute(patientUuid,treatmentSupporterName );
				
				});
		}
	
		function savePersonTreatmentSupporterAttribute(patientUuid, personAttribute) {
			
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/person/" + patientUuid + "/attribute?",
                    processData: false,
                    type: "POST",
					data: JSON.stringify({"attributeType":"f083e422-b1e9-4951-8bc9-95c2992a6a72","value": personAttribute}),
                    contentType: "application/json"
					
					}).done(function(data ) {
                
						console.log(data['display']);
						
				});
		}
		
		function getCoordinators(){
			jQuery.ajax({
				url: "/openmrs/ws/rest/v1/user?v=custom:(uuid,username,person)&amp;roles=PMDT Treatment Coordinator",
				dataType: 'json'
				}).done(function(data ) {
					console.log(data.results[0].username);
					console.log(data.results.length);
					coordinatorData = data;
					setCoordinators(data);
			});
		}
		function setCoordinators(data) {
								
			var s= document.getElementById('treatment_coordinators');
			
			for (i = 0; i &lt; data.results.length; i++) { 
				s.options[i+1]= new Option(data.results[i].username, data.results[i].username);                      
				var resultObject =  JSON.parse(JSON.stringify(data.results[i].person['display'] || null));
			}
		}		  
				
		function setCoordinatorsDetails(username) {
			for (i = 0; i &lt; coordinatorData.results.length; i++) { 
				if(coordinatorData.results[i].username == username) {
					var displayName =  JSON.parse(JSON.stringify(coordinatorData.results[i].person['display'] || null));
					coordinatorFullName = displayName;
					var firstName = displayName.split(" ")[0];
					var lastName = displayName.split(" ")[1];
					setValue('treatment_coordinator_id.value',username);
					setValue('treatment_coordinator_first_name.value',firstName);
					setValue('treatment_coordinator_last_name.value',lastName);												
				}
			}
		}
		
		function getPatientAndSavePersonTreatmentCoordinatorAttribute(treatmentCoordinatorName){
				
			var patientId =  '<lookup expression="patient.getPatientIdentifier(3)"/>';
		
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/patient?q=" + patientId + "",
					dataType: 'json'
					}).done(function(data ) {                                      
						console.log("patient display : " + data.results[0]['display']);
						console.log("patient uuid : " + data.results[0]['uuid']);
						patientUuid = data.results[0]['uuid'];
						savePersonTreatmentCoordinatorAttribute(patientUuid,treatmentCoordinatorName );
				
				});
		}
	
		function savePersonTreatmentCoordinatorAttribute(patientUuid, personAttribute) {
			
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/person/" + patientUuid + "/attribute?",
                    processData: false,
                    type: "POST",
					data: JSON.stringify({"attributeType":"03ae5e95-c8a6-439c-b1cf-9cc0ac38f607","value": personAttribute}),
                    contentType: "application/json"
					
					}).done(function(data ) {
                
						console.log(data['display']);
						
				});
		}
		

		function doRest(){
			jQuery.ajax({
				url: "/openmrs/ws/rest/v1/user?v=custom:(uuid,username,person)&amp;roles=PMDT Treatment Supporter",
				dataType: 'json'
				}).done(function(data ) {
					console.log(data.results[0].username);
					console.log(data.results.length);
					userData = data;
					populate(data);
			});
		}
				
		function populate(data) {
								
			var s= document.getElementById('treatment_supporters');
			
			for (i = 0; i &lt; data.results.length; i++) { 
				s.options[i+1]= new Option(data.results[i].username, data.results[i].username);                      
				var resultObject =  JSON.parse(JSON.stringify(data.results[i].person['display'] || null));
			}
		}
				
		function settingValues(username) {
			for (i = 0; i &lt; userData.results.length; i++) { 
				if(userData.results[i].username == username) {
					var displayName =  JSON.parse(JSON.stringify(userData.results[i].person['display'] || null));
					treatmentSupporterFullName = displayName;
					var firstName = displayName.split(" ")[0];
					var lastName = displayName.split(" ")[1];
					setValue('treatment_supporter_id.value',username);
					setValue('treatment_supporter_first_name.value',firstName);
					setValue('treatment_supporter_last_name.value',lastName);
					
					var uuid = JSON.parse(JSON.stringify(userData.results[i].person['uuid'] || null));
					retrieveUserAddress(uuid);
					
					/* if(userAddress.results.length > 0) {
						setValue('address1.value', userAddress.results[0]['address1']);
						setValue('address2.value', userAddress.results[0]['address2']);
						setValue('city_village.value',userAddress.results[0]['cityVillage']);
						setValue('district.value',userAddress.results[0]['countyDistrict']);
						setValue('landmark.value',userAddress.results[0]['address3']);
					} */												
				}
			}
		}
			
		function retrieveUserAddress(uuid) {
			
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/person/" + uuid + "/address",
					dataType: 'json'
					}).done(function(data ) {

						jQuery('#address1').val('');
						jQuery('#address2').val('');
						jQuery('#city_village').val('');
						jQuery('#district').val('');
						jQuery('#landmark').val('');

						console.log(data.results[0]['address3']);
						
						userAddress = data;
						console.log(userAddress.results.length);
						console.log(userAddress.results[0]);
						console.log(userAddress.results[0]['address3']);
						
						jQuery('#address1').val(userAddress.results[0]['address1']);
						jQuery('#address2').val(userAddress.results[0]['address2']);
						jQuery('#city_village').val(userAddress.results[0]['cityVillage']);
						jQuery('#district').val(userAddress.results[0]['countyDistrict']);
						jQuery('#landmark').val(userAddress.results[0]['address3']);
				});
				
		}
		
		
		function savePersonAttribute(patientUuid, personAttribute) {
			
			jQuery.ajax({
					url: "/openmrs/ws/rest/v1/person/" + patientUuid + "/attribute?",
                    processData: false,
                    type: "POST",
					data: JSON.stringify({"attributeType":"f083e422-b1e9-4951-8bc9-95c2992a6a72","value": personAttribute}),
                    contentType: "application/json"
					
					}).done(function(data ) {
                
						console.log(data['display']);
						
				});
		}
		
	jQuery(function() {
			getField('household_treatment_supporter.value').change(function() {
				
				if(getValue('household_treatment_supporter.value') == 1065 ){
					treatment_supporter_relation.show();
					reason_household_treatment_supporter.show();
				}
				else{
					setValue("treatment_supporter_relation.value","");
					treatment_supporter_relation.hide();
					setValue("other_family_member.value","");
					other_family_member.hide();	
					setValue("reason_household_treatment_supporter.value","");
					reason_household_treatment_supporter.hide();	
					setValue("reason_household_treatment_supporter_other.value","");
					reason_household_treatment_supporter_other.hide();		
				}			
			});	

			getField('treatment_supporter_relation.value').change(function() {
				
				if(getValue('treatment_supporter_relation.value') == 5620 ){
					other_family_member.show();
				}
				else{
					setValue("other_family_member.value","");
					other_family_member.hide();					
				}
					
			});	
			
			getField('reason_household_treatment_supporter.value').change(function() {
				
				if(getValue('reason_household_treatment_supporter.value') == 164392 ){
					reason_household_treatment_supporter_other.show();
				}
				else{
					setValue("reason_household_treatment_supporter_other.value","");
					reason_household_treatment_supporter_other.hide();					
				}
				
				
			});	
			
			//////////////////////////
			jQuery('#treatment_supporters').change(function() {
				setValue('treatment_supporter_id.value',jQuery("#treatment_supporters").val());  
			});
			jQuery('#treatment_coordinators').change(function() {	
				if(jQuery("#treatment_coordinators").val()==""){
					setValue('treatment_coordinator_id.value',"");
					setValue('treatment_coordinator_first_name.value',"");
					setValue('treatment_coordinator_last_name.value',"");	
				}
				else{
					setCoordinatorsDetails(jQuery("#treatment_coordinators").val());
				}
				
			});
		
	});	
		
		
		
		<!-- Error Checking before Form Submit -->
		beforeSubmit.push(function() {
			
			var valid=true;
		
			setValue('treatment_supporter_relation.error', '');
			setValue('other_family_member.error', '');
            setValue('reason_household_treatment_supporter.error','');
			setValue('reason_household_treatment_supporter_other.error',''); 
			
			setValue('household_treatment_supporter.error', '');
            setValue('treatment_supporter_id.error','');
			setValue('treatment_coordinator_id.error',''); 
           
            if(getValue('household_treatment_supporter.value')==1065 &amp;&amp; getValue('treatment_supporter_relation.value')==''){
                getField('treatment_supporter_relation.error').html('This field can not be empty').show();
                valid=false;                
            }
            else{
                getField('treatment_supporter_relation.error').html('').hide();
                
            }
			
		if( getValue('household_treatment_supporter.value')==1065 &amp;&amp; getValue('treatment_supporter_relation.value')==5620) {
				if(getValue('other_family_member.value').trim()=='') {
			
                getField('other_family_member.error').html('This field can not be empty').show();
                valid=false;                
				}
				else {
					var other_family_member=getValue('other_family_member.value');
					var other_family_member_result = other_family_member.match(alphaRegExp);
			
					if(!(other_family_member_result == other_family_member)) {
						getField('other_family_member.error').html('This field should be alpha pattern').show();
						valid=false;
					} else {
						getField('other_family_member.error').html('').hide();
					}	
				}
            }
			
			if(getValue('household_treatment_supporter.value')==1065 &amp;&amp; getValue('reason_household_treatment_supporter.value')==''){
                getField('reason_household_treatment_supporter.error').html('This field can not be empty').show();
                valid=false;                
            }
            else{
                getField('reason_household_treatment_supporter.error').html('').hide();
                
            }
			
			if( getValue('household_treatment_supporter.value')==1065 &amp;&amp; getValue('reason_household_treatment_supporter.value')==164392 &amp;&amp; getValue('reason_household_treatment_supporter_other.value')==''){
                getField('reason_household_treatment_supporter_other.error').html('This field can not be empty').show();
                valid=false;                
            }
            else{
                getField('reason_household_treatment_supporter_other.error').html('').hide();
                
            }
			
			if(getValue("treatment_supporter_id.value")==""){
				getField('treatment_supporter_id.error').html('Please select Treatment Supporter').show();
                valid=false; 
			}
			else{
			      getField('treatment_supporter_id.error').html('').hide();
			}
			
			if(getValue("treatment_coordinator_id.value")==""){
				getField('treatment_coordinator_id.error').html('Please select Treatment Coordinator').show();
                valid=false; 
			}
			else{
			      getField('treatment_coordinator_id.error').html('').hide();
			}
			
			if(getValue("household_treatment_supporter.value")==""){
				getField('household_treatment_supporter.error').html('Please select a value').show();
                valid=false; 
			}
			else{
			      getField('household_treatment_supporter.error').html('').hide();
			}
			
			if(isTreatmentSupporterAlreadySelected==true){
				alert("Treatment Supporter: '"+treatmentSupporter+"' For this patient is already selected. Please Discontinue it from PMDT-Treatment Supporter Discontinuation Form First.");
				valid=false;
			}				
			
			
			if(valid==false){
				return false;
            }
			else {
			
				//remove default value
				if( getValue('household_treatment_supporter.value')!=1065 ){
					setValue("treatment_supporter_relation.value","");
					setValue("reason_household_treatment_supporter.value","");
				}
				
				var timeTakenDiv = $j("#time_taken_div");
		
				var endDate = new Date();
				var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
				var diffSec = timeDiff/1000;
				
				timeTakenDiv.show();
				setValue("time_taken.value",diffSec);
				timeTakenDiv.hide();

				<ifMode mode='EDIT' include="false">  
				getPatientAndSavePersonTreatmentSupporterAttribute(getValue("treatment_supporter_id.value"));
				getPatientAndSavePersonTreatmentCoordinatorAttribute(getValue("treatment_coordinator_id.value"));
				</ifMode>
				
				getField("treatment_supporter_id.value").prop("disabled", false);
				getField("treatment_coordinator_id.value").prop("disabled", false);
				getField("treatment_coordinator_first_name.value").prop("disabled", false);
				getField("treatment_coordinator_last_name.value").prop("disabled", false);
				
                return true;
            }			
		});
		

	
    </script>

<!-- END OF FORM

Simple examples to copy-and-paste. Full reference at http://wiki.openmrs.org/x/kg8z

SECTION
	<section headerLabel="\#. Title">
		Content
	</section>

NUMERIC OBSERVATION
	<obs conceptId="id-of-numeric-concept" labelText="Label before"/>

DATE OBSERVATION
	<obs conceptId="id-of-date-concept" labelText="Label before"/>

CODED OBSERVATION
(as a dropdown)
	<obs conceptId="id-of-coded-concept" labelText="Label before"/>
(as radio buttons)
	<obs conceptId="id-of-coded-concept" labelText="Label before" style="radio"/>
(as an autocomplete)
	<obs conceptId="id-of-coded-concept" labelText="Label before" style="autocomplete" answerClasses="Diagnosis"/>
(as a checkbox for a specific answer)
	<obs conceptId="id-of-coded-concept" labelText="Label before" answerConceptId="id-of-answer-concept" answerLabel="label for answer"/>
(as a dropdown with specific choices)
	<obs conceptId="id-of-coded-concept" labelText="Label before" answerConceptIds="concept-id-1,concept-id-2,concept-id-3" answerLabels="Label 1,Label 2, Label 3"/>


FREE TEXT OBSERVATION
(as a normal text field)
	<obs conceptId="id-of-text-concept" labelText="Label before"/>
(as a textarea)
	<obs conceptId="id-of-text-concept" labelText="Label before" rows="4" cols="80"/>
-->
</htmlform>