<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PMDT-End of Treatment (v0.0.1)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate id="form_date" default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="2"  tags="PMDT" /></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. End of Treatment Form">
		<div>	

		<p>
		End of Treatment date
		<br/>
		<obs id="treatment_end_date" conceptId="159431" defaultValue="today" required="true"/>
		</p>

		<p>
		Treatment Outcome date
		<br/>
		<obs id="date_treatment_outcome" conceptId="159787" defaultValue="today" required="true"/>
		</p>

		<p>
		Outcome:
		<br/>
		<obs id="treatment_outcome" conceptId="159786" answerConceptIds="159791,160035,160034,159874,160031,164791,164792" answerLabels="Cured,Completed,Died,Failed,Lost to followup,Not evaluated,Treatment adapted" defaultValue="159791" required="true"/>
		</p>

		<div id="display_died">
		<p>
		If died, then provide date of death:
		<br/>
		<obs id="date_death" conceptId="1543" />
		</p>

		<p>
		If died: then provide suspected primary cause of death:
		<br/>
		<obs id="primary_cause_death" conceptId="165144" answerConceptIds="165139,165140,165141,165142,165143,1067" answerLabels="TB immediate cause of death,Cause related to TB treatment,TB contributing to death,Surgery related death,Cause other than TB,Unknown" defaultValue="1067" />
		</p>
		</div>

		<div id="display_cause_death_other">
		<p>
		If primary cause of death other than TB, then specify:
		<br/>
		<obs id="cause_death_other" conceptId="165143" maxlength="100"/>
		</p>
		</div>

		<div id="diplay_reason_failure">
		<p>
		If failed, then reason for failure:
		<br/>
		<obs id="reason_failure" conceptId="165161" answerConceptIds="165149,165150,165154,165155,165668" answerLabels="Lack of conversion,Bacteriological reversion,Additional acquired resistance to FQ or injectables,Adverse drug reaction,Other" defaultValue="165149"  />
		</p>
		</div>

		<div id="diplay_reason_failure_other">
		<p>
		If reason for failure 'Other', then specify:
		<br/>
		<obs id="reason_failure_other" conceptId="165668" maxlength="100"  />
		</p>
		</div>

		<div id="display_reason_lost_followup">
		<p>
		If lost to follow-up, why was the patient's treatment interrupted?
		<br/>
		<obs id="reason_lost_followup" conceptId="161206" answerConceptIds="165156,112603,164340,165158,164295,165159,164482,1067" answerLabels="Patient refused followup,Substance abuse,Social problem,Left region/country,Adverse events,No confidence in treatment,Other,Unknown" defaultValue="165156"/>
		</p>
		</div>

		<div id="display_reason_lost_followup_other">
		<p>
		If reason for lost ot follow-up 'Other', then specify:
		<br/>
		<obs id="reason_follow_up_other" conceptId="164482" maxlength="255"  />
		</p>
		</div>

		<div id="display_not_evaluated">
		<p>
		If not evaluated, was the patient transferred out?
		<br/>
		<obs id="not_evaluated_transfer_out" conceptId="160036" answerConceptIds="1065,1066" answerLabels="Yes,No" defaultValue="1065" />
		</p>
		</div>

		<div id="display_not_evaluated_transfer_out_yes">
		<p>
		If transferred out, then to which facility?
		
		<select id="facility_list">			   
				    </select>
		<obs id="transfer_out_facility" conceptId="159495" />
		</p>
		</div>
		 
		<div id="display_transfer_out_facility_other">
		<p>
		If transfer out facility 'Other', then specify:
		<br/>
		<obs id="transfer_out_facility_other" conceptId="165693" maxlength="100" />
		</p>
		</div>

		<div id="display_not_evaluated_transfer_out_no">
		<p>
		If not transferred out, why does the patient have this outcome?
		<br/>
		<obs id="reason_not_evaluated_other" conceptId="165166" maxlength="255" />
		</p>
		</div>
		
		<div id="time_taken_div">
		<p> 
		Time taken to fill form
		<br/>
		<obs id="time_taken" conceptId="165044" />
		</p>
		</div>
		</div>
	</section>

	<submit/>
	
	<script type="text/javascript">
		var startDate = new Date();	
		
		//
		var died = jQuery("#display_died");
		var cause_death_other = jQuery("#display_cause_death_other");
		var reason_failure= jQuery("#diplay_reason_failure");
		var reason_failure_other= jQuery("#diplay_reason_failure_other");
		var reason_lost_followup= jQuery("#display_reason_lost_followup");
		var reason_lost_followup_other= jQuery("#display_reason_lost_followup_other");
		var not_evaluated= jQuery("#display_not_evaluated");
		var not_evaluated_transfer_out_yes= jQuery("#display_not_evaluated_transfer_out_yes");
		var transfer_out_facility_other= jQuery("#display_transfer_out_facility_other");
		var not_evaluated_transfer_out_no= jQuery("#display_not_evaluated_transfer_out_no");
		//

 
jQuery( document ).ready(function() {
		
		var timeTakenDiv = jQuery("#time_taken_div");
		timeTakenDiv.hide();
		getField("transfer_out_facility.value").prop("disabled", true);
		
		<ifMode mode='VIEW' include="false"> 
			
		doRest();
			
		if(getValue('treatment_outcome.value') == 160034 ){
			died.show();
		}
		else{
			died.hide();			
			cause_death_other.hide();			
		}
		
		if(getValue('treatment_outcome.value') == 159874 ){
			reason_failure.show();
		}
		else{
			reason_failure.hide();	
			reason_failure_other.hide();			
		}
		
		if(getValue('treatment_outcome.value') == 160031 ){
			reason_lost_followup.show();
		}
		else{
			reason_lost_followup.hide();	
			reason_lost_followup_other.hide();			
		}
		
		if(getValue('treatment_outcome.value') == 164791 ){
			not_evaluated.show();
		}
		else{
			not_evaluated.hide();			
		}
		
		if(getValue('treatment_outcome.value') == 164791 &amp;&amp; getValue('not_evaluated_transfer_out.value') == 1065 ){
			not_evaluated_transfer_out_yes.show();
		}
		else{
			not_evaluated_transfer_out_yes.hide();	
			transfer_out_facility_other.hide();			
		}
		
		//1
		if(getValue('treatment_outcome.value') == 164791 &amp;&amp; getValue('not_evaluated_transfer_out.value') == 1065 &amp;&amp; getValue('transfer_out_facility.value') == "OTHER" ){
			transfer_out_facility_other.show();
		}
		else{
			transfer_out_facility_other.hide();			
		}
		//1
		
		if(getValue('treatment_outcome.value') == 164791 &amp;&amp; getValue('not_evaluated_transfer_out.value') == 1066 ){
			not_evaluated_transfer_out_no.show();
		}
		else{
			not_evaluated_transfer_out_no.hide();			
		}
		
		</ifMode>
		
		});

function doRest(){
	jQuery.ajax({
		url: "/openmrs/ws/rest/v1/location?v=custom:(uuid,display,name,description)&amp;tag=PMDT",
		dataType: 'json'
		}).done(function(data ) {
			console.log(data.results[0].name);
			console.log(data.results.length);
			locationData = data;
			populate(data);
	});
}

function populate(data) {
						
	var s= document.getElementById('facility_list');
	
	for (i = 0; i &lt; data.results.length; i++) { 
		s.options[i+1]= new Option(data.results[i].description, data.results[i].name);                      
		var resultObject =  JSON.parse(JSON.stringify(data.results[i].description || null));
	}
}
     
function checkDate() {
	var endDate =getValue('treatment_end_date.value');
	var outcomeDate =getValue('date_treatment_outcome.value');
	
    endDate = new Date(endDate);
    outcomeDate = new Date(outcomeDate);
	
	endDate.setHours(0,0,0,0);
	outcomeDate.setHours(0,0,0,0);
	
	var timeDiff = outcomeDate.getTime() - endDate.getTime();
	var diffDays = Math.floor(timeDiff / (1000 * 3600 * 24));
  
	console.log("diffDays: "+diffDays);
	//true if diff is same day or more //false if diff is in negative
	if(diffDays &gt;= 0){
		return true;
	}
	else{
		return false;
	}
}

function getPatientDeathInfoAndPost(causeOfDeath,deathDate){
			var deathReasonUUid;
			jQuery.ajax({
				url: "/openmrs/ws/rest/v1/concept?q="+ causeOfDeath + "",
				dataType: 'json'
				}).done(function(data ) {			
				console.log("death reason uuid is : "+data.results[0]['uuid']);
				deathReasonUUid=data.results[0]['uuid'];
				getPatientIdAndSavePatientDeathInfo(deathReasonUUid,deathDate);
			});
			
			
}


function getPatientIdAndSavePatientDeathInfo(deathReasonUUid,deathDate){
		var patientId =  '<lookup expression="patient.getPatientIdentifier(3)"/>';
	
		jQuery.ajax({
				url: "/openmrs/ws/rest/v1/patient?q=" + patientId + "",
				dataType: 'json'
				}).done(function(data ) {
			
			savePatientDeathInfo(data.results[0]['uuid'],deathReasonUUid,deathDate);
			
			});
}

function savePatientDeathInfo(patientUuid,causeOfDeathUUid,deathDate) {
		console.log("patient uuid is: is " + patientUuid);
		console.log("patient deathdate: is " + deathDate);
		console.log("patient causedeath: is " + causeOfDeathUUid);
		jQuery.ajax({
				url: "/openmrs/ws/rest/v1/person/" + patientUuid,
				processData: false,
				type: "POST",
				data: JSON.stringify( 
					{
						"dead": true,
						"causeOfDeath": causeOfDeathUUid,
						"deathDate": deathDate
					}
				),
				contentType: "application/json"
				
				}).done(function(data ) {
					console.log(data['display']);
					
			});
}

jQuery(function() {
		getField('treatment_outcome.value').change(function() {
				
			if(getValue('treatment_outcome.value') == 160034 ){
				died.show();
			}
			else{
				setValue('date_death.value','');
				setValue('primary_cause_death.value','');
				died.hide();					
			}
			getField('primary_cause_death.value').change();
			
			if(getValue('treatment_outcome.value') == 159874 ){
				reason_failure.show();
			}
			else{
				setValue('reason_failure.value','');
				reason_failure.hide();			
			}
			
			getField('reason_failure.value').change();
					 	
			if(getValue('treatment_outcome.value') == 160031 ){
				reason_lost_followup.show();
			}
			else{
				setValue('reason_lost_followup.value','');
				reason_lost_followup.hide();			
			}
			
			getField('reason_lost_followup.value').change();

			if(getValue('treatment_outcome.value') == 164791 ){
				not_evaluated.show();
			}
			else{
				setValue('not_evaluated_transfer_out.value','');
				not_evaluated.hide();			
			}
			
			getField('not_evaluated_transfer_out.value').change();
				//
								
			});	
			
		getField('primary_cause_death.value').change(function() {
			
			if(getValue('primary_cause_death.value') == 165143 ){
				cause_death_other.show();
			}
			else{
				setValue('cause_death_other.value','');
				cause_death_other.hide();			
			}

		});
		
		getField('reason_failure.value').change(function() {
			
			if(getValue('reason_failure.value') == 165668 ){
				reason_failure_other.show();
			}
			else{
				setValue('reason_failure_other.value','');
				reason_failure_other.hide();			
			}
		});
				
		getField('reason_lost_followup.value').change(function() {
			
			if(getValue('reason_lost_followup.value') == 164482 ){
				reason_lost_followup_other.show();
			}
			else{
				setValue('reason_follow_up_other.value','');
				reason_lost_followup_other.hide();			
			}
		});
		
		 
		getField('not_evaluated_transfer_out.value').change(function() {
			
			if(getValue('not_evaluated_transfer_out.value') == 1065 ){
				not_evaluated_transfer_out_yes.show();
			}
			else{
				jQuery("#facility_list").val('');
				setValue('transfer_out_facility.value','');
				not_evaluated_transfer_out_yes.hide();
			}
			if(getValue('not_evaluated_transfer_out.value') == 1066 ){
				not_evaluated_transfer_out_no.show();
			}
			else{		
				setValue('reason_not_evaluated_other.value','');
				not_evaluated_transfer_out_no.hide();
			}
			getField('transfer_out_facility.value').change();
		});
		
		jQuery('#facility_list').change(function() {
			setValue('transfer_out_facility.value',jQuery("#facility_list").val());  
			getField('transfer_out_facility.value').change();
		});
		
		getField('transfer_out_facility.value').change(function() {
			if(getValue('transfer_out_facility.value') == "OTHER" ){
				transfer_out_facility_other.show();
			}
			else{
				setValue('transfer_out_facility_other.value',''); 
				transfer_out_facility_other.hide();
			}
		});
		
});
		
beforeSubmit.push(function() {
	
	setValue('primary_cause_death.error','');
	setValue('cause_death_other.error','');
	setValue('reason_failure.error','');
	setValue('reason_failure_other.error','');
	setValue('reason_lost_followup.error','');
	setValue('reason_follow_up_other.error','');
	setValue('not_evaluated_transfer_out.error','');
	setValue('transfer_out_facility.error','');
	setValue('transfer_out_facility_other.error','');
	setValue('reason_not_evaluated_other.error','');
	setValue('treatment_end_date.error','');
	setValue('date_treatment_outcome.error','');
	 		
	var valid=true;
	
	if( getValue('treatment_outcome.value') == 160034 &amp;&amp; getValue('primary_cause_death.value') =='' ) {	
		getField('primary_cause_death.error').html('Please select a value.').show();
		valid=false;		
	}
	else{
		getField('primary_cause_death.error').html('').hide();
	}

	if( getValue('treatment_outcome.value') == 160034 &amp;&amp; getValue('primary_cause_death.value') == 165143 &amp;&amp; getValue('cause_death_other.value') =='' ){	
		getField('cause_death_other.error').html('Please input a value.').show();
		valid=false;		
	}
	else{
		getField('cause_death_other.error').html('').hide();
	}
	 
	if( getValue('treatment_outcome.value') == 159874 &amp;&amp; getValue('reason_failure.value') =='' ) {	
		getField('reason_failure.error').html('Please select a value.').show();
		valid=false;		
	}
	else{
		getField('reason_failure.error').html('').hide();
	}
	
	if( getValue('treatment_outcome.value') == 159874 &amp;&amp; getValue('reason_failure.value') == 165668 &amp;&amp; getValue('reason_failure_other.value') =='' ){	
		getField('reason_failure_other.error').html('Please input a value.').show();
		valid=false;		
	}
	else{
		getField('reason_failure_other.error').html('').hide();
	}
	/////////////////////////////
	 
	if( getValue('treatment_outcome.value') == 160031 &amp;&amp; getValue('reason_lost_followup.value') =='' ) {	
		getField('reason_lost_followup.error').html('Please select a value.').show();
		valid=false;		
	}
	else{
		getField('reason_lost_followup.error').html('').hide();
	}
	
	if( getValue('treatment_outcome.value') == 160031 &amp;&amp; getValue('reason_lost_followup.value') == 164482 &amp;&amp; getValue('reason_follow_up_other.value') =='' ){	
		getField('reason_follow_up_other.error').html('Please input a value.').show();
		valid=false;		
	}
	else{
		getField('reason_follow_up_other.error').html('').hide();
	}
	
	/////////////////////////////////
	 
	if( getValue('treatment_outcome.value') == 164791 &amp;&amp; getValue('not_evaluated_transfer_out.value') =='' ) {	
		getField('not_evaluated_transfer_out.error').html('Please select a value.').show();
		valid=false;		
	}
	else{
		getField('not_evaluated_transfer_out.error').html('').hide();
	}
	
	if( getValue('treatment_outcome.value') == 164791 &amp;&amp; getValue('not_evaluated_transfer_out.value') == 1065 &amp;&amp; getValue('transfer_out_facility.value') =='' ){	
		getField('transfer_out_facility.error').html('Please select a value.').show();
		valid=false;		
	}
	else{
		getField('transfer_out_facility.error').html('').hide();
	}
	
	if( getValue('treatment_outcome.value') == 164791 &amp;&amp; getValue('not_evaluated_transfer_out.value') == 1065 &amp;&amp; getValue('transfer_out_facility.value') =='OTHER' &amp;&amp; getValue('transfer_out_facility_other.value') ==''){	
		getField('transfer_out_facility_other.error').html('Please input a value.').show();
		valid=false;		
	}
	else{
		getField('transfer_out_facility_other.error').html('').hide();
	}
	
	if( getValue('treatment_outcome.value') == 164791 &amp;&amp; getValue('not_evaluated_transfer_out.value') == 1066 &amp;&amp; getValue('reason_not_evaluated_other.value') =='' ){	
		getField('reason_not_evaluated_other.error').html('Please input a value.').show();
		valid=false;		
	}
	else{
		getField('reason_not_evaluated_other.error').html('').hide();
	}
	
///
	if(getValue('treatment_end_date.value')==''){
		getField('treatment_end_date.error').html('Please select a Date').show();						
		valid = false;
	}else{
		getField('treatment_end_date.error').html('').hide(); 
	}
	
	if(getValue('date_treatment_outcome.value')==''){
		getField('date_treatment_outcome.error').html('Please select a Date').show();						
		valid = false;
	}else{
		getField('date_treatment_outcome.error').html('').hide(); 
	}
	
	if(valid){
		if(!checkDate()){
			getField('date_treatment_outcome.error').html('Date of treatment Outcome can not be before End of treatment Date. Please select correct Date').show();						
			valid = false;
		}
		else{
			getField('date_treatment_outcome.error').html('').hide(); 
		}
	}
///	
		

	if(valid==true){
	
	//mark patient dead
	if( getValue('treatment_outcome.value') == 160034 &amp;&amp; getValue('primary_cause_death.value') !='' ) {	
		var deathReason=jQuery("#w16 option:selected").text();
		console.log("Death reason is "+deathReason);
		
		var deathDate=getValue('date_death.value');
		if (  deathDate =="" || deathDate== null ){
			console.log("getting encounter date");
			deathDate=getValue('form_date.value');
		}
		getPatientDeathInfoAndPost(deathReason,deathDate);

	}
	//
	
	//
	getField("transfer_out_facility.value").prop("disabled", false);
	
	//remove default values
		if(getValue('treatment_outcome.value') != 160034){
			setValue('primary_cause_death.value','');
		}
		if(getValue('treatment_outcome.value') != 159874 ){
			setValue('reason_failure.value','');
		}
		if(getValue('treatment_outcome.value') != 160031 ){
			setValue('reason_lost_followup.value','');
		}
		if(getValue('treatment_outcome.value') != 164791 ){
			setValue('not_evaluated_transfer_out.value','');		
		}
		
	//remove other field text if not selected
		//2
		if( !(getValue('treatment_outcome.value') == 164791 &amp;&amp; getValue('not_evaluated_transfer_out.value') == 1065 &amp;&amp; getValue('transfer_out_facility.value') == "OTHER" ) ){
			setValue('transfer_out_facility_other.value','');
		}
		//2
	
		var timeTakenDiv = $j("#time_taken_div");
		
		var endDate = new Date();
		var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
		var diffSec = timeDiff/1000;
		
		timeTakenDiv.show();
		setValue("time_taken.value",diffSec);
		timeTakenDiv.hide();
		
		return true;
	}
	return false;
});
		
</script>
</htmlform>