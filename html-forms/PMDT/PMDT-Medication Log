<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PMDT-Medication Log (v0.0.1)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="2"  tags="PMDT" /></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Medication Log">
		<div>	

			<p>
			Number of TB drugs to be added
			<br/>
			<obs id="tb_drugs_count" conceptId="165043" required="true"/>
			</p>
			
			
			<div id="repeat_container_tb_regimen">
			<repeat>
			<template>
			 
			<div id="{n}-toggleContainer_tb_regimen" class="{n}-toggleContainer_tb_regimen"   >
			<b><label>{n}-TB drugs details</label></b> <br/>
			
			<obsgroup groupingConceptId="166107">
		
			<p>
			TB Drug name
			<br/>
			<obs id="{n}-tb_regimen" conceptId="160021"  class="tbRegimen"
			answerConceptIds = "71060,450,163143,72794,73449,73498,73581,74123,163144,75948,75976,76835,76862,164086,104315,78280,78385,78788,78879,79611,80133,80363,80792,81022,81457,81458,82772,82900,82912,83352,767,83360,84206,84360,84836,160019,160020,164805"
			answerLabels="Amikacin,Amoxicillin and Clavulanate acid,Bedaquiline,Capreomycin,Ciprofloxacin,Clarithromycin,Clofazimine,Cycloserine,Delamanid,Ethambutol,Ethionamide,Gatifloxacin,Gemifloxacin,High Dose Isoniazid,Imipenem and cilastatin,Isoniazid,Kanamycin,Levofloxacin,Linezolid,Meropenem,Moxifloxacin,Nalidixic Acid,Norfloxacin,Ofloxacin,P-Aminosalicylic Acid,P-Aminosalicylic Acid Monosodium,Prothionamide,Pyrazinamide,Pyridoxine,Rifabutin,Rifampicin,Rifapentine,Sparfloxacin,Streptomycin,Terizidone,Thioacetazone,Viomycin,OTHER TB DRUGS"
			/>
			</p>
			
			<div id="{n}-display_tb_regimen_other">
			<p>
			If 'other' tb drug, then specify: 
			<br/>
			<obs id="{n}-tb_regimen_other" conceptId="164805"   maxlength="50"  />
			</p>
			</div>

			<p>
			Instructions
			<br/>
			<obs id="{n}-additional_instructions" conceptId="165082" maxlength="250" style="textarea"/>
			</p>
			
			</obsgroup>
			
				<label>---------------------------------------------------------------------------------------------------</label>
			</div>
			</template>
			<render n="1" />
			<render n="2" />
			<render n="3" />
			<render n="4" />
			<render n="5" />
			<render n="6" />
			<render n="7" />
			<render n="8" />
			<render n="9" />
			<render n="10" />
			</repeat>
			</div>

				<label>---------------------------------------------------------------------------------------------------</label>
			
			<p>
			Number of non TB drugs to be added
			<br/>
			<obs id="non_tb_count" conceptId="166099" required="true"/>
			</p>
			
			<div id="repeat_container_non_tb_regimen">
			<repeat>
			<template>
			 
			<div id="{n}-toggleContainer_non_tb_regimen" class="{n}-toggleContainer_non_tb_regimen"   >
			<b><label>{n}-Non TB drugs details</label></b> <br/>
			
			<obsgroup groupingConceptId="166108">
			
			
			<p>
			Non TB Drug name
			<br/>
			<obs id="{n}-non_tb_regimen" conceptId="165051"  class="nontbRegimen"
			answerConceptIds = "166117,166121,166122,166113,76613,166119,159459,79651,166116,166114,166110,166118,166112,798,166111,166120,166115,166109,166123"
			/>
			</p>
			
			<div id="{n}-display_non_tb_regimen_other">
			<p>
			If 'other' non tb drug, then specify: 
			<br/>
			<obs id="{n}-non_tb_regimen_other" conceptId="166123"   maxlength="50"  />
			</p>
			</div>

			<p>
			Instructions
			<br/>
			<obs id="{n}-non_tb_additional_instructions" conceptId="166106" maxlength="250" style="textarea" />
			</p>

			
			</obsgroup>
			
			
				<label>---------------------------------------------------------------------------------------------------</label>
			</div>
			</template>
			<render n="1" />
			<render n="2" />
			<render n="3" />
			<render n="4" />
			<render n="5" />
			<render n="6" />
			<render n="7" />
			<render n="8" />
			<render n="9" />
			<render n="10" />
			</repeat>
			</div>

		
			<div id="time_taken_div">
			<p> 
			Time taken to fill form
			<br/>
			<obs id="time_taken" conceptId="165044" />
			</p>
			</div>
		</div>
	</section>

	<submit/>
	
	<script type="text/javascript">
		var startDate = new Date();	
	
	    var repeat_container_tb_regimen = jQuery("#repeat_container_tb_regimen");
		var repeat_container_non_tb_regimen = jQuery("#repeat_container_non_tb_regimen");
		
		var repeatLimit=11;

jQuery( document ).ready(function() {

		var timeTakenDiv = jQuery("#time_taken_div");
		timeTakenDiv.hide();
		
///////////////////////////////////////////////////////////////////////////////////////////////////////
		//repeat logic start
		
		<ifMode mode='VIEW' include="false"> 					
			//show  repeat box acc to value of tb_drugs_count
			if(getValue('tb_drugs_count.value') &gt; 0 ){
				repeat_container_tb_regimen.show();
			}			
			else{
				repeat_container_tb_regimen.hide();
			}		
			
			if(getValue('non_tb_count.value') &gt; 0 ){
				repeat_container_non_tb_regimen.show();
			}			
			else{
				repeat_container_non_tb_regimen.hide();
			}
			
		</ifMode>
		
		<ifMode mode='ENTER' include="true"> 					
			//show 1st repeat box and hide all others in enter mode as values are not retrived 
			for(var i=2; i &lt; repeatLimit; i++ ){
				jQuery("#"+i+"-toggleContainer_tb_regimen").toggle(false);
			}
			//show 1st repeat box and hide all others in enter mode as values are not retrived 
			for(var i=2; i &lt; repeatLimit; i++ ){
				jQuery("#"+i+"-toggleContainer_non_tb_regimen").toggle(false);
			}

		</ifMode>
		
		<ifMode mode='EDIT' include="true"> 				
			
			//show and hide repeat boxes acc to values as values are retrived during EDIT mode
			for(var i=1; i &lt; repeatLimit; i++ ){
				if( getValue((i)+'-tb_regimen.value') == "" ){
					jQuery("#"+i+"-toggleContainer_tb_regimen").toggle(false);
				}
				else{
					jQuery("#"+i+"-toggleContainer_tb_regimen").toggle(true);
				}
			}  
			
			for(var i=1; i &lt; repeatLimit; i++ ){
				//show/hide fields to acc to values
				tbRegimenChange(i+"-");
			}
		
			//show and hide repeat boxes acc to values as values are retrived during EDIT mode
			for(var i=1; i &lt; repeatLimit; i++ ){
				if( getValue((i)+'-non_tb_regimen.value') == "" ){
					jQuery("#"+i+"-toggleContainer_non_tb_regimen").toggle(false);
				}
				else{
					jQuery("#"+i+"-toggleContainer_non_tb_regimen").toggle(true);
				}
			}  
			
			
			for(var i=1; i &lt; repeatLimit; i++ ){
				//show/hide fields to acc to values
				nontbRegimenChange(i+"-");
			}
			
		</ifMode>
		
		<ifMode mode='View' include="true">
			//show and hide repeat boxes acc to values 		
			for(var i=1; i &lt; repeatLimit; i++ ){
				if(jQuery("#"+i+'-tb_regimen > span ').hasClass('value'))
				{
					jQuery("#"+i+"-toggleContainer_tb_regimen").toggle(true);
				}
				else{
					jQuery("#"+i+"-toggleContainer_tb_regimen").toggle(false);
				}
				jQuery("#"+1+"-toggleContainer_tb_regimen").toggle(true);// visible only first in view mode
			}	

			for(var i=1; i &lt; repeatLimit; i++ ){
				if(jQuery("#"+i+'-non_tb_regimen > span ').hasClass('value'))
				{
					jQuery("#"+i+"-toggleContainer_non_tb_regimen").toggle(true);
				}
				else{
					jQuery("#"+i+"-toggleContainer_non_tb_regimen").toggle(false);
				}
				jQuery("#"+1+"-toggleContainer_non_tb_regimen").toggle(true);// visible only first in view mode
			}			
		
		</ifMode>
	
		
		});
		
<ifMode mode='VIEW' include="false">


	//hide and show other drug based on other selection		
	$j(document).ready(function(){
      $j('.tbRegimen').change(function() {
				tbRegimenChange(this.id);
     });
	});
	
	function tbRegimenChange(idNo){
		var res = idNo.split("-");
		var n=res[0];
		    
		if(getValue(n+'-tb_regimen.value') == 164805 ){
			jQuery("#"+n+"-display_tb_regimen_other").show();
		}
		else{		
			setValue(n+'-tb_regimen_other.value', "");  
			jQuery("#"+n+"-display_tb_regimen_other").hide();				
		}
	}	
	
	
	//hide and show other drug based on other selection		
	$j(document).ready(function(){
      $j('.nontbRegimen').change(function() {
				nontbRegimenChange(this.id);
     });
	});
	
	function nontbRegimenChange(idNo){
		var res = idNo.split("-");
		var n=res[0];
		    
		if(getValue(n+'-non_tb_regimen.value') == 166123 ){
			jQuery("#"+n+"-display_non_tb_regimen_other").show();
		}
		else{		
			setValue(n+'-non_tb_regimen_other.value', "");  
			jQuery("#"+n+"-display_non_tb_regimen_other").hide();				
		}
	}	
	
	
	
</ifMode>		
//repeat logic end
	//////////////////////////////////////////////////////////////////////////////////////////////////////////	
	

jQuery(function() {
			//repeat logic start
			///////////////////////////////////////////////////////////////////////////
			getField('tb_drugs_count.value').change(function() {	
				var count= parseInt(getValue('tb_drugs_count.value'));
				
				if(count &gt; 0 &amp;&amp; count &lt; 11  ){
				
					//hide repeat boxes above count 
					for(var j=(count+1); j &lt; repeatLimit; j++ ){
					//set values to empty
						setValue((j)+'-tb_regimen.value','');
						setValue((j)+'-tb_regimen_other.value','');
						setValue((j)+'-additional_instructions.value','');
						
						//set values to acc to values
						tbRegimenChange(j+"-");
						jQuery("#"+j+"-toggleContainer_tb_regimen").toggle(false);
					}
					//show repeat boxes acc to range
					for(var i=1; i &lt; (count+1); i++ ){
						//set values to acc to values
						tbRegimenChange(i+"-");
						jQuery("#"+i+"-toggleContainer_tb_regimen").toggle(true);//
					}
					repeat_container_tb_regimen.show();
				}
				//alert messages on out of range count
				else if(count &gt; 10 ){
					alert("please put value between 1-10");
				}
				//hide all boxes on not selecting count value or when count=0;
				else{
					for(var i=1; i &lt; repeatLimit; i++ ){
						//set values to empty
						setValue((i)+'-tb_regimen.value','');
						setValue((i)+'-tb_regimen_other.value','');
						setValue((i)+'-additional_instructions.value','');
						
						tbRegimenChange(i+"-");
						jQuery("#"+i+"-toggleContainer_tb_regimen").toggle(false);
					}
					repeat_container_tb_regimen.hide();
				}
				
			});
						
			///////////////////////////////////////////////////////////////////////////
			getField('non_tb_count.value').change(function() {	
				var count= parseInt(getValue('non_tb_count.value'));
				
				if(count &gt; 0 &amp;&amp; count &lt; 11  ){
				
					//hide repeat boxes above count 
					for(var j=(count+1); j &lt; repeatLimit; j++ ){
					//set values to empty
						setValue((j)+'-non_tb_regimen.value','');
						setValue((j)+'-non_tb_regimen_other.value','');
						setValue((j)+'-non_tb_additional_instructions.value','');
						
						//set values to acc to values
						nontbRegimenChange(j+"-");
						jQuery("#"+j+"-toggleContainer_non_tb_regimen").toggle(false);
					}
					//show repeat boxes acc to range
					for(var i=1; i &lt; (count+1); i++ ){
						//set values to acc to values
						nontbRegimenChange(i+"-");
						jQuery("#"+i+"-toggleContainer_non_tb_regimen").toggle(true);//
					}
					repeat_container_non_tb_regimen.show();
				}
				//alert messages on out of range count
				else if(count &gt; 10 ){
					alert("please put value between 1-10");
				}
				//hide all boxes on not selecting count value or when count=0;
				else{
					for(var i=1; i &lt; repeatLimit; i++ ){
						//set values to empty
						setValue((i)+'-non_tb_regimen.value','');
						setValue((i)+'-non_tb_regimen_other.value','');
					
						setValue((i)+'-non_tb_additional_instructions.value','');
						
						nontbRegimenChange(i+"-");
						jQuery("#"+i+"-toggleContainer_non_tb_regimen").toggle(false);
					}
					repeat_container_non_tb_regimen.hide();
				}
				
			});
			//repeat logic end
			//////////////////////////////////////////////////////////////////////////////


});
		
beforeSubmit.push(function() {

	///
	var valid=true;
	var tbDrugs = [];
	var tbDrugsCount=0;
	var nonTbDrugs = [];
	var nonTbDrugsCount=0;
	
	var drugs_count=getValue('tb_drugs_count.value');

	if( drugs_count.trim() == ""  || getValue('tb_drugs_count.value') == null)
	{
		getField('tb_drugs_count.error').html('This field can not be empty').show();
		valid=false;
	}
	else if(!(drugs_count.match(/^\d+$/))){
		getField('tb_drugs_count.error').html('Not an integer').show();
		valid=false;
	}
	else if( drugs_count &lt; 0  ){
        getField('tb_drugs_count.error').html('Cannot be less than 0').show();
		valid=false;	
	}
	else if( drugs_count &gt; 10  ){
        getField('tb_drugs_count.error').html('Cannot be greater than 10').show();
		valid=false;	
	}
	
	////
	var non_tb_drugs_count=getValue('non_tb_count.value');
	
	if( non_tb_drugs_count.trim() == ""  || getValue('non_tb_count.value') == null)
	{
		getField('non_tb_count.error').html('This field can not be empty').show();
		valid=false;
	}
	else if(!(non_tb_drugs_count.match(/^\d+$/))){
		getField('non_tb_count.error').html('Not an integer').show();
		valid=false;
	}
	else if( non_tb_drugs_count &lt; 0  ){
        getField('non_tb_count.error').html('Cannot be less than 0').show();
		valid=false;	
	}
	else if( non_tb_drugs_count &gt; 10  ){
        getField('non_tb_count.error').html('Cannot be greater than 10').show();
		valid=false;	
	}
	
	//
	
if(valid){	
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//repeat logic start
	//tb drugs
	for(var i=1; i &lt; repeatLimit; i++ ){
		setValue((i)+'-tb_regimen.error','');
		setValue((i)+'-tb_regimen_other.error','');
		setValue((i)+'-additional_instructions.error','');

	}
	//empty all values on not selecting count value or when count=0;
	if( ! (getValue('tb_drugs_count.value') &gt; 0) ){
		for(var i=1; i &lt; repeatLimit; i++ ){
			//set values to empty
			setValue((i)+'-tb_regimen.value','');
			setValue((i)+'-tb_regimen_other.value','');
			setValue((i)+'-additional_instructions.value','');
		}
	}
	
	//check validation on repeat boxes
	if(getValue('tb_drugs_count.value') &gt; 0) {
	 
		for(var i=1; i &lt; repeatLimit; i++ ){
			if(jQuery("#"+(i)+"-toggleContainer_tb_regimen").is(":visible") &amp;&amp; getValue((i)+'-tb_regimen.value') == "" ){
				getField((i)+'-tb_regimen.error').html('Please select a value.').show();
				valid=false;
			}
			else {
				getField((i)+'-tb_regimen.error').html('').hide();
			}
		}
		
		for(var i=1; i &lt; repeatLimit; i++ ){
			if( jQuery("#"+(i)+"-toggleContainer_tb_regimen").is(":visible") &amp;&amp; getValue((i)+'-tb_regimen.value') == 164805
			    &amp;&amp; getValue((i)+'-tb_regimen_other.value') == "" ){
				getField((i)+'-tb_regimen_other.error').html('Please input a value.').show();
				valid=false;
			}
			else {
				getField((i)+'-tb_regimen_other.error').html('').hide();
			}
		}
		
	}
	
	//check if already selected drug  is selected again
	if(getValue('tb_drugs_count.value') &gt; 0) {
		for(var i=1; i &lt; repeatLimit; i++ ){
			if(jQuery("#"+(i)+"-toggleContainer_tb_regimen").is(":visible") &amp;&amp; getValue((i)+'-tb_regimen.value') != "" ){
				if(checkIfAlreadySelected(tbDrugs,getValue((i)+'-tb_regimen.value'))){
					getField((i)+'-tb_regimen.error').html('Please select another value. It is already Selected.').show();
					valid=false;
				}
				//save value for future campare
				tbDrugs[tbDrugsCount]= getValue((i)+'-tb_regimen.value');
				tbDrugsCount++;
			}
		}
	}
	
	//remove values from hidden boxes
	for(var i=1; i &lt; repeatLimit; i++ ){
		//set values to empty
		if( ! jQuery("#"+(i)+"-toggleContainer_tb_regimen").is(":visible") ){
			//set values to empty
			setValue((i)+'-tb_regimen.value','');
			setValue((i)+'-tb_regimen_other.value','');
			setValue((i)+'-additional_instructions.value','');
		}
	}
/////////////////////////////////////////////////////////////////
//nont tb drugs

	for(var i=1; i &lt; repeatLimit; i++ ){
		setValue((i)+'-non_tb_regimen.error','');
		setValue((i)+'-non_tb_regimen_other.error','');
		setValue((i)+'-non_tb_additional_instructions.error','');

	}
	//empty all values on not selecting count value or when count=0;
	if( ! (getValue('non_tb_count.value') &gt; 0) ){
		for(var i=1; i &lt; repeatLimit; i++ ){
			//set values to empty
			setValue((i)+'-non_tb_regimen.value','');
			setValue((i)+'-non_tb_regimen_other.value','');
			setValue((i)+'-non_tb_additional_instructions.value','');
		}
	}
	
	//check validation on repeat boxes
	if(getValue('non_tb_count.value') &gt; 0) {
	 
		for(var i=1; i &lt; repeatLimit; i++ ){
			if(jQuery("#"+(i)+"-toggleContainer_non_tb_regimen").is(":visible") &amp;&amp; getValue((i)+'-non_tb_regimen.value') == "" ){
				getField((i)+'-non_tb_regimen.error').html('Please select a value.').show();
				valid=false;
			}
			else {
				getField((i)+'-non_tb_regimen.error').html('').hide();
			}
		}
		
		for(var i=1; i &lt; repeatLimit; i++ ){
			if( jQuery("#"+(i)+"-toggleContainer_non_tb_regimen").is(":visible") &amp;&amp; getValue((i)+'-non_tb_regimen.value') == 166123
			    &amp;&amp; getValue((i)+'-non_tb_regimen_other.value') == "" ){
				getField((i)+'-non_tb_regimen_other.error').html('Please input a value.').show();
				valid=false;
			}
			else {
				getField((i)+'-non_tb_regimen_other.error').html('').hide();
			}
		}
		
	}
	
	//check if already selected drug  is selected again
	if(getValue('non_tb_count.value') &gt; 0) {
		for(var i=1; i &lt; repeatLimit; i++ ){
			if(jQuery("#"+(i)+"-toggleContainer_non_tb_regimen").is(":visible") &amp;&amp; getValue((i)+'-non_tb_regimen.value') != "" ){
				if(checkIfAlreadySelected(nonTbDrugs,getValue((i)+'-non_tb_regimen.value'))){
					getField((i)+'-non_tb_regimen.error').html('Please select another value. It is already Selected.').show();
					valid=false;
				}
				//save value for future campare
				nonTbDrugs[nonTbDrugsCount]= getValue((i)+'-non_tb_regimen.value');
				nonTbDrugsCount++;
			}
		}
	}

	
	//remove values from hidden boxes
	for(var i=1; i &lt; repeatLimit; i++ ){
		//set values to empty
		if( ! jQuery("#"+(i)+"-toggleContainer_non_tb_regimen").is(":visible") ){
			//set values to empty
			setValue((i)+'-non_tb_regimen.value','');
			setValue((i)+'-non_tb_regimen_other.value','');
			setValue((i)+'-non_tb_additional_instructions.value','');
		}
	}


////////////////////////////////////////////////////////////

	//repeat logic end
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	if(valid==true){
			var timeTakenDiv = $j("#time_taken_div");
			
			var endDate = new Date();
			var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
			var diffSec = timeDiff/1000;
			
			timeTakenDiv.show();
			setValue("time_taken.value",diffSec);
			timeTakenDiv.hide();
		
			return true;
	}
}
	return false;
});
	
function checkIfAlreadySelected(myArray,value) {
	isAlreadyExit=false;
	for(var i=0; i &lt; myArray.length; i++ ){
		if(myArray[i]==value){
			isAlreadyExit=true;
		}
	}
	return isAlreadyExit;
}	
</script>
</htmlform>