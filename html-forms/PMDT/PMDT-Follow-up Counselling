<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PMDT-Follow-up Counselling (v0.2.0)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="2"  tags="PMDT" /></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Follow-up Counselling Form">
		<div>	

			<p>
			Date of assessment
			<br/>
			<obs id="date_assessment" conceptId="165469" defaultValue="today" required="true"/>
			</p>

			<p>
			Type of assessment
			<br/>
			<obs id="assessment_type" conceptId="165103" answerConceptIds="165035,165039,165040,165036,165041,165042" 
			answerLabels="Treatment initiation,Two week assessment,Planned monthly assessment,Other assessment,End of treatment assessment,Post-treatment assessment" 
			defaultValue="165040" required="true"/>
			</p>

			<div id="display_other_assessment">
			<p>
			Other assessment reason
			<br/>
			<obs id="other_assessment" conceptId="165036" maxlength="100" />
			</p>
			</div>

			<div id="display_followup_month">
			<p>
			Month of treatment
			<br/>
			<obs id="followup_month" conceptId="164327" maxlength="2"/>
			</p>
			</div>

			<div id="display_treatment_outcome">
			<p>
			Treatment Outcome
			<br/>
			<obs id="treatment_outcome" conceptId="159786" />
			</p>
			</div>

			<div id="display_tb_treatment_phase">
			<p>
			Treatment phase
			<br/>
			<obs id="tb_treatment_phase" conceptId="159792" answerConceptIds="164439,159794,1175" 
			answerLabels="Intensive phase,Continuation phase,Not Applicable" defaultValue="164439" />
			</p>
			</div>

			<includeIf velocityTest="$patient.age &lt; 15 ">
			<p>
			Counseling provided to:
			<br/>
			<obs id="counselling" conceptId="164262" answerConceptIds="978,1527,160639,970,971,160723,160724,160726,160725,160729,160730,160727,160728,5617,975,974,5620" 
			answerLabels="Self,Parent,Guardian,Mother,Father,Maternal Grandmother,Maternal Grandfather,Paternal Grandmother,Paternal Grandfather,Brother,Sister,Son,Daughter,Spouse,Aunt,Uncle,Other" 
			defaultValue="978" required="true"/>
			</p>
			
			<div id="display_counselling_other">
			<p>
			If relationship 'other', then specify:
			<br/>
			<obs id="counselling_other" conceptId="5620" maxlength="25" />
			</p>
			</div>
			</includeIf>			
		</div>
		</section>
			
		<section headerLabel="3. Disease Information">
		<div>	

			
			<p>
			Disease site
			<br/>		
			<obsgroup  id="tb_type" groupingConceptId="160040" >
				<obs id="pulmonary" conceptId="160040"  answerConceptId= "42" answerLabel="Pulmonary" style="checkbox"  /><br/>
				<obs id="extra_pulmonary" conceptId="160040" answerConceptId= "5042" answerLabel="Extra Pulmonary" style="checkbox" />
			</obsgroup>
			</p>

			<p>
			Disease site: Extrapulmonary exact site:
			<br/>
			<obs id="extra_pulmonary_site" conceptId="164430"   />
			</p>

			<p>
			Drug resistance profile
			<br/>
			<obs id="drug_resistance_profile" conceptId="165029"  />
			</p>

			<p>
			Subclassification for confimed drug resistant cases
			<br/>
			<obs id="drug_resistant_profile_class" conceptId="165025"  />
			</p>

			<p>
			Reason for counselling:
			<br/>
			<obs id="reason_followup_counseling" conceptId="165613" answerConceptIds="165611,165612" 
			answerLabels="Scheduled counseling,Patient referred for counseling" required="true"/>
			</p>

			<div id="display_referral_complaint_by_field_team">
			<p>
			Referral complaint by field team:
			<br/>		
			<div id="display_referral_complaint_by_field_team_child">
			<obsgroup  id="referral_complaint_by_field_team" groupingConceptId="164554" >
				<obs id="adherence" conceptId="164554"  answerConceptId= "164553" answerLabel="Adherence" style="checkbox"  /><br/>
				<obs id="infection_control" conceptId="164554"  answerConceptId= "164339" answerLabel="Infection control" style="checkbox"  /><br/>
				<obs id="adverse_events" conceptId="164554"  answerConceptId= "164295" answerLabel="Adverse events" style="checkbox"  /><br/>
				<obs id="psycho_social_issues" conceptId="164554"  answerConceptId= "5490" answerLabel="Psycho-social issues" style="checkbox"  /><br/>
				<obs id="substance_abuse" conceptId="164554"  answerConceptId= "112603" answerLabel="Substance abuse" style="checkbox"  /><br/>
				<obs id="other_counseling_type" conceptId="164554"  answerConceptId= "164558" answerLabel="Other" style="checkbox"  /><br/>
			</obsgroup>
			</div>
			</p>
			</div>
			
			<div id="display_other_referral_complaint_by_field_team">
			<p>
			Other referral complaint by field team:
			<br/>
			<obs id="other_referral_complaint_by_field_team" conceptId="164558"  />
			</p>
			</div>

			<p>
			AKUADS Result
			<br/>
			<obs id="akuads_score" conceptId="164586" />
			</p>


			
			
			<div id="display_ae">
			<p>
			Adverse effects reported by the patient during this visit
			<br/>
			<div id="display_ae_child">
				<obsgroup  id="adverse_events" groupingConceptId="164295" >					
					<obs conceptId="164295" id="vomiting" answerConceptId= "122983" answerLabel="Vomiting" style="checkbox" defaultValue="122983" /><br/>						
					<obs conceptId="164295" id="head" answerConceptId= "139084" answerLabel="Headache and Clavulanate acid" style="checkbox" /><br/>					
					<obs conceptId="164295" id="diarhea" answerConceptId= "142412" answerLabel="Diarrhea" style="checkbox" /><br/>					 
					<obs conceptId="164295" id="behave" answerConceptId= "165616" answerLabel="Behavioural change" style="checkbox" /><br/>						 
					<obs conceptId="164295" id="art" answerConceptId= "80" answerLabel="Arthralgia (Joint Pain)" style="checkbox" /><br/>						 
					<obs conceptId="164295" id="delusion" answerConceptId= "142600" answerLabel="Delusion" style="checkbox" /><br/>						 
					<obs conceptId="164295" id="hear" answerConceptId= "139075" answerLabel="Hearing impaired" style="checkbox" /><br/>						 
					<obs conceptId="164295" id="loss" answerConceptId= "135595" answerLabel="Loss of Apetite" style="checkbox" /><br/>						 
					<obs conceptId="164295" id="skin" answerConceptId= "120" answerLabel="Skin allergies" style="checkbox" /><br/>						 
					<obs conceptId="164295" id="nausea" answerConceptId= "5978" answerLabel="Nausea" style="checkbox" /><br/>	
					<obs conceptId="164295" id="tin" answerConceptId= "123588" answerLabel="Tinnitus" style="checkbox" /><br/>		
					<obs conceptId="164295" id="hal" answerConceptId= "139146" answerLabel="Hallucination" style="checkbox" /><br/>	
					<obs conceptId="164295" id="weak" answerConceptId= "5226" answerLabel="Weakness" style="checkbox" /><br/>		
					<obs conceptId="164295" id="depress" answerConceptId= "119537" answerLabel="Depression" style="checkbox" /><br/>	
					<obs conceptId="164295" id="ins" answerConceptId= "116743" answerLabel="Insomnia" style="checkbox" /><br/>	
					<obs conceptId="164295" id="deaf" answerConceptId= "139075" answerLabel="Deafness" style="checkbox" /><br/>	
					<obs conceptId="164295" id="fever" answerConceptId= "140238" answerLabel="Fever" style="checkbox" /><br/>		
					<obs conceptId="164295" id="vertigo" answerConceptId= "111525" answerLabel="Vertigo" style="checkbox" /><br/>	
					<obs conceptId="164295" id="anx" answerConceptId= "121543" answerLabel="Anxiety" style="checkbox" /><br/>
					<obs conceptId="164295" id="weight_loss" answerConceptId= "832" answerLabel="Weight loss" style="checkbox" /><br/>	
					<obs conceptId="164295" id="other_adverse_event" answerConceptId= "164294" answerLabel="Other" style="checkbox" /><br/>	
					<obs conceptId="164295" id="none" answerConceptId= "1107" answerLabel="None" style="checkbox" /><br/>						
				</obsgroup>	
			</div>
			</p>
		    </div>

			<div id="display_adverse_event_other">
			<p>
			If other, then specify:
			<br/>
			<obs id="adverse_event_other" conceptId="164294" maxlength="25" />
			</p>
			</div>
	
			<div id="display_occupational_problem">
			<p>
			Occupational problems
			<br/>
			<div id="display_occupational_problem_child">
				<obsgroup  id="occupational_problem" groupingConceptId="165620" >					
					<obs conceptId="165620" id="loss_of_job" answerConceptId= "165617" answerLabel="Loss of job due to continuous sickness and absence." style="checkbox"  /><br/>						
					<obs conceptId="165620" id="termination" answerConceptId= "165618" answerLabel="Termination of job due to TB." style="checkbox" defaultValue="165618" /><br/>					
					<obs conceptId="165620" id="diffiulty" answerConceptId= "165619" answerLabel="Difficulty using mask at work" style="checkbox" /><br/>			
				</obsgroup>	
			</div>
			</p>
		    </div>
								
			<div id="display_relation_problem">
			<p>
			Relationship problems
			<br/>
			<div id="display_relation_problem_child">
				<obsgroup  id="relation_problem" groupingConceptId="113353" >					
					<obs conceptId="113353" id="marital_issue" answerConceptId= "134660" answerLabel="Marital issues Husband/Wife (physical contact)" style="checkbox"  /><br/>						
					<obs conceptId="113353" id="issues_with_laws" answerConceptId= "165621" answerLabel="Issues with In laws" style="checkbox"  /><br/>					
					<obs conceptId="113353" id="divorce" answerConceptId= "165622" answerLabel="Divorce" style="checkbox" defaultValue="165622" /><br/>
					<obs conceptId="113353" id="separation" answerConceptId= "126729" answerLabel="Separation" style="checkbox" /><br/>	
					<obs conceptId="113353" id="other_relation_problem" answerConceptId= "165677" answerLabel="Other" style="checkbox" /><br/>						
				</obsgroup>	
			</div>
			</p>
		    </div>

			<div id="display_relation_problem_other">
			<p>
			If other, then specify
			<br/>
			<obs id="relation_problem_other" conceptId="165677" maxlength="50" />
			</p>
			</div>
			
			<div id="display_psych_environmental_problem">
			<p>
			Psychosocial and enviroment problems
			<br/>
			<div id="display_psych_environmental_problem_child">
				<obsgroup  id="psych_environmental_problem" groupingConceptId="165626" >					
					<obs conceptId="165626" id="none_problem" answerConceptId= "1107" answerLabel="None" style="checkbox" defaultValue="1107" /><br/>						
					<obs conceptId="165626" id="parental_negligence" answerConceptId= "165623" answerLabel="Parental negligence towards child and treatment." style="checkbox"  /><br/>					
					<obs conceptId="165626" id="parental_death_divorce" answerConceptId= "165627" answerLabel="Parental: death&amp;comma; separation or divorce" style="checkbox"  /><br/>
					<obs conceptId="165626" id="abuse" answerConceptId= "165624" answerLabel="Sexual&amp;comma;physical&amp;comma;verbal abuse." style="checkbox" /><br/>	
					<obs conceptId="165626" id="academic_problem" answerConceptId= "150504" answerLabel="Academic problem." style="checkbox" /><br/>
					<obs conceptId="165626" id="economic_problems" answerConceptId= "141537" answerLabel="Economic problems." style="checkbox" /><br/>	
					<obs conceptId="165626" id="other_psych_environmental_problem" answerConceptId= "165625" answerLabel="Other" style="checkbox" /><br/>					
				</obsgroup>	
			</div>
			</p>
		    </div>

			<div id="display_psych_environmental_problem_other">
			<p>
			If 'other', then specify:
			<br/>
			<obs id="psych_environmental_problem_other" conceptId="165625" maxlength="50" />
			</p>
			</div>

			<div id="display_patient_behaviour">
			<p>
			Patient behaviour:
			<br/>
			<div id="display_patient_behaviour_child">
				<obsgroup  id="patient_behaviour" groupingConceptId="164291" >					
					<obs conceptId="164291" id="irritable" answerConceptId= "6023" answerLabel="Irritable" style="checkbox" defaultValue="6023" /><br/>						
					<obs conceptId="164291" id="stubborn" answerConceptId= "164292" answerLabel="Stubborn" style="checkbox"  /><br/>					
					<obs conceptId="164291" id="shy" answerConceptId= "116631" answerLabel="Shy/Introvert" style="checkbox"  /><br/>
					<obs conceptId="164291" id="aggressive" answerConceptId= "121748" answerLabel="Aggressive" style="checkbox" /><br/>	
					<obs conceptId="164291" id="argumentative" answerConceptId= "164284" answerLabel="Argumentative" style="checkbox" /><br/>
					<obs conceptId="164291" id="non_compliant" answerConceptId= "164286" answerLabel="Non compliant" style="checkbox" /><br/>	
					<obs conceptId="164291" id="compliant" answerConceptId= "165558" answerLabel="Compliant" style="checkbox" /><br/>	
					<obs conceptId="164291" id="responsible" answerConceptId= "164287" answerLabel="Responsible" style="checkbox" /><br/>	
					<obs conceptId="164291" id="cooperative" answerConceptId= "164288" answerLabel="Co-operative" style="checkbox" /><br/>	
					<obs conceptId="164291" id="non_cooperative" answerConceptId= "164289" answerLabel="Non-Cooperative" style="checkbox" /><br/>						
				</obsgroup>	
			</div>
			</p>
		    </div>

			<p>
			Counselor's comments:
			<br/>
			<obs id="counselor_comments" conceptId="165592" maxlength="1000" style="textarea"/>
			</p>

			<div id="time_taken_div">
			<p> 
			Time taken to fill form
			<br/>
			<obs id="time_taken" conceptId="165044" />
			</p>
			</div>
		</div>
	</section>

	<submit/>
	
	<script type="text/javascript">
		var startDate = new Date();	
	
	    var treatment_outcome = jQuery("#display_treatment_outcome");
		var other_assessment = jQuery("#display_other_assessment");
		var followup_month = jQuery("#display_followup_month");
		var tb_treatment_phase = jQuery("#display_tb_treatment_phase");

		/////
		var counselling_other = jQuery("#display_counselling_other");
		
		//checbox
		var adverse_event_other= jQuery("#display_adverse_event_other");
		var relation_problem_other= jQuery("#display_relation_problem_other");
		var psych_environmental_problem_other= jQuery("#display_psych_environmental_problem_other");
		
		//5
		var referral_complaint_by_field_team  = jQuery("#display_referral_complaint_by_field_team");
		var other_referral_complaint_by_field_team = jQuery("#display_other_referral_complaint_by_field_team");
		//5
		
		var adverse_event_check = false;
		var psych_environmental_problem_check = false;
		var patient_behaviour_check = false;
		
jQuery( document ).ready(function() {

		var timeTakenDiv = jQuery("#time_taken_div");
		timeTakenDiv.hide();		
		
		getField("followup_month.value").prop("disabled", true);
		
		console.log(); 
		
		//2 set default value acc to field team monitoring form 
		<ifMode mode='ENTER'  > 		
		if(isFieldTeamMonitoringFormFilled() &amp;&amp; getReferCounseling()==1065 ){
			setValue('reason_followup_counseling.value',165612);
		}
		else{
			setValue('reason_followup_counseling.value',165611);
		}
		</ifMode>
		//2
		
		getField("pulmonary.value").prop("disabled", true);
		getField("extra_pulmonary.value").prop("disabled", true);
		
		getField("extra_pulmonary_site.value").prop("disabled", true);
		getField("drug_resistance_profile.value").prop("disabled", true);
		getField("drug_resistant_profile_class.value").prop("disabled", true);
		getField("akuads_score.value").prop("disabled", true);
		getField("treatment_outcome.value").prop("disabled", true);
		
		//3
		getField("adherence.value").prop("disabled", true);
		getField("infection_control.value").prop("disabled", true);
		getField("adverse_events.value").prop("disabled", true);
		getField("psycho_social_issues.value").prop("disabled", true);
		getField("substance_abuse.value").prop("disabled", true);
		getField("other_counseling_type.value").prop("disabled", true);
		getField("other_referral_complaint_by_field_team.value").prop("disabled", true);		
		//3
	
		<ifMode mode='VIEW' include="false"> 
		if(! isBaselineMedicalFormFilled()){
			alert("Please Fill PMDT-Baseline Medical History Form First");
		}else{
			getDataFromBaselineMedicalForm();
		}
		if(! isAssessmentFormMentalHealthFilled()){
			alert("Please Fill PMDT-Assessment Form Mental Health First");
		}else{
			getDataFromAssessmentFormMentalHealth();
		}
		
		if(getValue('assessment_type.value') == 165041 ){
			getDataFromEndOfTreatmentForm();
			treatment_outcome.show();
		}
		else{
			treatment_outcome.hide();				
		}

		//
		//7
		if(getValue('reason_followup_counseling.value') == 165612 ){
			if( !(getReferCounseling()==1066) ){
				getCounselingType();
				referral_complaint_by_field_team.show();
				//get other counseling type if it is checked
				if(getField("other_counseling_type.value").prop('checked'))
				{
					getCounselingTypeOther();	
					other_referral_complaint_by_field_team.show();	
				}
				else{
					setValue("other_referral_complaint_by_field_team.value","");
					other_referral_complaint_by_field_team.hide();
				}
			}
			else{
				uncheckAllCheckBoxes("display_referral_complaint_by_field_team_child");  
				referral_complaint_by_field_team.hide();	
				setValue("other_referral_complaint_by_field_team.value","");
				other_referral_complaint_by_field_team.hide();				
			}
		}
		else{
			uncheckAllCheckBoxes("display_referral_complaint_by_field_team_child");
			referral_complaint_by_field_team.hide();
			setValue("other_referral_complaint_by_field_team.value","");
			other_referral_complaint_by_field_team.hide();
		}
		
		//7
		
		if(getValue('assessment_type.value') == 165036 ){
			other_assessment.show();
		}
		else{
			other_assessment.hide();				
		}
		
		if(getValue('assessment_type.value') == 165040 ){
			if(! isRegistrationFormFilled() ){
				alert("Please fill PMDT-Treatment Registration Form first ");
			}
			else{
				setValue('followup_month.value',getFollowupMonth());
				followup_month.show();
			}
		}
		else{
			followup_month.hide();					
		}
		
		if(getValue('assessment_type.value') == 165040 ){
			followup_month.show();
			tb_treatment_phase.show();
		}
		else{
			followup_month.hide();
			tb_treatment_phase.hide();			
		}
		
		/////////
		
		<includeIf velocityTest="$patient.age &lt; 15 ">
		if(getValue('counselling.value') == 5620 ){
			counselling_other.show();
		}
		else{
			counselling_other.hide();				
		}
		</includeIf>
		

		</ifMode>
		
		});
		
		function getFollowupMonth(){		
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('f2038177-d0ee-4856-ab41-2b9bad0e949e'))  $fn.getObs($encounter, '164412').getValueAsString($!{locale}) #end"/>";		
		var registrationDateResult = latestEncounter.replace(/\s\s+/g, '@');
        var registrationDateResultArray = registrationDateResult.split('@');
		var registrationDate = registrationDateResultArray[registrationDateResultArray.length-1];
		
		
		var assessmentDate=getValue('date_assessment.value') ;
		
		
		
		var date1 = new Date(registrationDate);
		var date2 = new Date(assessmentDate);
		
		var timeDiff = date2.getTime() - date1.getTime();
		var diffDays = Math.floor(timeDiff / (1000 * 3600 * 24));
        var followupMonth=Math.floor(diffDays/30);
		
		return followupMonth;
	}

		function isRegistrationFormFilled(){
		var isFilled=true;
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('f2038177-d0ee-4856-ab41-2b9bad0e949e'))  $fn.getObs($encounter, '164412').getValueAsString($!{locale}) #end"/>";		
		var registrationDateResult = latestEncounter.replace(/\s\s+/g, '@');
        var registrationDateResultArray = registrationDateResult.split('@');
		var registrationDate = registrationDateResultArray[registrationDateResultArray.length-1];
		
		if( registrationDate==null || registrationDate=='' ){
			isFilled=false;
		}
		return isFilled;
	}
	
function isBaselineMedicalFormFilled(){		
		var isFilled=true;
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('0dad2f4f-7466-49ba-9c31-b8878b7016b4'))  $fn.getObs($encounter, '164648').getValueAsString($!{locale}) #end"/>";		
		var dateResult = latestEncounter.replace(/\s\s+/g, '@');
		var dateResultArray = dateResult.split('@');
		var date = dateResultArray[dateResultArray.length-1];

		if( date==null || date=='' ){
			isFilled=false;
		}
		return isFilled;
}

function isAssessmentFormMentalHealthFilled(){		
		var isFilled=true;
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('e82ae9cd-e283-48ed-9aed-de6c48216bf9'))  $fn.getObs($encounter, '164586').getValueAsString($!{locale}) #end"/>";		
		var akuadsScoreResult = latestEncounter.replace(/\s\s+/g, '@');
        var akuadsScoreResultArray = akuadsScoreResult.split('@');
		var akuadsScore = akuadsScoreResultArray[akuadsScoreResultArray.length-1];		
		var score = parseInt(akuadsScore.trim());
		
		if(score==0){
		//return if score is 0
			return isFilled;
		}
		if(isNaN(score) || score=="" || score==null){
			isFilled=false;
		}		
		return isFilled;
}

function isEndOfTreatmentFormFilled(){	
		var isFilled=true;	
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('ddfb0a27-3d05-4904-8454-2967dd56b809'))  $fn.getObs($encounter, '159786').valueCoded #end"/>";		
		var treatmentOutcomeResult = latestEncounter.replace(/\s\s+/g, '@');
        var treatmentOutcomeResultArray = treatmentOutcomeResult.split('@');
		var treatmentOutcome = treatmentOutcomeResultArray[treatmentOutcomeResultArray.length-1];
		
		if( treatmentOutcome==null || treatmentOutcome=='' ){
			isFilled=false;
		}		
		return isFilled;
}

//1

function getDataFromBaselineMedicalForm(){
		
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('0dad2f4f-7466-49ba-9c31-b8878b7016b4'))  $fn.getObs($encounter, '164430').valueCoded #end"/>";		
		var extraPulmonarySiteResult = latestEncounter.replace(/\s\s+/g, '@');
        var extraPulmonarySiteResultArray = extraPulmonarySiteResult.split('@');
		var extraPulmonarySite = extraPulmonarySiteResultArray[extraPulmonarySiteResultArray.length-1];
		
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('0dad2f4f-7466-49ba-9c31-b8878b7016b4'))  $fn.getObs($encounter, '165029').valueCoded #end"/>";		
		var drugResistanceProfileResult = latestEncounter.replace(/\s\s+/g, '@');
        var drugResistanceProfileResultArray = drugResistanceProfileResult.split('@');
		var drugResistanceProfile = drugResistanceProfileResultArray[drugResistanceProfileResultArray.length-1];
		
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('0dad2f4f-7466-49ba-9c31-b8878b7016b4'))  $fn.getObs($encounter, '165025').valueCoded #end"/>";		
		var drugResistanceProfileClassResult = latestEncounter.replace(/\s\s+/g, '@');
        var drugResistanceProfileClassResultArray = drugResistanceProfileClassResult.split('@');
		var drugResistanceProfileClass = drugResistanceProfileClassResultArray[drugResistanceProfileClassResultArray.length-1];	
	
		getTbType();
		setValue('extra_pulmonary_site.value',extraPulmonarySite.trim());
		setValue('drug_resistance_profile.value',drugResistanceProfile.trim());
		setValue('drug_resistant_profile_class.value',drugResistanceProfileClass.trim());
}

function getTbType(){

	var pulmonary=false;
	var extra_pulmonary=false;
	var obsArrayEncounter ="	<lookup complexExpression="#set( $enc = $fn.latestEncounter('0dad2f4f-7466-49ba-9c31-b8878b7016b4') ) #foreach($obs in $fn.allObs($enc, '160040'))  #set( $val = $obs.valueCoded ) $!{val} #end"/>";
	console.log(obsArrayEncounter);
	var obsArray = obsArrayEncounter.split(' ');
	for(i = 1; i &lt; obsArray.length; i++){	
		if(obsArray[i]=="42"){
			pulmonary=true;
		}
		if(obsArray[i]=="5042"){
			extra_pulmonary=true;
		}
	}
	if(pulmonary){
		console.log("pm: select");
		getField("pulmonary.value").prop('checked',true);
	}else{
		getField("pulmonary.value").prop('checked',false);
	}
	if(extra_pulmonary){
		console.log("expm: select");
		getField("extra_pulmonary.value").prop('checked',true);
	}
	else{
		getField("extra_pulmonary.value").prop('checked',false);
	}
	

}

function getDataFromAssessmentFormMentalHealth(){		
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('e82ae9cd-e283-48ed-9aed-de6c48216bf9'))  $fn.getObs($encounter, '164586').getValueAsString($!{locale}) #end"/>";		
		var akuadsScoreResult = latestEncounter.replace(/\s\s+/g, '@');
        var akuadsScoreResultArray = akuadsScoreResult.split('@');
		var akuadsScore = akuadsScoreResultArray[akuadsScoreResultArray.length-1];		
		var score = parseInt(akuadsScore.trim());
		
		
		if(score==0){
		//incase 0 set value
			setValue('akuads_score.value',score);
		}
		else if(isNaN(score) || score=="" || score==null){
			//not set field value
		}	
		else{
			setValue('akuads_score.value',score);
		}
}

function getDataFromEndOfTreatmentForm(){
		
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('ddfb0a27-3d05-4904-8454-2967dd56b809'))  $fn.getObs($encounter, '159786').valueCoded #end"/>";		
		var treatmentOutcomeResult = latestEncounter.replace(/\s\s+/g, '@');
        var treatmentOutcomeResultArray = treatmentOutcomeResult.split('@');
		var treatmentOutcome = treatmentOutcomeResultArray[treatmentOutcomeResultArray.length-1];
		
		if( treatmentOutcome==null || treatmentOutcome=='' ){
			getField('treatment_outcome.error').html('Please fill PMDT-End of Treatment Form First').show();
		}
		else{
			console.log( treatmentOutcome.trim() );			
			setValue('treatment_outcome.value',treatmentOutcome.trim());
			getField('treatment_outcome.error').html('').hide();
		}
}

function isFieldTeamMonitoringFormFilled(){	
		var isFilled=true;	
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('431117b6-6e36-4e8c-b517-25016143213b'))  $fn.getObs($encounter, '164552').valueCoded #end"/>";		
		var referCounselingResult = latestEncounter.replace(/\s\s+/g, '@');
        var referCounselingResultArray = referCounselingResult.split('@');
		var referCounseling = referCounselingResultArray[referCounselingResultArray.length-1];
		
		if( referCounseling == null || referCounseling== '' ){
			isFilled=false;
		}		
		else if( referCounseling.trim() == 1065 || referCounseling.trim()== 1066 ){
			isFilled=true;
		}
		else{
			isFilled=false;
		}		
		console.log("isFilled "+isFilled);
		return isFilled;
}

function getReferCounseling(){	
		var referCounselingVal;	
		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('431117b6-6e36-4e8c-b517-25016143213b'))  $fn.getObs($encounter, '164552').valueCoded #end"/>";		
		var referCounselingResult = latestEncounter.replace(/\s\s+/g, '@');
        var referCounselingResultArray = referCounselingResult.split('@');
		var referCounseling = referCounselingResultArray[referCounselingResultArray.length-1];
		
		if( referCounseling == null || referCounseling== '' ){
			
		}		
		else if( referCounseling.trim() == 1065 ){
			referCounselingVal=1065;
		}
		else if( referCounseling.trim() == 1066 ){
			referCounselingVal=1066;
		}
		else{
			
		}		
		console.log("referCounselingVal "+referCounselingVal);
		return referCounselingVal;
}

//8
function getCounselingType(){
		
		if(! isFieldTeamMonitoringFormFilled()){
			getField('adherence.error').html('Please fill PMDT-Field Team Monitoring Form First').show();
		}
		else{	
			getCounselingTypeCheck();		
			getField('adherence.error').html('').hide();
		}		
}

function getCounselingTypeCheck(){

	var adherence=false;
	var infection_control=false;
	var adverse_events =false;
	var psycho_social_issues=false;
	var substance_abuse=false;
	var other_counseling_type=false;
	
	var obsArrayEncounter ="	<lookup complexExpression="#set( $enc = $fn.latestEncounter('431117b6-6e36-4e8c-b517-25016143213b') ) #foreach($obs in $fn.allObs($enc, '164554'))  #set( $val = $obs.valueCoded ) $!{val} #end"/>";
	console.log(obsArrayEncounter);
	var obsArray = obsArrayEncounter.split(' ');
	for(i = 1; i &lt; obsArray.length; i++){	
		if(obsArray[i]=="164553"){
			adherence=true;
		}
		if(obsArray[i]=="164339"){
			infection_control=true;
		}
		if(obsArray[i]=="164295"){
			adverse_events=true;
		}
		if(obsArray[i]=="5490"){
			psycho_social_issues=true;
		}	
		if(obsArray[i]=="112603"){
			substance_abuse=true;
		}	
		if(obsArray[i]=="164558"){
			other_counseling_type=true;
		}			
	}

	if(adherence){
		console.log("adherence: select");
		getField("adherence.value").prop('checked',true);
	}else{
		getField("adherence.value").prop('checked',false);
	}
	if(infection_control){
		console.log("infection_control: select");
		getField("infection_control.value").prop('checked',true);
	}
	else{
		getField("infection_control.value").prop('checked',false);
	}
	if(adverse_events){
		console.log("adverse_events: select");
		getField("adverse_events.value").prop('checked',true);
	}else{
		getField("adverse_events.value").prop('checked',false);
	}
	if(psycho_social_issues){
		console.log("psycho_social_issues: select");
		getField("psycho_social_issues.value").prop('checked',true);
	}else{
		getField("psycho_social_issues.value").prop('checked',false);
	}
	if(substance_abuse){
		console.log("substance_abuse: select");
		getField("substance_abuse.value").prop('checked',true);
	}
	else{
		getField("substance_abuse.value").prop('checked',false);
	}	
	if(other_counseling_type){
		console.log("other_counseling_type: select");
		getField("other_counseling_type.value").prop('checked',true);	
	}
	else{
		getField("other_counseling_type.value").prop('checked',false);
	}
}

function getCounselingTypeOther(){

		var latestEncounter = "<lookup complexExpression="#foreach($encounter in $fn.allEncounters('431117b6-6e36-4e8c-b517-25016143213b'))  $fn.getObs($encounter, '164558').getValueAsString($!{locale}) #end"/>";		
		var counselingTypeOtherResult = latestEncounter.replace(/\s\s+/g, '@');
        var counselingTypeOtherResultArray = counselingTypeOtherResult.split('@');
		var counselingTypeOther = counselingTypeOtherResultArray[counselingTypeOtherResultArray.length-1];	

		setValue("other_referral_complaint_by_field_team.value",counselingTypeOther);
}

function uncheckAllCheckBoxes(divName) {
	var divCompleteName = "#" + divName;
	$j(divCompleteName).find('input[type=checkbox]:checked').removeAttr('checked'); // Uncheck all the checkboxes
}

//8
jQuery(":checkbox").click(function(){
	var $this = jQuery(this);
	var checkBoxId = jQuery(this).closest('span').attr('id')
								
	if($this.is(":checked") &amp;&amp; checkBoxId == "other_adverse_event") {
		adverse_event_other.show();
	}
	else if(checkBoxId == "other_adverse_event"){
		adverse_event_other.hide();
		setValue('adverse_event_other.value', "");
	}
	
	if($this.is(":checked") &amp;&amp; checkBoxId == "other_relation_problem") {
		relation_problem_other.show();
	}
	else if(checkBoxId == "other_relation_problem"){
		relation_problem_other.hide();
		setValue('relation_problem_other.value', "");
	}
	
	if($this.is(":checked") &amp;&amp; checkBoxId == "other_psych_environmental_problem") {
		psych_environmental_problem_other.show();
	}
	else if(checkBoxId == "other_psych_environmental_problem"){
		psych_environmental_problem_other.hide();
		setValue('psych_environmental_problem_other.value', "");
	}
});

jQuery(function() {
			getField('assessment_type.value').change(function() {
				
				if(getValue('assessment_type.value') == 165041 ){
					getDataFromEndOfTreatmentForm();
					treatment_outcome.show();
				}
				else{
					setValue('treatment_outcome.value', "");  
					treatment_outcome.hide();				
				}
				
				if(getValue('assessment_type.value') == 165036 ){
					other_assessment.show();
				}
				else{
					setValue('other_assessment.value', "");  
					other_assessment.hide();				
				}
				
				if(getValue('assessment_type.value') == 165040 ){
					if(! isRegistrationFormFilled() ){
						alert("Please fill PMDT-Treatment Registration Form first ");
					}
					else{//set followup month acc to calculation
						setValue('followup_month.value',getFollowupMonth());						
					}
					followup_month.show();
					
				}
				else{
					setValue('followup_month.value', "");  
					followup_month.hide();					
				}
				
				
				if(getValue('assessment_type.value') == 165040 ){
					followup_month.show();
					tb_treatment_phase.show();
				}
				else{
					setValue('followup_month.value', "");  
					setValue('tb_treatment_phase.value', "");  
					followup_month.hide();
					tb_treatment_phase.hide();			
				}
								
			});	
			
			getField('date_assessment.value').change(function() {	
				
				if(!isRegistrationFormFilled()) {
					alert("Please fill Treatment Registration Form first ");
				}
				else{
					//set followup month acc to calculation as return date is changed
					setValue('followup_month.value',getFollowupMonth());
				}				
			});
			
			////
			
			//6
			
			getField('reason_followup_counseling.value').change(function() {
				
				if(getValue('reason_followup_counseling.value') == 165612 ){
					if( !(getReferCounseling()==1066) ){
						getCounselingType();
						referral_complaint_by_field_team.show();
						//get other counseling type if it is checked
						if(getField("other_counseling_type.value").prop('checked'))
						{
							//set value for other counsler type field
							getCounselingTypeOther();
							other_referral_complaint_by_field_team.show();							
						}
						else{
							setValue("other_referral_complaint_by_field_team.value","");
							other_referral_complaint_by_field_team.hide();
						}
					}
				}
				else{
					uncheckAllCheckBoxes("display_referral_complaint_by_field_team_child"); 
					referral_complaint_by_field_team.hide();				
					setValue("other_referral_complaint_by_field_team.value","");
					other_referral_complaint_by_field_team.hide();
				}
			});	
					  
		 
		
			//6
			
			<includeIf velocityTest="$patient.age &lt; 15 ">
			getField('counselling.value').change(function() {
					if(getValue('counselling.value') == 5620 ){
						counselling_other.show();
					}
					else{
						setValue("counselling_other.value","");
						counselling_other.hide();				
					}							
			});	
			</includeIf >

});
		
beforeSubmit.push(function() {

	setValue("pulmonary.error","");
	setValue("extra_pulmonary_site.error","");
	setValue("drug_resistance_profile.error","");
	setValue("drug_resistant_profile_class.error","");
	setValue("akuads_score.error","");
	setValue('treatment_outcome.error','');
	<includeIf velocityTest="$patient.age &lt; 15 ">
	setValue('counselling_other.error','');
	</includeIf>
	
	/////////////////
	setValue('other_assessment.error','');
	setValue('followup_month.error','');
	setValue('tb_treatment_phase.error','');
	
	///checkbox
	setValue('vomiting.error','');	
	setValue('adverse_event_other.error','');	
	setValue('relation_problem_other.error','');
	setValue('none_problem.error','');	
	setValue('psych_environmental_problem_other.error','');	 
	setValue('irritable.error','');
	
	
	//10
	setValue('adherence.error','');
	//10
	
	var valid=true;
	if(! isBaselineMedicalFormFilled()){
		alert("Please Fill PMDT-Baseline Medical History Form First");
		getField('pulmonary.error').html('Please Fill PMDT-Baseline Medical History Form First').show();
		getField('extra_pulmonary_site.error').html('Please Fill PMDT-Baseline Medical History Form First').show();
		getField('drug_resistance_profile.error').html('Please Fill PMDT-Baseline Medical History Form First').show();
		getField('drug_resistant_profile_class.error').html('Please Fill PMDT-Baseline Medical History Form First').show();
		valid=false;
	}
	else{
		getField('pulmonary.error').html('').hide();
		getField('extra_pulmonary_site.error').html('').hide();
		getField('drug_resistance_profile.error').html('').hide();
		getField('drug_resistant_profile_class.error').html('').hide();
	}
	
	if(! isAssessmentFormMentalHealthFilled()){
		alert("Please Fill PMDT-Assessment Form Mental Health First");
		getField('akuads_score.error').html('Please Fill PMDT-Assessment Form Mental Health First').show();
		valid=false;		
	}
	else{
		getField('akuads_score.error').html('').hide();
	}
	
	if( getValue('assessment_type.value') == 165041 &amp;&amp; ! isEndOfTreatmentFormFilled() ){
		getField('treatment_outcome.error').html('Please fill PMDT-End of Treatment Form First').show();
		valid=false;		
	}
	else{
		getField('treatment_outcome.error').html('').hide();
	}
	
	if( getValue('assessment_type.value') == 165040 &amp;&amp; getValue('date_assessment.value') != '') {
	
		if(! isRegistrationFormFilled() ){
			getField('followup_month.error').html('Please fill PMDT-Treatment Registration Form first').show();
			valid = false;
		}
		
		else if(getValue('followup_month.value') &lt; 0) {
			getField('followup_month.error').html('Please select correct visit date. Follow-up Assessment should be after Treatment registration.').show();
			valid = false;
		}
		else if(getValue('followup_month.value') &gt; 24) {
			getField('followup_month.error').html('Follow up month can not be greater than 24. Please select correct visit date').show();
			valid = false;
		}
		else {
			getField('followup_month.error').html('').hide();
		}
	
	}
	
	
	//9
	if( getValue('reason_followup_counseling.value') == 165612 &amp;&amp; ! isFieldTeamMonitoringFormFilled() ){
		getField('adherence.error').html('Please fill PMDT-Field Team Monitoring Form First').show();
		valid=false;		
	}
	else{
		getField('adherence.error').html('').hide();
	}
	//9
	
	//////////////////
	if( getValue('assessment_type.value') == 165036 &amp;&amp; getValue('other_assessment.value') == "" ){
		getField('other_assessment.error').html('Please input a Value').show();
		valid=false;		
	}
	else{
		getField('other_assessment.error').html('').hide();
	}
	
	if( getValue('assessment_type.value') == 165040 )
	{
		var followup_month = getValue('followup_month.value');
		if(followup_month == ""  || getValue('followup_month.value') == null)
		{
			getField('followup_month.error').html('This field can not be empty').show();
			valid=false;
		}
		else if(!(followup_month.match(/^\d+$/))){
			getField('followup_month.error').html('Not an integer').show();
			valid=false;
        }
        else if( followup_month &lt; 1  ){
	        getField('followup_month.error').html('Cannot be less than 1').show();
			valid=false;	
		}
        else if( followup_month &gt; 24 ){
	        getField('followup_month.error').html('Cannot be greater than 24').show();
			valid=false;	
		}
		else{
			getField('followup_month.error').html('').hide();
		}
		
		if( getValue('tb_treatment_phase.value') == "" ){
			getField('tb_treatment_phase.error').html('Please select a Value').show();
			valid=false;		
		}
		else{
			getField('tb_treatment_phase.error').html('').hide();
		}
	}	
	//////////////////
	
	//////
	<includeIf velocityTest="$patient.age &lt; 15 ">
	if(getValue('counselling.value') == 5620 &amp;&amp; (getValue('counselling_other.value') =='' ) ){	
		getField('counselling_other.error').html('Please input a value.').show();
		valid=false;		
	}
	else{
		getField('counselling_other.error').html('').hide();
	}
	</includeIf>
	
	
	/////////////////////////////checkbox valid checks for fields
	///  
	if (jQuery("#display_ae_child input[type=checkbox]:checked").length > 0)
	{
		adverse_event_check = true;
	}
	else
	{
		adverse_event_check = false;
	}

	if(	adverse_event_check == false) {
		   getField('vomiting.error').html('Please select a value.').show();
		   valid=false;   
	}
	else {
		   getField('vomiting.error').html('').hide();
	}
	//
	if( getField("other_adverse_event.value").prop('checked')== true &amp;&amp; getValue('adverse_event_other.value')=='') {	
		   getField('adverse_event_other.error').html('Please input a value.').show();
		   valid=false;	   
	}
	else {
		   getField('adverse_event_other.error').html('').hide();
	}
	////////////
	//remove other values when other check is unchecked
	if( getField("other_adverse_event.value").prop('checked')== false){
		setValue('adverse_event_other.value',"");
	} 
	///////////////////
	
	if( getField("other_relation_problem.value").prop('checked')== true &amp;&amp; getValue('relation_problem_other.value')=='') {	
		   getField('relation_problem_other.error').html('Please input a value.').show();
		   valid=false;	   
	}
	else {
		   getField('relation_problem_other.error').html('').hide();
	}
	
	///remove other values when other check is unchecked
	if( getField("other_relation_problem.value").prop('checked')== false){
		setValue('relation_problem_other.value',"");
	} 
		 
	/////////////////////
	
	/////////////////////////////checkbox valid checks for fields
	///  
	if (jQuery("#display_psych_environmental_problem_child input[type=checkbox]:checked").length > 0)
	{
		psych_environmental_problem_check = true;
	}
	else
	{
		psych_environmental_problem_check = false;
	}

	if(	psych_environmental_problem_check == false) {
		   getField('none_problem.error').html('Please select a value.').show();
		   valid=false;   
	}
	else {
		   getField('none_problem.error').html('').hide();
	}
	//
	if( getField("other_psych_environmental_problem.value").prop('checked')== true &amp;&amp; getValue('psych_environmental_problem_other.value')=='') {	
		   getField('psych_environmental_problem_other.error').html('Please input a value.').show();
		   valid=false;	   
	}
	else {
		   getField('psych_environmental_problem_other.error').html('').hide();
	}
	///////////////////
	
	////////////
	//remove other values when other check is unchecked
	if( getField("other_psych_environmental_problem.value").prop('checked')== false){
		setValue('psych_environmental_problem_other.value',"");
	} 
	///////////////////
	
	/////////////////////////////checkbox valid checks for fields
	///  
	if (jQuery("#display_patient_behaviour_child input[type=checkbox]:checked").length > 0)
	{
		patient_behaviour_check = true;
	}
	else
	{
		patient_behaviour_check = false;
	}

	if(	patient_behaviour_check == false) {
		   getField('irritable.error').html('Please select a value.').show();
		   valid=false;   
	}
	else {
		   getField('irritable.error').html('').hide();
	}
	//
	
	
	/////////////
	
	if(valid==true){
	
		if( getValue('assessment_type.value') == 165040)
		{
			getField("followup_month.value").prop("disabled", false);
		}
	
		getField("pulmonary.value").prop("disabled", false);
		getField("extra_pulmonary.value").prop("disabled", false);
		
		getField("extra_pulmonary_site.value").prop("disabled", false);
		getField("drug_resistance_profile.value").prop("disabled", false);
		getField("drug_resistant_profile_class.value").prop("disabled", false);
		getField("akuads_score.value").prop("disabled", false);
		getField("treatment_outcome.value").prop("disabled", false);
		
		//4
		getField("adherence.value").prop("disabled", false);
		getField("infection_control.value").prop("disabled", false);
		getField("adverse_events.value").prop("disabled", false);
		getField("psycho_social_issues.value").prop("disabled", false);
		getField("substance_abuse.value").prop("disabled", false);
		getField("other_counseling_type.value").prop("disabled", false);
		getField("other_referral_complaint_by_field_team.value").prop("disabled", false);	
		//4

		var timeTakenDiv = $j("#time_taken_div");
		
		var endDate = new Date();
		var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
		var diffSec = timeDiff/1000;
		
		timeTakenDiv.show();
		setValue("time_taken.value",diffSec);
		timeTakenDiv.hide();
	
		return true;
}
	return false;
});
		
</script>
</htmlform>