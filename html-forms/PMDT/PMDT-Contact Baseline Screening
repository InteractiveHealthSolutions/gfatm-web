<htmlform>
	<!-- Developed by Tahira -->
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PMDT-Contact Baseline Screening(v0.0.1-alpha)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="1"/></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
		<script>
		 var patientId =  '<lookup expression="patient.getPatientIdentifier(3)"/>';
		</script>
	</section>

	<section headerLabel="2. Baseline Screening Information ">
		<div>
                       
                        <p>
				Index Patient ID
                                <br/>
				<obs conceptId="163755" id="index_case_id" size="7" required="true"/>
			</p>
                         
                        <p>
                                Date of Contact Baseline Screening
                                <br/>
                                <obs conceptId="165601" id="contact_screening_date" required="true"/>
                        </p>

                         <p>
				"Relation with Index patient.
                                <br/>
                                E.g. 'Mother' means Index is Mother of Contact"
                                <br/>
				<obs conceptId="1560" id="relationship" answerConceptIds="970,971,160723,160724,160726,160725,160729,160730,160727,160728,5617,975,974,5620"  required="true">
                         <controls>
                                <when value="5620" thenDisplay="#other_relation"/>
                          </controls>
				</obs>
			</p>


                        <p id="other_relation">
				Other Relation
                                <br/>
				<obs conceptId="5620" id="other_relationship" maxlength="15" />
			</p>
				
		</div>
	</section>

        <section headerLabel="3. Contact Verbal Symptom Screening">

                <div>
                        <p>
 				Does contact have cough?
                                <br/>
				<obs conceptId="143264" id="cough"  required="true" >
                                <controls>
                                <when value="1065" thenDisplay="#cough_fields"/>
                          </controls>
				</obs>
			</p>
             
            <div  id="cough_fields">
                <p>
					Cough duration
                    <br/>
					<obs conceptId="5959" id="cough_duration" answerConceptIds="163739,165606,1487,1067,164106" />
				</p>

                <p>
					Haemoptysis
                    <br/>
					<obs conceptId="138905" id="haemoptysis"/>
				</p>
            </div>
            
			<p>
 				Does contact have fever?
                <br/>
				<obs conceptId="140238" id="fever"  required="true" />
			</p>

            <p>
 				Does contact have weight loss or failure to thrive?
                <br/>
				<obs conceptId="832" id="weight_loss"  required="true" />
			</p>

            <p>
  				Reduced appetite
                <br/>
				<obs conceptId="135595" id="reduced_appetite"  required="true" />
			</p>

            <p>
  				Does contact have reduced activity?
                <br/>
				<obs conceptId="152313" id="reduced_activity"  required="true" />
			</p>

            <p>
  				Does contact have night sweats?
                <br/>
				<obs conceptId="133027" id="night_sweats"  required="true" />
			</p>

            <p>
  				Does the contact have glandular swelling anywhere in body?
                <br/>
				<obs conceptId="163894" id="swelling"  required="true" />
			</p>

            <p>
  				Has the contact been referred to the facility?
                <br/>
				<obs conceptId="1648" id="referral" required="true">
			        <controls>
                        <when value="1065" thenDisplay="#facility_referred"/>
                    </controls>
				</obs>
			</p>

			
			<div id="facility_referred">
				<p>
                    Patient referred to which facility? Please select one:
					
                                    <select id="facility_list">			   
				    </select>
                                                                                  
					<obs conceptId="161550" id="referral_facility"/>
 				</p>
			</div>


            
			
			<div id="other_facility_referred">
			<p>
  			    Other facility contact referred to
                <br/>
				<obs conceptId="165697" id="other_referral_facility"/>
			</p>
			</div>
            
			<ifMode mode="EDIT">
        <script type="text/javascript">
			
			jQuery(function() { 
				getField('referral_facility.value').change();
				var otherFacilityDiv = $j("#other_facility_referred");

				otherFacilityDiv.show();
			});
        </script>
    </ifMode>

		</div>
          
	</section>

	<submit/>

    <script type="text/javascript">
        var startDate = new Date();
		var locationData;
		
jQuery( document ).ready(function() {
	                        		
			doRest();
                        getField('referral_facility.value').change();
		});
		
		function doRest(){
			jQuery.ajax({
				url: "/openmrs/ws/rest/v1/location?v=custom:(uuid,display,name,description)&amp;tag=PMDT",
				dataType: 'json'
				}).done(function(data ) {
					console.log(data.results[0].name);
					console.log(data.results.length);
					locationData = data;
					populate(data);
			});
		}
		
		function populate(data) {
								
			var s= document.getElementById('facility_list');
			
			for (i = 0; i &lt; data.results.length; i++) { 
				s.options[i+1]= new Option(data.results[i].description, data.results[i].name);                      
				var resultObject =  JSON.parse(JSON.stringify(data.results[i].description || null));
			}
		}
		
		function luhnCheckDigit(number) {
			
			var validChars = "0123456789ABCDEFGHIJKLMNOPQRSTUVYWXZ_";
			number = number.toUpperCase().trim();
			var sum = 0;
			for (var i = 0; i &lt; number.length; i++) 
			{
				var ch = number.charAt(number.length - i - 1);
				if (validChars.indexOf(ch) &lt; 0) {
					return -1;
				}
				var digit = ch.charCodeAt(0) - 48;
				var weight;
				if (i % 2 == 0) {
					weight = (2 * digit) - parseInt(digit / 5) * 9;
				}
				else {
					weight = digit;
				}
				sum += weight;
			}
			sum = Math.abs(sum) + 10;
			var digit = (10 - (sum % 10)) % 10;
			return digit;
		}
		
                  
		var otherFacilityDiv = $j("#other_facility_referred");
		otherFacilityDiv.hide();

                  jQuery(function() { 
		var facilities = document.getElementById("facility_list");
        facilities.onchange = function(){
                var e = document.getElementById("facility_list");
				var locationDescription = e.options[e.selectedIndex].text;
                                var locationName = e.options[e.selectedIndex].value;
			
				setValue('referral_facility.value',locationName );
getField('referral_facility.value').change();
										
		};
		
                     
		getField('referral_facility.value').change(function() {
                
	        if(getValue('referral_facility.value')=='OTHER'){
                       
                       otherFacilityDiv.show();
                
                }
				else {
					otherFacilityDiv.hide();
				}
		});

                });
		

		<!-- Error Checking before Form Submit -->
		beforeSubmit.push(function() {

            getField("referral_facility.value").prop('disabled',false);
			var indexCaseId = getValue('index_case_id.value');
			var valid=true;
			
			setValue('index_case_id.error', '');
            setValue('other_relationship.error','');
			setValue('cough_duration.error','');
			setValue('haemoptysis.error','');
			<!-- setValue('referral_facility.error',''); -->

             myRegExp = new RegExp(/[A-Z0-9]{5,5}-[0-9]/);
               
            if(!myRegExp.test(getValue('index_case_id.value'))) { 
			     
				getField('index_case_id.error').html('Incorrect format! Please enter Index case id in format: xxxxx-x').show();
                valid=false;
            }
            else{
                getField('index_case_id.error').html('').hide();
            }
            
               
            if(getValue('relationship.value')==5620 &amp;&amp; getValue('other_relationship.value')==''){
                getField('other_relationship.error').html('This field can not be empty').show();
                valid=false;                
            }
            else{
                getField('other_relationship.error').html('').hide();
                
            }
			
			if(getValue('cough.value')==1065 &amp;&amp; getValue('cough_duration.value')==''){
                getField('cough_duration.error').html('This field can not be empty').show();
                valid=false;                
            }
            else{
                getField('cough_duration.error').html('').hide();
                
            }
			if(getValue('cough.value')==1065 &amp;&amp; getValue('haemoptysis.value')==''){
                getField('haemoptysis.error').html('This field can not be empty').show();
                valid=false;                
            }
            else{
                getField('haemoptysis.error').html('').hide();
                
            }
			if(getValue('referral.value')==1065 &amp;&amp; getValue('referral_facility.value')==''){
                getField('referral_facility.error').html('This field can not be empty').show();
                valid=false;                
            }
            else{
                getField('referral_facility.error').html('').hide();
                
            } 
			
            if(valid==true &amp;&amp; indexCaseId != "") {
				
					// Check Luhn digit for barcode
				var number = indexCaseId.substring(0, indexCaseId.length - 2);
				var digit = indexCaseId.charAt(indexCaseId.length - 1);
				var luhnDigit = luhnCheckDigit(number);
				if (digit != luhnDigit) {
					
					valid = false; 
					getField('index_case_id.error').html('Index Case ID is invalid. Please recheck the index case ID').show();
				}
				else {
					getField('index_case_id.error').html('').hide();
					
				}
				
			}
			if(valid==true &amp;&amp; indexCaseId != "") {
				
				
				if(patientId==indexCaseId) {	
				    
					valid = false; 
					getField('index_case_id.error').html('Patient ID and Index Case ID must not match! Please recheck the index case ID').show();
					
				}
				else {
					getField('index_case_id.error').html('').hide();
					
				}
			}
			
			if(valid==false){
				return false;
            }
			else {
				var endDate = new Date();
                var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
				var diffSec = timeDiff/1000;
				alert(diffSec + " seconds to fill form");
                return true;
            } 
			
			
		});
    </script>

<!-- END OF FORM

Simple examples to copy-and-paste. Full reference at http://wiki.openmrs.org/x/kg8z

SECTION
	<section headerLabel="\#. Title">
		Content
	</section>

NUMERIC OBSERVATION
	<obs conceptId="id-of-numeric-concept" labelText="Label before"/>

DATE OBSERVATION
	<obs conceptId="id-of-date-concept" labelText="Label before"/>

CODED OBSERVATION
(as a dropdown)
	<obs conceptId="id-of-coded-concept" labelText="Label before"/>
(as radio buttons)
	<obs conceptId="id-of-coded-concept" labelText="Label before" style="radio"/>
(as an autocomplete)
	<obs conceptId="id-of-coded-concept" labelText="Label before" style="autocomplete" answerClasses="Diagnosis"/>
(as a checkbox for a specific answer)
	<obs conceptId="id-of-coded-concept" labelText="Label before" answerConceptId="id-of-answer-concept" answerLabel="label for answer"/>
(as a dropdown with specific choices)
	<obs conceptId="id-of-coded-concept" labelText="Label before" answerConceptIds="concept-id-1,concept-id-2,concept-id-3" answerLabels="Label 1,Label 2, Label 3"/>


FREE TEXT OBSERVATION
(as a normal text field)
	<obs conceptId="id-of-text-concept" labelText="Label before"/>
(as a textarea)
	<obs conceptId="id-of-text-concept" labelText="Label before" rows="4" cols="80"/>
-->
</htmlform>