<htmlform>
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<style>
		.section {
			border: 1px solid $headerColor;
			padding: 2px;
			text-align: left;
			margin-bottom: 1em;
		}
		.sectionHeader {
			background-color: $headerColor;
			color: $fontOnHeaderColor;
			display: block;
			padding: 2px;
			font-weight: bold;
		}
		table.baseline-aligned td {
			vertical-align: baseline;
		}
	</style>

	<span style="float:right">Paper Form ID: $paperFormId</span>
	<h2>PMDT-Hospital Admission Notification (v0.0.1)</h2>

	<section headerLabel="1. Encounter Details">
		<table class="baseline-aligned">
			<tr>
				<td>Date:</td>
				<td><encounterDate default="today"/></td>
			</tr>
			<tr>
				<td>Location:</td>
				<td><encounterLocation default="2"  tags="PMDT" /></td>
			</tr>
			<tr>
				<td>Provider:</td>
				<td><encounterProvider default="currentUser" type="autocomplete"/></td>
			</tr>
		</table>
	</section>

	<section headerLabel="2. Hospital Admission Notification Form">
		<div>	

		<p>
		Treatment Facility
		<br/>
		<select id="facility_list">			   
				    </select>
		<obs id="facility_treatment" conceptId="162724"   required="true"/>
		</p>

		<div id="display_facility_treatment_other">
		<p>
		If treatment facility 'Other', then specify:
		<br/>
		<obs id="facility_treatment_other" conceptId="165695" maxlength="100" />
		</p>
		</div>

		<p>
		Hospital admission date:
		<br/>
		<obs id="date_hospital_admit" conceptId="1640" defaultValue="today" required="true"/>
		</p>

		<p>
		Hospital name
		<br/>
		<select id="hospital_list">			   
				    </select>
		<obs id="hospital_admit_facility" conceptId="1589"  required="true"/>
		</p>

		<div id="display_hospital_admit_facility_other">
		<p>
		If hospital name 'Other', then specify:
		<br/>
		<obs id="hospital_admit_facility_other" conceptId="165694" maxlength="100" />
		</p>
		</div>

		<p>
		Referral facility patient ID
		<br/>
		<obs id="hospital_admit_facility_id" conceptId="165195"/>
		</p>

		<p>
		Main reason for hospitalisation
		<br/>
		<obs id="reason_hospitalization" conceptId="165196" answerConceptIds="165035,165180,164295,164459,165186,165187,165188,165189,165669" answerLabels="Treatment initiation,Infection control,Adverse event,Co morbidity,Severe clinical condition,Surgical operation,Patient behavior,Social reason,Other" defaultValue="164295" required="true"/>
		</p>

		<div id="display_reason_hospitalization_other">
		<p>
		If main reason for hospitalisation 'Other', then specify:
		<br/>
		<obs id="reason_hospitalization_other" conceptId="165669" maxlength="100"  />
		</p>
		</div>

		<p>
		Admission diagnosis
		<br/>
		<obs id="hospital_admission_diagnosis" conceptId="165197" maxlength="1000" style="textarea"/>
		</p>
		
		<div id="time_taken_div">
		<p> 
		Time taken to fill form
		<br/>
		<obs id="time_taken" conceptId="165044" />
		</p>
		</div>
		</div>
	</section>

	<submit/>
	
	<script type="text/javascript">
		var startDate = new Date();	

		var facility_treatment_other = jQuery("#display_facility_treatment_other"); 
		var hospital_admit_facility_other = jQuery("#display_hospital_admit_facility_other"); 
		var reason_hospitalization_other = jQuery("#display_reason_hospitalization_other");

 
jQuery( document ).ready(function() {

		var timeTakenDiv = jQuery("#time_taken_div");
		timeTakenDiv.hide();
		
		getField("facility_treatment.value").prop("disabled", true);
		getField("hospital_admit_facility.value").prop("disabled", true);
				
		<ifMode mode='VIEW' include="false"> 
	
		doRest();
								 		
		if(getValue('facility_treatment.value') == "OTHER" ){
			facility_treatment_other.show();
		}
		else{
			facility_treatment_other.hide();
		}	
		  
		if(getValue('hospital_admit_facility.value') == "OTHER" ){
			hospital_admit_facility_other.show();
		}
		else{
			hospital_admit_facility_other.hide();
		}
		
		if(getValue('reason_hospitalization.value') == 165669 ){
			reason_hospitalization_other.show();
		}
		else{
			reason_hospitalization_other.hide();
		}
		
		</ifMode>
		
		});

function doRest(){
	jQuery.ajax({
		url: "/openmrs/ws/rest/v1/location?v=custom:(uuid,display,name,description)&amp;tag=PMDT",
		dataType: 'json'
		}).done(function(data ) {
			console.log(data.results[0].name);
			console.log(data.results.length);
			locationData = data;
			populate(data);
	});
}

function populate(data) {
						
	var facilityList= document.getElementById('facility_list');
	var hospitalList= document.getElementById('hospital_list');
	
	for (i = 0; i &lt; data.results.length; i++) { 
		facilityList.options[i+1]= new Option(data.results[i].description, data.results[i].name);
		hospitalList.options[i+1]= new Option(data.results[i].description, data.results[i].name);		
		var resultObject =  JSON.parse(JSON.stringify(data.results[i].description || null));
	}
}

jQuery(function() {

			jQuery('#facility_list').change(function() {
				setValue('facility_treatment.value',jQuery("#facility_list").val());  
				getField('facility_treatment.value').change();
			});
			
			getField('facility_treatment.value').change(function() {
				if(getValue('facility_treatment.value') == "OTHER" ){
					facility_treatment_other.show();
				}
				else{
					setValue('facility_treatment_other.value',''); 
					facility_treatment_other.hide();
				}
			});		

			jQuery('#hospital_list').change(function() {
				setValue('hospital_admit_facility.value',jQuery("#hospital_list").val());  
				getField('hospital_admit_facility.value').change();
			});

			getField('hospital_admit_facility.value').change(function() {
				if(getValue('hospital_admit_facility.value') == "OTHER" ){
					hospital_admit_facility_other.show();
				}
				else{
					setValue('hospital_admit_facility_other.value',''); 
					hospital_admit_facility_other.hide();
				}
			});	
			
			getField('reason_hospitalization.value').change(function() {
				if(getValue('reason_hospitalization.value') == 165669 ){
					reason_hospitalization_other.show();
				}
				else{
					setValue('reason_hospitalization_other.value',''); 
					reason_hospitalization_other.hide();
				}
			});	
					
});
		
beforeSubmit.push(function() {
	setValue('facility_treatment_other.error','');

	var valid=true;
	
	if(getValue('facility_treatment.value') == "OTHER" &amp;&amp; (getValue('facility_treatment_other.value') =='' ) ){	
		getField('facility_treatment_other.error').html('Please input a value.').show();
		valid=false;		
	}
	else{
		getField('facility_treatment_other.error').html('').hide();
	}
	
	if(getValue('hospital_admit_facility.value') == "OTHER" &amp;&amp; (getValue('hospital_admit_facility_other.value') =='' ) ){	
		getField('hospital_admit_facility_other.error').html('Please input a value.').show();
		valid=false;		
	}
	else{
		getField('hospital_admit_facility_other.error').html('').hide();
	}
	
	if(getValue('reason_hospitalization.value') == 165669 &amp;&amp; (getValue('reason_hospitalization_other.value') =='' ) ){	
		getField('reason_hospitalization_other.error').html('Please input a value.').show();
		valid=false;		
	}
	else{
		getField('reason_hospitalization_other.error').html('').hide();
	}
	
	if(valid==true){
	
		getField("facility_treatment.value").prop("disabled", false);
		getField("hospital_admit_facility.value").prop("disabled", false);
		/////
	
		//remove other textfield text if not selected
		if(getValue('facility_treatment.value') != "OTHER" ){
			setValue('facility_treatment_other.value',''); 
		}
		if(getValue('hospital_admit_facility.value') != "OTHER" ){
			setValue('hospital_admit_facility_other.value',''); 
		}
		if(getValue('reason_hospitalization.value') != 165669 ){
			setValue('reason_hospitalization_other.value',''); 
		}

		var timeTakenDiv = $j("#time_taken_div");
		
		var endDate = new Date();
		var timeDiff = Math.abs(endDate.getTime() - startDate.getTime());
		var diffSec = timeDiff/1000;
		
		timeTakenDiv.show();
		setValue("time_taken.value",diffSec);
		timeTakenDiv.hide();
	
		return true;
}
	return false;
});
		
</script>
</htmlform>